<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:120px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.9rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
    </div>

    <div class="legend">
      <span>üìò Reading (book pages)</span>
      <span>üß† Book exercises (specific numbers)</span>
      <span>üìó Proof-writing (USAMO/USAJMO)</span>
      <span>üß© Problem of the day (unique)</span>
      <span>‚è±Ô∏è Timed practice</span>
      <span>üìù Full mock</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(async function init(){
  const errBox = document.getElementById('errBox');
  window.addEventListener('error', (e)=>{
    errBox.style.display='block';
    errBox.textContent = 'Runtime error: ' + (e.message||'Unknown');
  });

  // ---------- Load planning payload ----------
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }

  // ---------- Dates ----------
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  document.getElementById('mPerDay').value = input.minutesPerDay || 60;
  document.getElementById('testDate').value = input.testDate || todayStr;

  const start = new Date(today);
  const end   = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  let spanDays = Math.ceil((end - start)/86400000);
  if(!(Number.isFinite(spanDays) && spanDays>0)) spanDays = 14;

  planSummary.innerHTML = `Start: <b>${start.toLocaleDateString()}</b> ‚Üí Test: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Window: <b>${spanDays}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b>.`;

  // ---------- Tracks & weights ----------
  const goal = (input.goal||'amc10').toLowerCase(); // 'amc10'|'amc12'|'aime'|'usamo'|'usajmo'
  const track = (goal==='amc10'||goal==='amc12') ? 'AMC' : (goal==='aime' ? 'AIME' : (goal==='usamo' ? 'USAMO' : 'USAJMO'));
  const difficultTrack = (track==='AIME' || track==='USAMO' || track==='USAJMO');

  const subs = input.subscores || {};
  const ALL_TOPICS = ['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Sequences and Series','Functions'];
  const topics = Object.keys(subs).length ? Object.keys(subs) : ALL_TOPICS.slice();
  const weights = {};
  topics.forEach(t=>{
    const r = (subs[t]?.right||0), n = (subs[t]?.total||1);
    weights[t] = 1 - r/n + 0.05; // worse score -> bigger weight
  });

  // Helper: weighted random topic (avoid immediate triple repeats)
  const recentTopics = [];
  function pickWeightedTopic(){
    const entries = Object.entries(weights).length ? Object.entries(weights) : topics.map(t=>[t,1]);
    for(let tries=0; tries<6; tries++){
      const sum = entries.reduce((a,[,w])=>a+w,0);
      let r = Math.random()*sum, choice = entries[0][0];
      for(const [k,w] of entries){ r-=w; if(r<=0){ choice=k; break; } }
      if(recentTopics.filter(x=>x===choice).length<2) { recentTopics.push(choice); if(recentTopics.length>4) recentTopics.shift(); return choice; }
    }
    return entries[0][0];
  }

  // ---------- Books (AoPS Vol 1 / Vol 2) ----------
  const V1=1, V2=2;
  function minutesPerPage(vol){ return (vol===V1)?2.0:(difficultTrack?3.0:2.6); }
  function minutesPerExercise(vol){ return (vol===V1)?6.0:(difficultTrack?9.0:8.0); }

  const READ_BANK = {
    "Polynomials and Algebra": [
      {id:'V1-A-6',  book:'AoPS Volume 1', vol:V1, chapter:'Chapter 6: Quadratic Equations', pStart:52, pEnd:60, ex:32},
      {id:'V2-A-6',  book:'AoPS Volume 2', vol:V2, chapter:'Chapter 6: Polynomials', pStart:52, pEnd:65, ex:34}
    ],
    "Number Theory": [
      {id:'V1-NT-5.4', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 5.4: Modular Arithmetic', pStart:42, pEnd:45, ex:30},
      {id:'V1-NT-5.6', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 5.6‚Äì5.7: Primes and Factors', pStart:47, pEnd:48, ex:18},
      {id:'V2-NT-23', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 23: Divisibility and Congruences', pStart:252, pEnd:262, ex:34},
      {id:'V2-NT-24', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 24: Diophantine Equations', pStart:266, pEnd:274, ex:26}
    ],
    "Geometry": [
      {id:'V1-G-11.8', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 11.8: Area of a Triangle', pStart:109, pEnd:109, ex:12},
      {id:'V1-G-14-15', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 14: Angle Chasing and Chapter 15: Area', pStart:133, pEnd:138, ex:36},
      {id:'V1-G-18', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 18: Three-Dimensional Geometry', pStart:165, pEnd:169, ex:20},
      {id:'V2-G-22', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 22: Geometry Tidbits ‚Äî Inversion and Homothety', pStart:241, pEnd:247, ex:16}
    ],
    "Combinatorics": [
      {id:'V1-C-25', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 25: Learning to Count', pStart:221, pEnd:229, ex:40},
      {id:'V2-C-15', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 15: Combinatorics and the Binomial Theorem', pStart:170, pEnd:176, ex:30},
      {id:'V2-C-25.6', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 25.6: Colorings', pStart:280, pEnd:280, ex:12}
    ],
    "Probability": [
      {id:'V1-P-25', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 25: Counting as a foundation for Probability', pStart:221, pEnd:229, ex:24},
      {id:'V2-P-15.5', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 15.5: Binomial Theorem for distributions', pStart:175, pEnd:175, ex:10}
    ],
    "Sequences and Series": [
      {id:'V1-S-24', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 24: Sequences and Series', pStart:211, pEnd:217, ex:28},
      {id:'V2-S-16', book:'AoPS Volume 2', vol:V2, chapter:'Chapter 16: Sequences and Recurrences', pStart:180, pEnd:191, ex:36}
    ],
    "Functions": [
      {id:'V1-F-21', book:'AoPS Volume 1', vol:V1, chapter:'Chapter 21: Functions', pStart:187, pEnd:190, ex:16},
      {id:'V2-F-7',  book:'AoPS Volume 2', vol:V2, chapter:'Chapter 7: Functional Equations', pStart:69,  pEnd:73,  ex:18}
    ]
  };

  // Prefer V1 for AMC, V2 for AIME/USAMO
  function filterUnitsByTrack(units){
    if(track==='AMC') return units.filter(u=>u.vol===V1).concat(units.filter(u=>u.vol===V2));
    return units.filter(u=>u.vol===V2).concat(units.filter(u=>u.vol===V1));
  }

  // Per-unit progress so lessons/exercises never repeat
  const progress = new Map(); // unit.id -> {nextPage, nextExercise, donePages, doneExercises}
  function getProg(u){
    if(!progress.has(u.id)){
      progress.set(u.id, {nextPage:u.pStart, nextExercise:1, donePages:false, doneExercises:false});
    }
    return progress.get(u.id);
  }

  // ---------- Proof-writing bank (USAMO/USAJMO only) ----------
  const selectedBooks = new Set(input.selectedBooks || []);
  const PROOF_BANK = {
    velleman: [
      {id:'Vell-2', book:'Velleman ‚Äî How to Prove It', section:'Chapter 2: Sentential Logic', pStart:45, pEnd:65, ex:20},
      {id:'Vell-3', book:'Velleman ‚Äî How to Prove It', section:'Chapter 3: Quantifiers', pStart:67, pEnd:92, ex:24},
      {id:'Vell-4', book:'Velleman ‚Äî How to Prove It', section:'Chapter 4: Proofs', pStart:95, pEnd:132, ex:30}
    ],
    zeitz: [
      {id:'Zeitz-2', book:'Zeitz ‚Äî The Art and Craft of Problem Solving', section:'Chapter 2: Strategies', pStart:25, pEnd:58, ex:30},
      {id:'Zeitz-3', book:'Zeitz ‚Äî Invariants, Extremal, Pigeonhole', section:'Chapter 3 (selected)', pStart:59, pEnd:96, ex:28}
    ],
    engel: [
      {id:'Engel-1', book:'Engel ‚Äî Problem-Solving Strategies', section:'Chapter 1: The Invariant Principle', pStart:1, pEnd:24, ex:20},
      {id:'Engel-2', book:'Engel ‚Äî The Extremal Principle', section:'Chapter 2', pStart:25, pEnd:48, ex:20}
    ],
    egmo: [
      {id:'EGMO-5', book:'EGMO', section:'Chapter 5: Power of a Point & Homothety', pStart:97, pEnd:128, ex:24},
      {id:'EGMO-7', book:'EGMO', section:'Chapter 7: Inversion (basics)', pStart:153, pEnd:180, ex:24}
    ]
  };
  const proofOrder = ['velleman','zeitz','engel','egmo'].filter(id=>selectedBooks.has(id));
  const proofProgress = new Map(); // unit.id -> {nextPage,nextExercise,donePages,doneExercises}
  function getProofProg(u){
    if(!proofProgress.has(u.id)){
      proofProgress.set(u.id,{nextPage:u.pStart,nextExercise:1,donePages:false,doneExercises:false});
    }
    return proofProgress.get(u.id);
  }
  function scheduleProofBlock(minutes){
    if(!(track==='USAMO'||track==='USAJMO') || !proofOrder.length || minutes<10) return [];
    const out=[]; let remaining=minutes;
    // always progress linearly through selected proof sources
    for(const src of proofOrder){
      const units = PROOF_BANK[src];
      for(const unit of units){
        if(remaining<10) break;
        const prog = getProofProg(unit);
        // pages
        if(!prog.donePages){
          const rate = 3.0; // proofs are dense
          const pagesLeft = Math.max(0, unit.pEnd - prog.nextPage + 1);
          if(pagesLeft>0){
            const pages = Math.max(2, Math.min(pagesLeft, Math.floor((remaining+0.3*rate)/rate)));
            const from = prog.nextPage, to = prog.nextPage + pages - 1;
            out.push({type:'proof', html:`üìó <b>Proof-writing</b>: ${unit.book}, ${unit.section} (pages ${from}‚Äì${to}) ‚Äî write summaries of key lemmas.`});
            prog.nextPage = to + 1;
            if(prog.nextPage > unit.pEnd) prog.donePages = true;
            remaining -= Math.round(pages*rate);
          }
        }
        // exercises
        if(remaining>=8 && !prog.doneExercises){
          const per = 15; // proofs take longer per exercise
          const left = Math.max(0, (unit.ex||20) - (prog.nextExercise-1));
          if(left>0){
            const cnt = Math.max(1, Math.min(left, Math.floor((remaining+0.25*per)/per)));
            const s = prog.nextExercise, e = s+cnt-1;
            out.push({type:'proof', html:`üìó <b>Proof exercises</b> (${unit.book}, ${unit.section}): ${s===e?`Exercise ${s}`:`Exercises ${s}‚Äì${e}`} ‚Äî write full solutions.`});
            prog.nextExercise = e+1;
            if(prog.nextExercise > (unit.ex||20)) prog.doneExercises = true;
            remaining -= Math.round(cnt*per);
          }
        }
      }
      if(remaining<10) break;
    }
    return out;
  }

  // ---------- Problem of the Day & Mocks ----------
  // URL builders
  function amcSet(year, level, variant){ return `https://artofproblemsolving.com/wiki/index.php/${year}_AMC_${level}${variant}_Problems`; }
  function aimeSet(year, variant){ return `https://artofproblemsolving.com/wiki/index.php/${year}_AIME_${variant}_Problems`; }
  function usamoSet(year){ return `https://artofproblemsolving.com/wiki/index.php/${year}_USAMO_Problems`; }
  function usajmoSet(year){ return `https://artofproblemsolving.com/wiki/index.php/${year}_USAJMO_Problems`; }

  function allAMCProblems(level){
    const out=[], years=[...Array(25)].map((_,i)=>2001+i), variants=['A','B'];
    years.forEach(y=>variants.forEach(v=>{ for(let n=1;n<=25;n++) out.push({url: amcSet(y,level,v)+`/Problem_${n}`, label:`${y} AMC ${level}${v} Problem ${n}`}); }));
    return out;
  }
  function allAIMEProblems(){
    const out=[], years=[...Array(43)].map((_,i)=>1983+i), variants=['I','II'];
    years.forEach(y=>variants.forEach(v=>{ for(let n=1;n<=15;n++) out.push({url: aimeSet(y,v)+`/Problem_${n}`, label:`${y} AIME ${v} Problem ${n}`}); }));
    return out;
  }

  const POD_POOL = (track==='AMC') ? (goal==='amc10'? allAMCProblems(10): allAMCProblems(12))
                    : (track==='AIME' ? allAIMEProblems() : allAIMEProblems()); // POD for USAMO/USAJMO still uses AIME-level problems
  const usedPOD = new Set();
  function pickPOD(){
    for(let tries=0; tries<5000; tries++){
      const i = Math.floor(Math.random()*POD_POOL.length);
      const k = POD_POOL[i].url;
      if(!usedPOD.has(k)){ usedPOD.add(k); return POD_POOL[i]; }
    }
    return POD_POOL[Math.floor(Math.random()*POD_POOL.length)];
  }

  // Strict level-specific mocks
  const usedMocks = new Set();
  function isMockDay(dateObj){
    const daysLeft = Math.ceil((end - dateObj)/86400000);
    if(daysLeft > 30 || daysLeft <= 3) return false;
    const dow = dateObj.getDay();
    if(track==='AMC'){
      // 2‚Äì3 per week
      if(daysLeft <= 10) return (dow===2 || dow===4 || dow===6);
      return (dow===2 || dow===6);
    }else if(track==='AIME'){
      // 3‚Äì4 per week
      if(daysLeft <= 10) return (dow===1 || dow===2 || dow===4 || dow===6);
      return (dow===1 || dow===4 || dow===6);
    }else{ // USAMO / USAJMO
      // 2‚Äì3 long proof mocks per week
      return (dow===2 || dow===6 || (daysLeft<=14 && dow===4));
    }
  }
  function makeMockForDate(){
    let html='';
    if(track==='AMC'){
      const lv = (goal==='amc10')?10:12;
      for(let tries=0; tries<2000; tries++){
        const y = 2006 + Math.floor(Math.random()*18);
        const v = Math.random()<0.5 ? 'A':'B';
        const url = amcSet(y, lv, v);
        if(!usedMocks.has(url)){ usedMocks.add(url); html = `üìù <a href="${url}" target="_blank" rel="noopener">Full mock: ${y} AMC ${lv}${v}</a>`; break; }
      }
    }else if(track==='AIME'){
      for(let tries=0; tries<2000; tries++){
        const y = 2004 + Math.floor(Math.random()*21);
        const v = Math.random()<0.5 ? 'I':'II';
        const url = aimeSet(y, v);
        if(!usedMocks.has(url)){ usedMocks.add(url); html = `üìù <a href="${url}" target="_blank" rel="noopener">Full mock: ${y} AIME ${v}</a>`; break; }
      }
    }else if(track==='USAMO'){
      for(let tries=0; tries<2000; tries++){
        const y = 2002 + Math.floor(Math.random()*22);
        const url = usamoSet(y);
        if(!usedMocks.has(url)){ usedMocks.add(url); html = `üìù <a href="${url}" target="_blank" rel="noopener">Full mock: ${y} USAMO (proof)</a>`; break; }
      }
    }else{ // USAJMO
      for(let tries=0; tries<2000; tries++){
        const y = 2010 + Math.floor(Math.random()*14);
        const url = usajmoSet(y);
        if(!usedMocks.has(url)){ usedMocks.add(url); html = `üìù <a href="${url}" target="_blank" rel="noopener">Full mock: ${y} USAJMO (proof)</a>`; break; }
      }
    }
    return {html, type:'mock'};
  }

  // ---------- Build a study day ----------
  function scheduleReadingAndExercises(targetMinutes){
    const phaseFrac = (targetMinutes<=30)?0.65:(targetMinutes<=60?0.58:0.52);
    let readBudget = Math.max(8, Math.round(targetMinutes*phaseFrac));
    let exBudget   = Math.max(0, targetMinutes - readBudget);

    const tasks=[]; const todayTopics=[];
    for(let blocks=0; blocks<2 && readBudget>=4; blocks++){
      const topic = pickWeightedTopic();
      const units = filterUnitsByTrack((READ_BANK[topic]||[])).filter(u=>{
        const p = getProg(u); return !p.donePages || !p.doneExercises;
      });
      if(!units.length) continue;
      const unit = units.find(u=>!getProg(u).donePages) || units[0];
      const p = getProg(unit);

      if(!p.donePages){
        const rate = minutesPerPage(unit.vol);
        const pagesLeft = Math.max(0, unit.pEnd - p.nextPage + 1);
        if(pagesLeft>0){
          const pages = Math.max(2, Math.min(pagesLeft, Math.floor((readBudget+0.2*rate)/rate)));
          const from = p.nextPage, to = p.nextPage + pages - 1;
          tasks.push({type:'reading', html:`üìò <b>${topic}</b>: ${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})`});
          p.nextPage = to + 1;
          if(p.nextPage > unit.pEnd) p.donePages = true;
          readBudget -= Math.round(pages*rate);
          todayTopics.push(topic);
        }
      }

      if(exBudget>=6 && !p.doneExercises){
        const per = minutesPerExercise(unit.vol);
        const remaining = Math.max(0, (unit.ex||30) - (p.nextExercise - 1));
        if(remaining>0){
          const count = Math.max(1, Math.min(remaining, Math.floor((exBudget + 0.25*per)/per)));
          const s = p.nextExercise, e = s + count - 1;
          tasks.push({type:'bookex', html:`üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): ${s===e?`Problem ${s}`:`Problems ${s}‚Äì${e}`}`});
          p.nextExercise = e + 1;
          if(p.nextExercise > (unit.ex||30)) p.doneExercises = true;
          exBudget -= Math.round(count*per);
        }
      }
    }
    return {tasks, topics: Array.from(new Set(todayTopics))};
  }

  function addProblemOfTheDay(tasks){
    const pod = pickPOD();
    tasks.push({type:'pod', html:`üß© <b>Problem of the day</b>: <a href="${pod.url}" target="_blank" rel="noopener">${pod.label}</a>`});
  }

  // ---------- Compose full plan ----------
  const minutesPerDay = Number(input.minutesPerDay||60);
  const days = spanDays;

  const tasksByDay = [];
  for(let i=0;i<days;i++){
    const dateObj = new Date(start.getTime()+i*86400000);

    // Final 3 days: guaranteed full mocks (level-specific)
    const daysLeftAll = Math.ceil((end - dateObj)/86400000);
    if(daysLeftAll <= 3){
      tasksByDay.push([ makeMockForDate() ]);
      continue;
    }

    // Weekly mocks in last 30 days (2‚Äì4 per week, level-specific)
    if(isMockDay(dateObj)){
      tasksByDay.push([ makeMockForDate() ]);
      continue;
    }

    // Regular study day
    const {tasks, topics: tt} = scheduleReadingAndExercises(minutesPerDay);

    // Proof-writing blocks for USAMO/USAJMO (based on selected books)
    if(track==='USAMO' || track==='USAJMO'){
      const share = 0.25; // ~25% of the day
      const proofBudget = Math.round(minutesPerDay * share);
      const proofTasks = scheduleProofBlock(proofBudget);
      proofTasks.forEach(t=>tasks.push(t));
    }

    // Always add Problem of the Day (unique)
    addProblemOfTheDay(tasks);

    // Optional short timed practice for variety
    if(Math.random()<0.35){
      const p1 = pickPOD(), p2 = (Math.random()<0.5)? pickPOD(): null;
      const list = [p1, p2].filter(Boolean).map(p=>`<a href="${p.url}" target="_blank" rel="noopener">${p.label.replace('Problem ','P')}</a>`).join(', ');
      tasks.push({type:'timed', html:`‚è±Ô∏è Timed practice: ${list}`});
    }

    tasksByDay.push(tasks);
  }

  // ---------- Calendar rendering (month pager) ----------
  const taskMap = new Map();
  for(let i=0;i<days;i++){
    const d = new Date(start.getTime()+i*86400000);
    const key = d.toISOString().slice(0,10);
    taskMap.set(key, tasksByDay[i]);
  }

  const months = buildMonthList(start, end);
  let monthIdx=0; renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick = ()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick = ()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};

  document.getElementById('downloadIcs').onclick = ()=>{
    const ics = buildICS(start, days, tasksByDay, minutesPerDay, track);
    const blob = new Blob([ics], {type:'text/calendar'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t; localStorage.setItem('studyPlanInput', JSON.stringify(input)); location.href = 'timeline.html?v=rebuild';
  };

  function buildMonthList(startDate, endDate){
    const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }
  function renderOneMonth({year, month}){
    const cal = document.getElementById('calendar'); cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
      head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const t0 = new Date(); t0.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=taskMap.get(key)||[];
      const inRange=(dateObj>=start && dateObj<=end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<t0) cls+=' past'; else if(dateObj.getTime()===t0.getTime()) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){ tasks.forEach(t=>{ html += `<div class="task">${t.html}</div>`; }); }
      box.innerHTML=html; grid.appendChild(box);
    }
    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${months.indexOf(months.find(m=>m.year===year&&m.month===month))+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  // ---------- ICS ----------
  function buildICS(startDate, spanDays, tasks, minutes, trackLabel){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>t.html.replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${trackLabel}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }
})();
</script>
</body>
</html>
