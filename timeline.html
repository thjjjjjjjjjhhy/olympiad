<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:110px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.9rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">Low time per day emphasizes Art of Problem Solving reading; final days dedicate to full mocks. Proof module is included for advanced tracks.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (Art of Problem Solving Volume 1 or Volume 2)</span>
      <span>üß† Book exercises (specific problem numbers)</span>
      <span>üìó Proof module (Velleman / Zeitz / EGMO / Engel ‚Äî with page numbers)</span>
      <span>üß© Topic-matched drills (exact AMC/AIME problems)</span>
      <span>‚è±Ô∏è Topic-matched timed set</span>
      <span>üìù Full mock and review</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(function(){
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }

  // ---------- Constants ----------
  const THRESH = {read:10, drill:10, timed:8};
  const QUOTA_SLACK = 2;
  const V1=1, V2=2;

  // ---------- Dates / toolbar ----------
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  const start = new Date(today);
  const end   = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  const days = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 14;

  const goalToTestName = {A:'AMC 10/12 (Test A)', B:'AIME bridge (Test B)', C:'US(A)JMO-leaning (Test C)'};
  planSummary.innerHTML = `Start date: <b>${start.toLocaleDateString()}</b> ‚Üí Test date: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Study window: <b>${days}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Track: <b>${goalToTestName[input.testId]||input.testId}</b> ‚Ä¢ Minutes per day: <b>${input.minutesPerDay}</b>.`;

  // ---------- Subscores ‚Üí weights ----------
  const subs = input.subscores||{};
  const cats = Object.keys(subs);
  if(!cats.length) cats.push('Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Sequences and Series','Functions','Probability');
  const weights={}; cats.forEach(k=>{const r=(subs[k]?.right||0), t=(subs[k]?.total||1); weights[k]=1 - r/t + 0.05});

  // ---------- Reading references (AoPS Vol.1/Vol.2) ----------
  const READS_VOL1 = {
    "Number Theory":[
      {id:"V1-NT-5.4", vol:V1, chapter:"Chapter 5.4: Modular Arithmetic", pStart:42, pEnd:45, exCount:30},
      {id:"V1-NT-5.6-5.7", vol:V1, chapter:"Chapter 5.6‚Äì5.7: Primes and Factors", pStart:47, pEnd:48, exCount:18},
    ],
    "Combinatorics":[
      {id:"V1-C-25", vol:V1, chapter:"Chapter 25: Learning to Count", pStart:221, pEnd:229, exCount:40},
    ],
    "Probability":[
      {id:"V1-P-25", vol:V1, chapter:"Chapter 25: Counting as a foundation for Probability", pStart:221, pEnd:229, exCount:24},
    ],
    "Sequences and Series":[
      {id:"V1-S-24", vol:V1, chapter:"Chapter 24: Sequences and Series", pStart:211, pEnd:217, exCount:28},
    ],
    "Functions":[
      {id:"V1-F-21", vol:V1, chapter:"Chapter 21: Functions", pStart:187, pEnd:190, exCount:16},
    ],
    "Polynomials and Algebra":[
      {id:"V1-A-6", vol:V1, chapter:"Chapter 6: Quadratic Equations", pStart:52, pEnd:60, exCount:32},
    ],
    "Geometry":[
      {id:"V1-G-11.8", vol:V1, chapter:"Chapter 11.8: Area of a Triangle", pStart:109, pEnd:109, exCount:12},
      {id:"V1-G-14-15", vol:V1, chapter:"Chapter 14: Angle Chasing and Chapter 15: Area", pStart:133, pEnd:138, exCount:36},
      {id:"V1-G-18", vol:V1, chapter:"Chapter 18: Three-Dimensional Geometry", pStart:165, pEnd:169, exCount:20},
    ],
  };
  const READS_VOL2 = {
    "Number Theory":[
      {id:"V2-NT-23", vol:V2, chapter:"Chapter 23: Divisibility and Congruences", pStart:252, pEnd:262, exCount:34},
      {id:"V2-NT-24", vol:V2, chapter:"Chapter 24: Diophantine Equations", pStart:266, pEnd:274, exCount:26},
    ],
    "Combinatorics":[
      {id:"V2-C-15", vol:V2, chapter:"Chapter 15: Combinatorics and the Binomial Theorem", pStart:170, pEnd:176, exCount:30},
      {id:"V2-C-25.6", vol:V2, chapter:"Chapter 25.6: Colorings", pStart:280, pEnd:280, exCount:12},
    ],
    "Probability":[
      {id:"V2-P-15.5", vol:V2, chapter:"Chapter 15.5: Binomial Theorem for distributions", pStart:175, pEnd:175, exCount:10},
    ],
    "Sequences and Series":[
      {id:"V2-S-16", vol:V2, chapter:"Chapter 16: Sequences and Recurrences", pStart:180, pEnd:191, exCount:36},
    ],
    "Functions":[
      {id:"V2-F-7", vol:V2, chapter:"Chapter 7: Functional Equations", pStart:69, pEnd:73, exCount:18},
    ],
    "Polynomials and Algebra":[
      {id:"V2-A-6", vol:V2, chapter:"Chapter 6: Polynomials", pStart:52, pEnd:65, exCount:34},
    ],
    "Geometry":[
      {id:"V2-G-22", vol:V2, chapter:"Chapter 22: Geometry Tidbits ‚Äî Inversion and Homothety", pStart:241, pEnd:247, exCount:16},
    ],
  };

  // ---------- Fine-grained subtopics for topic-matched drills ----------
  const SUBTOPIC_MAP = {
    "V1-NT-5.4": ["modular"],
    "V1-NT-5.6-5.7": ["primes-factors"],
    "V1-C-25": ["basic-counting"],
    "V1-P-25": ["basic-prob"],
    "V1-S-24": ["sequences"],
    "V1-F-21": ["functions"],
    "V1-A-6": ["quadratics"],
    "V1-G-11.8": ["triangle-area"],
    "V1-G-14-15": ["angle-area"],
    "V1-G-18": ["3d-geometry"],
    "V2-NT-23": ["modular-adv"],
    "V2-NT-24": ["diophantine"],
    "V2-C-15": ["binomial"],
    "V2-C-25.6": ["colorings"],
    "V2-P-15.5": ["prob-binomial"],
    "V2-S-16": ["recurrences"],
    "V2-F-7": ["functional-eq"],
    "V2-A-6": ["polynomials"],
    "V2-G-22": ["geo-advanced"]
  };

  // ---------- Curated topic‚Üíproblems bank (starter set) ----------
  const PROBLEM_BANK = {
    "quadratics": [
      {title:"2012 AMC 10A Problem 16", url:"https://artofproblemsolving.com/wiki/index.php/2012_AMC_10A_Problems/Problem_16", level:"AMC10", diff:2},
      {title:"2015 AMC 10B Problem 17", url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10B_Problems/Problem_17", level:"AMC10", diff:2},
      {title:"2018 AMC 12A Problem 13", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12A_Problems/Problem_13", level:"AMC12", diff:1},
      {title:"2006 AIME I Problem 2", url:"https://artofproblemsolving.com/wiki/index.php/2006_AIME_I_Problems/Problem_2", level:"AIME", diff:1},
      {title:"2011 AIME II Problem 3", url:"https://artofproblemsolving.com/wiki/index.php/2011_AIME_II_Problems/Problem_3", level:"AIME", diff:1}
    ],
    "modular": [
      {title:"2011 AMC 10A Problem 21", url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10A_Problems/Problem_21", level:"AMC10", diff:3},
      {title:"2014 AMC 12B Problem 12", url:"https://artofproblemsolving.com/wiki/index.php/2014_AMC_12B_Problems/Problem_12", level:"AMC12", diff:2},
      {title:"2015 AIME I Problem 1", url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_1", level:"AIME", diff:1},
      {title:"2010 AIME II Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2010_AIME_II_Problems/Problem_4", level:"AIME", diff:1}
    ],
    "primes-factors": [
      {title:"2013 AMC 10B Problem 22", url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10B_Problems/Problem_22", level:"AMC10", diff:3},
      {title:"2012 AMC 12A Problem 14", url:"https://artofproblemsolving.com/wiki/index.php/2012_AMC_12A_Problems/Problem_14", level:"AMC12", diff:2},
      {title:"2008 AIME I Problem 5", url:"https://artofproblemsolving.com/wiki/index.php/2008_AIME_I_Problems/Problem_5", level:"AIME", diff:1}
    ],
    "basic-counting": [
      {title:"2016 AMC 10A Problem 17", url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_17", level:"AMC10", diff:2},
      {title:"2012 AMC 12B Problem 12", url:"https://artofproblemsolving.com/wiki/index.php/2012_AMC_12B_Problems/Problem_12", level:"AMC12", diff:2},
      {title:"2007 AIME I Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2007_AIME_I_Problems/Problem_4", level:"AIME", diff:1}
    ],
    "basic-prob": [
      {title:"2010 AMC 10A Problem 18", url:"https://artofproblemsolving.com/wiki/index.php/2010_AMC_10A_Problems/Problem_18", level:"AMC10", diff:2},
      {title:"2017 AMC 12A Problem 9", url:"https://artofproblemsolving.com/wiki/index.php/2017_AMC_12A_Problems/Problem_9", level:"AMC12", diff:1},
      {title:"2011 AIME I Problem 2", url:"https://artofproblemsolving.com/wiki/index.php/2011_AIME_I_Problems/Problem_2", level:"AIME", diff:1}
    ],
    "sequences": [
      {title:"2013 AMC 10A Problem 19", url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10A_Problems/Problem_19", level:"AMC10", diff:2},
      {title:"2018 AMC 12B Problem 12", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12B_Problems/Problem_12", level:"AMC12", diff:2},
      {title:"2014 AIME I Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2014_AIME_I_Problems/Problem_4", level:"AIME", diff:1}
    ],
    "functions": [
      {title:"2016 AMC 10B Problem 18", url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10B_Problems/Problem_18", level:"AMC10", diff:2},
      {title:"2012 AMC 12A Problem 10", url:"https://artofproblemsolving.com/wiki/index.php/2012_AMC_12A_Problems/Problem_10", level:"AMC12", diff:1},
      {title:"2017 AIME II Problem 3", url:"https://artofproblemsolving.com/wiki/index.php/2017_AIME_II_Problems/Problem_3", level:"AIME", diff:1}
    ],
    "triangle-area": [
      {title:"2015 AMC 10A Problem 16", url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10A_Problems/Problem_16", level:"AMC10", diff:2},
      {title:"2010 AMC 12A Problem 10", url:"https://artofproblemsolving.com/wiki/index.php/2010_AMC_12A_Problems/Problem_10", level:"AMC12", diff:1},
      {title:"2013 AIME I Problem 5", url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_I_Problems/Problem_5", level:"AIME", diff:1}
    ],
    "angle-area": [
      {title:"2017 AMC 10B Problem 22", url:"https://artofproblemsolving.com/wiki/index.php/2017_AMC_10B_Problems/Problem_22", level:"AMC10", diff:3},
      {title:"2014 AMC 12A Problem 16", url:"https://artofproblemsolving.com/wiki/index.php/2014_AMC_12A_Problems/Problem_16", level:"AMC12", diff:2},
      {title:"2012 AIME II Problem 6", url:"https://artofproblemsolving.com/wiki/index.php/2012_AIME_II_Problems/Problem_6", level:"AIME", diff:2}
    ],
    "3d-geometry": [
      {title:"2011 AMC 10B Problem 21", url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10B_Problems/Problem_21", level:"AMC10", diff:3},
      {title:"2019 AMC 12A Problem 15", url:"https://artofproblemsolving.com/wiki/index.php/2019_AMC_12A_Problems/Problem_15", level:"AMC12", diff:2},
      {title:"2009 AIME I Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2009_AIME_I_Problems/Problem_7", level:"AIME", diff:2}
    ],
    "modular-adv": [
      {title:"2013 AIME II Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_II_Problems/Problem_4", level:"AIME", diff:1},
      {title:"2018 AIME I Problem 6", url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_I_Problems/Problem_6", level:"AIME", diff:2}
    ],
    "diophantine": [
      {title:"2012 AIME I Problem 5", url:"https://artofproblemsolving.com/wiki/index.php/2012_AIME_I_Problems/Problem_5", level:"AIME", diff:2},
      {title:"2016 AIME II Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_II_Problems/Problem_4", level:"AIME", diff:1}
    ],
    "binomial": [
      {title:"2011 AIME I Problem 6", url:"https://artofproblemsolving.com/wiki/index.php/2011_AIME_I_Problems/Problem_6", level:"AIME", diff:2},
      {title:"2018 AIME II Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_II_Problems/Problem_4", level:"AIME", diff:1}
    ],
    "colorings": [
      {title:"2014 AIME II Problem 5", url:"https://artofproblemsolving.com/wiki/index.php/2014_AIME_II_Problems/Problem_5", level:"AIME", diff:1}
    ],
    "prob-binomial": [
      {title:"2015 AIME II Problem 5", url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_II_Problems/Problem_5", level:"AIME", diff:2}
    ],
    "recurrences": [
      {title:"2012 AIME II Problem 4", url:"https://artofproblemsolving.com/wiki/index.php/2012_AIME_II_Problems/Problem_4", level:"AIME", diff:1},
      {title:"2017 AIME I Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2017_AIME_I_Problems/Problem_7", level:"AIME", diff:2}
    ],
    "functional-eq": [
      {title:"2011 AIME I Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2011_AIME_I_Problems/Problem_7", level:"AIME", diff:2},
      {title:"2018 AIME I Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_I_Problems/Problem_7", level:"AIME", diff:2}
    ],
    "polynomials": [
      {title:"2014 AIME I Problem 6", url:"https://artofproblemsolving.com/wiki/index.php/2014_AIME_I_Problems/Problem_6", level:"AIME", diff:2},
      {title:"2016 AIME I Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_I_Problems/Problem_7", level:"AIME", diff:2}
    ],
    "geo-advanced": [
      {title:"2013 AIME II Problem 7", url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_II_Problems/Problem_7", level:"AIME", diff:2}
    ]
  };

  // ---------- Proof module (with page numbers) ----------
  // NOTE: Page ranges can vary by edition/printing; these are typical placements.
  const PROOF_MODULE = [
    // Velleman ‚Äî How to Prove It (3rd ed. typical ranges)
    {src:"Velleman", label:"Direct and Contrapositive Proofs", pages:"pp. 45‚Äì65", work:"Write 2 full proofs (Exercises 1‚Äì6)"},
    {src:"Velleman", label:"Mathematical Induction (simple and strong)", pages:"pp. 139‚Äì160", work:"Write 2 full proofs (Exercises 1‚Äì6)"},
    // Zeitz ‚Äî The Art and Craft of Problem Solving (3rd ed. typical ranges)
    {src:"Zeitz", label:"Pigeonhole Principle and Extremal Principle", pages:"pp. 80‚Äì97", work:"Solve 3 problems (Problems 1‚Äì8)"},
    {src:"Zeitz", label:"Invariants and Monovariants", pages:"pp. 98‚Äì112", work:"Solve 3 problems (Problems 1‚Äì6)"},
    // EGMO ‚Äî Euclidean Geometry in Mathematical Olympiads (AMS)
    {src:"EGMO", label:"Power of a Point and Homothety", pages:"pp. 57‚Äì84", work:"Solve 2 geometry proofs (selected problems 1‚Äì6)"},
    {src:"EGMO", label:"Inversion (basics)", pages:"pp. 197‚Äì220", work:"Solve 2 geometry proofs (selected problems 1‚Äì4)"},
    // Engel ‚Äî Problem-Solving Strategies (Springer)
    {src:"Engel", label:"Combinatorial Arguments", pages:"pp. 1‚Äì24", work:"Solve 3 problems (Problems 1‚Äì10)"},
    {src:"Engel", label:"Functional Equations Tactics", pages:"pp. 315‚Äì334", work:"Write 2 full solutions (Problems 1‚Äì6)"}
  ];
  let proofIdx = 0;

  // ---------- Utility ----------
  function pickTopic(){
    const sum=Object.values(weights).reduce((a,b)=>a+b,0); let r=Math.random()*sum;
    for(const [k,w] of Object.entries(weights)){ r-=w; if(r<=0) return k; }
    return cats[0];
  }
  function minutesPerPage(vol, isUSAMO){ return (vol===V1)?2.0:(isUSAMO?3.2:2.7); }
  function minutesPerBookExercise(vol, phase){
    if(vol===V1) return (phase==='Final')?6.5:(phase==='Mixed')?6.0:5.5;
    return (phase==='Final')?9.0:(phase==='Mixed')?8.0:7.0;
  }

  // ---------- AoPS generic URL builders (fallback only) ----------
  function aimeProblemURL(y,v,n){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems/Problem_${n}`; }
  function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
  function amcProblemURL(level,y,v,n){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems/Problem_${n}`; }
  function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }
  const YEARS_AIME = Array.from({length:20},(_,i)=>2004+i), YEARS_AMC  = Array.from({length:18},(_,i)=>2006+i);
  const VARIANTS = ['A','B'], VAI = ['I','II']; const rnd = a=>a[Math.floor(Math.random()*a.length)];

  // ---------- Track / phase ----------
  const minutesPerDay = Number(input.minutesPerDay||60);
  const totalDays = days;
  const testId = input.testId; // 'A','B','C'
  const onAIMETrack = (testId!=='A');
  const isUSAMOTrack = (testId==='C');
  const amcLevel = (input.goal==='amc10')?'10':'12';

  function baseMixForPhase(ph){ return (ph==='Foundation')?{read:0.65,drill:0.25,timed:0.10}:(ph==='Mixed')?{read:0.50,drill:0.35,timed:0.15}:{read:0.35,drill:0.35,timed:0.30}; }
  function adjustedMix(base,m){
    let br=0, tt=0, td=0; if(m<=30){br=0.20;tt=0.15;td=0.05}else if(m<=60){br=0.10;tt=0.06;td=0.04}
    let r=base.read+br, d=Math.max(0,base.drill-td), t=Math.max(0,base.timed-tt); const s=r+d+t||1; return {read:r/s, drill:d/s, timed:t/s};
  }
  function phaseNameForDay(d){ const f=Math.floor(totalDays*0.55), m=Math.floor(totalDays*0.85); return d<f?'Foundation':(d<m?'Mixed':'Final'); }

  // ---------- Reading scheduler (AoPS) with book exercises ----------
  const exerciseCursor = {}; // ref.id -> next problem #

  function pickReadingObj(cat){
    const bank = onAIMETrack ? READS_VOL2 : READS_VOL1; const arr = bank[cat]||[]; return arr.length? arr[Math.floor(Math.random()*arr.length)]: null;
  }
  function formatReading(ref, from, to){ return `Volume ${ref.vol}, ${ref.chapter} (pages ${from}‚Äì${to})`; }

  function scheduleReading(phaseName, blockMinutes){
    const phaseBias = (phaseName==='Foundation') ? 0.65 : (phaseName==='Mixed' ? 0.55 : 0.45);
    let minutesForReading = Math.max(6, Math.round(blockMinutes * phaseBias));
    let minutesForExercises = Math.max(0, blockMinutes - minutesForReading);

    const tasks = [];
    let remainRead = minutesForReading, remainEx=minutesForExercises, chunks=0;

    while(remainRead >= 4 && chunks < 3){
      const cat = pickTopic();
      const ref = pickReadingObj(cat); if(!ref) break;
      const rate = minutesPerPage(ref.vol, isUSAMOTrack);
      const pagesTarget = Math.max(2, Math.min(ref.pEnd-ref.pStart+1, Math.floor((remainRead + 0.3*rate)/rate)));
      const from=ref.pStart, to=ref.pStart+pagesTarget-1, readMins=Math.round(pagesTarget*rate);
      const subkeys = SUBTOPIC_MAP[ref.id] || [];
      tasks.push({html:`üìò <b>${cat}</b>: ${formatReading(ref, from, to)}`, mins:readMins, type:'reading', _ref:ref, _sub:subkeys});
      remainRead -= readMins; chunks++;
      if(remainRead < Math.min(THRESH.read/2, rate)) break;
    }

    function addExercisesFor(ref, wantMins){
      if(!ref || wantMins < 4) return null;
      const per = minutesPerBookExercise(ref.vol, phaseName);
      const cnt = Math.max(1, Math.floor((wantMins + 0.25*per)/per));
      const key = ref.id; if(!(key in exerciseCursor)) exerciseCursor[key]=1;
      const start = exerciseCursor[key], end = Math.min(ref.exCount, start+cnt-1);
      exerciseCursor[key] = (end >= ref.exCount) ? 1 : (end+1);
      const used = Math.round((end-start+1)*per);
      const subkeys = SUBTOPIC_MAP[ref.id] || [];
      const rangeText = (start===end) ? `Problem ${start}` : `Problems ${start}‚Äì${end}`;
      return {html:`üß† <b>Book exercises</b> (Volume ${ref.vol}, ${ref.chapter}): ${rangeText}`, mins:used, type:'bookex', _ref:ref, _sub:subkeys, _start:start, _end:end, _per:per};
    }

    let exAdded=0;
    for(let i=tasks.length-1; i>=0 && remainEx>=4; i--){
      if(tasks[i].type==='reading'){
        const ex = addExercisesFor(tasks[i]._ref, Math.min(remainEx, Math.max(6, Math.round(blockMinutes*0.4))));
        if(ex){ tasks.push(ex); remainEx -= ex.mins; exAdded++; }
      }
    }
    while(remainEx>=4 && exAdded<3){
      const cat = pickTopic(); const ref = pickReadingObj(cat);
      const ex = addExercisesFor(ref, remainEx); if(!ex) break;
      tasks.push(ex); remainEx -= ex.mins; exAdded++;
    }

    if(!tasks.length && blockMinutes>=4){
      const cat = pickTopic(); const ref = pickReadingObj(cat);
      if(ref){
        const rate=minutesPerPage(ref.vol, isUSAMOTrack), pagesTarget=Math.max(1, Math.min(ref.pEnd-ref.pStart+1, Math.floor((blockMinutes+0.3*rate)/rate)));
        const from=ref.pStart, to=ref.pStart+pagesTarget-1, readMins=Math.round(pagesTarget*rate);
        const subkeys = SUBTOPIC_MAP[ref.id] || [];
        tasks.push({html:`üìò <b>${cat}</b>: ${formatReading(ref, from, to)}`, mins:readMins, type:'reading', _ref:ref, _sub:subkeys});
      }
    }
    return tasks;
  }

  // ---------- Proof module scheduler (shows page numbers) ----------
  function scheduleProofModule(phaseName, blockMinutes){
    if(blockMinutes < 6) return [];
    const picks = [];
    const slots = Math.max(1, Math.floor(blockMinutes / 20)); // ~1 task per ~20 min
    for(let i=0;i<slots;i++){
      const item = PROOF_MODULE[proofIdx % PROOF_MODULE.length]; proofIdx++;
      const html = `üìó <b>Proof module</b>: ${item.src} ‚Äî ${item.label} (${item.pages}). ${item.work}.`;
      picks.push({html, mins:20, type:'proof', _proof:item});
    }
    const used = picks.reduce((s,t)=>s+t.mins,0);
    const remain = blockMinutes - used;
    if(remain >= 10){
      const item = PROOF_MODULE[proofIdx % PROOF_MODULE.length]; proofIdx++;
      const html = `üìó <b>Proof module</b>: ${item.src} ‚Äî Short proof exercise (${item.pages}). ${item.work.replace(/\d+/, '1')}.`;
      picks.push({html, mins:remain, type:'proof', _proof:item});
    }
    return picks;
  }

  // ---------- Topic-aligned AMC/AIME problem picker ----------
  function filterBankBy(subtopics, wantLevel, phaseName, count){
    const phaseDiff = (phaseName==='Foundation')?1:(phaseName==='Mixed')?2:3;
    const pool=[];
    subtopics.forEach(sk=>{
      (PROBLEM_BANK[sk]||[]).forEach(p=>{
        if(wantLevel==='AIME'){
          if(p.level!=='AIME') return;
        } else if(wantLevel==='AMC10' || wantLevel==='AMC12'){
          if(p.level==='AIME') return;
          if(wantLevel==='AMC10' && p.level==='AMC12') return;
        }
        const score = 3 - Math.abs((p.diff||2) - phaseDiff);
        pool.push([score + Math.random()*0.3, p]);
      });
    });
    pool.sort((a,b)=>b[0]-a[0]);
    return pool.slice(0, count).map(x=>x[1]);
  }

  function makeTopicMatchedLinks(phaseName, blockMinutes, preferredSubtopics, timed=false){
    const per = (onAIMETrack ? ((phaseName==='Final')? (isUSAMOTrack?20:18) : (phaseName==='Mixed'?(isUSAMOTrack?18:16):(isUSAMOTrack?16:14))) :
                               ((phaseName==='Final')?12:(phaseName==='Mixed'?10:9)));
    const target = Math.max(1, Math.floor((blockMinutes + per*0.25)/ per));
    const levelPref = onAIMETrack ? 'AIME' : (amcLevel==='10' ? 'AMC10' : 'AMC12');

    let picked = filterBankBy(preferredSubtopics, levelPref, phaseName, target);

    if(picked.length < target){
      const need = target - picked.length;
      if(onAIMETrack){
        const y=rnd(YEARS_AIME), v=rnd(VAI);
        let [low,high] = (phaseName==='Foundation')?[1,7] : (phaseName==='Mixed')?[4,12]:[10,15];
        const set=new Set(); while(set.size<need) set.add(Math.floor(Math.random()*(high-low+1))+low);
        const add = [...set].sort((a,b)=>a-b).map(n=>({title:`${y} AIME ${v} Problem ${n}`, url: `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems/Problem_${n}`}));
        picked = picked.concat(add);
      } else {
        const y=rnd(YEARS_AMC), v=rnd(VARIANTS), L = (amcLevel==='10')?'AMC_10':'AMC_12';
        let [low,high] = (phaseName==='Foundation')?[8,18] : (phaseName==='Mixed')?[12,22]:[15,25];
        const set=new Set(); while(set.size<need) set.add(Math.floor(Math.random()*(high-low+1))+low);
        const add=[...set].sort((a,b)=>a-b).map(n=>({title:`${y} AMC ${amcLevel}${v} Problem ${n}`, url:`https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems/Problem_${n}`}));
        picked = picked.concat(add);
      }
    }

    const html = (timed? '‚è±Ô∏è Timed: ' : 'üß© ') + picked.map(p=>`<a href="${p.url}" target="_blank" rel="noopener">${p.title}</a>`).join(', ');
    return {html, mins:blockMinutes, type: timed?'timed':'drill'};
  }

  function makeMock(totalMinutes){
    if(onAIMETrack){ const y=rnd(YEARS_AIME), v=rnd(VAI); return {html:`<a href="${aimeSetURL(y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AIME ${v} (15 problems). Review and update your error log.</a>`, mins:totalMinutes, type:'mock'}; }
    const y=rnd(YEARS_AMC), v=rnd(VARIANTS); return {html:`<a href="${amcSetURL(amcLevel,y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AMC ${amcLevel}${v}. Review and update your error log.</a>`, mins:totalMinutes, type:'mock'};
  }

  // ---------- Build tasks by day ----------
  const tasksByDay=[];
  for(let d=0; d<totalDays; d++){
    const phase = phaseNameForDay(d);

    if(d >= totalDays-3){ tasksByDay.push([ makeMock(minutesPerDay) ]); continue; }

    // Mix for reading/drill/timed
    const mix = adjustedMix(baseMixForPhase(phase), minutesPerDay);
    let mRead=Math.round(minutesPerDay*mix.read), mDrill=Math.round(minutesPerDay*mix.drill), mTimed=Math.max(0, minutesPerDay - mRead - mDrill);

    // Guarantee a minimum reading block when minutes allow
    if(minutesPerDay >= THRESH.read && mRead < THRESH.read){
      let need = THRESH.read - mRead;
      const takeT = Math.min(need, mTimed); mTimed -= takeT; need -= takeT;
      const takeD = Math.min(need, mDrill); mDrill -= takeD; need -= need;
      mRead = Math.min(minutesPerDay, Math.max(mRead, THRESH.read));
      if(mRead + mDrill + mTimed > minutesPerDay){
        const diff = mRead + mDrill + mTimed - minutesPerDay;
        const t2 = Math.min(diff, mTimed); mTimed -= t2;
        const rem = diff - t2; if(rem>0) mDrill = Math.max(0, mDrill - rem);
      }
    }
    if(mRead<THRESH.read && mDrill<THRESH.drill && mTimed<THRESH.timed){ mRead = minutesPerDay; mDrill = 0; mTimed = 0; }

    const dayTasks=[];
    // For AIME/USAMO tracks, allocate a share of reading to the proof module
    const proofShare = isUSAMOTrack ? 0.28 : (onAIMETrack ? 0.12 : 0.0);
    const mProof = Math.round(mRead * proofShare);
    const mAoPS = Math.max(0, mRead - mProof);

    // AoPS reading + book exercises
    if(mAoPS > 0){
      const r = scheduleReading(phase, mAoPS);
      r.forEach(t=>dayTasks.push(t));
    }

    // Proof module (page numbers shown)
    if(mProof > 0){
      const p = scheduleProofModule(phase, mProof);
      p.forEach(t=>dayTasks.push(t));
    }

    // Topic-matched drills/timed sets prefer today's subtopics
    const todaysSubtopics = new Set();
    dayTasks.forEach(t=> (t._sub||[]).forEach(sk=>todaysSubtopics.add(sk)));
    const pref = [...todaysSubtopics];

    if(mDrill>=THRESH.drill){
      dayTasks.push( makeTopicMatchedLinks(phase, mDrill, pref, false) );
    }
    if(mTimed>=THRESH.timed){
      dayTasks.push( makeTopicMatchedLinks(phase, mTimed, pref, true) );
    }

    // Fallback if empty
    if(!dayTasks.length){
      const r = scheduleReading(phase, minutesPerDay);
      if(r.length){ r.forEach(t=>dayTasks.push(t)); }
      else { dayTasks.push(makeTopicMatchedLinks(phase, minutesPerDay, [], false)); }
    }

    // Balance to daily quota
    balanceToQuota(dayTasks, minutesPerDay, phase, pref);
    tasksByDay.push(dayTasks);
  }

  // ---------- Quota balancer ----------
  function totalMins(arr){ return Math.round(arr.reduce((s,t)=>s+(t.mins||0),0)); }

  function balanceToQuota(arr, target, phaseName, prefSubs){
    let cur = totalMins(arr);
    if(Math.abs(cur - target) <= QUOTA_SLACK) return;

    if(cur < target){
      const gap = target - cur;
      // top off with topic-matched practice using today's subtopics
      arr.push(makeTopicMatchedLinks(phaseName, gap, prefSubs, false));
      return;
    }

    let over = cur - target;

    // Trim drills/timed first
    function shrinkPractice(idx, delta){
      const t = arr[idx];
      if(!t || (t.type!=='drill' && t.type!=='timed')) return 0;
      const newBlock = Math.max(THRESH[t.type]||6, t.mins - delta);
      if(newBlock >= t.mins) return 0;
      const rebuilt = makeTopicMatchedLinks(phaseName, newBlock, prefSubs, t.type==='timed');
      t.html = rebuilt.html; const saved = t.mins - newBlock; t.mins = newBlock; return saved;
    }
    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){ over -= shrinkPractice(i, over) || 0; }
    if(over<=QUOTA_SLACK) return;

    // Then book exercises (update label without count)
    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){
      const t=arr[i];
      if(t && t.type==='bookex'){
        const per = t._per || 7, newBlock=Math.max(4, t.mins - over);
        if(newBlock < t.mins){
          const newCount = Math.max(1, Math.floor((newBlock + 0.25*per)/per));
          const newEnd = t._start + newCount - 1;
          const rangeText = (t._start===newEnd) ? `Problem ${t._start}` : `Problems ${t._start}‚Äì${newEnd}`;
          t.html = `üß† <b>Book exercises</b> (Volume ${t._ref.vol}, ${t._ref.chapter}): ${rangeText}`;
          over -= (t.mins - newBlock); t.mins=newBlock;
        }
      }
    }
    if(over<=QUOTA_SLACK) return;

    // Finally reading (AoPS or proof)
    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){
      const t=arr[i];
      if(t && (t.type==='reading' || t.type==='proof') && t.mins){
        const newBlock = Math.max(4, t.mins - over);
        if(newBlock < t.mins){
          over -= (t.mins - newBlock); t.mins=newBlock;
        }
      }
    }
  }

  // ---------- Date ‚Üí tasks map ----------
  const taskMap = new Map();
  for(let i=0;i<totalDays;i++){
    const d = new Date(start.getTime()+i*86400000);
    const key = d.toISOString().slice(0,10);
    taskMap.set(key, tasksByDay[i]);
  }

  // ---------- Month pager ----------
  const months = buildMonthList(start, end); let monthIdx=0; renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick = ()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick = ()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};

  // ---------- ICS / Rebuild ----------
  document.getElementById('downloadIcs').onclick = ()=>{
    const ics = buildICS(start, days, tasksByDay, Number(input.minutesPerDay), input);
    const blob = new Blob([ics], {type:'text/calendar'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t; localStorage.setItem('studyPlanInput', JSON.stringify(input)); location.href='timeline.html?v=18';
  };

  // ---------- Rendering helpers ----------
  function buildMonthList(startDate, endDate){
    const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }
  function renderOneMonth({year, month}){
    const cal = document.getElementById('calendar'); cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
      head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=taskMap.get(key)||[];
      const inRange=(dateObj>=start && dateObj<=end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(dateObj.getTime()===today.getTime()) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){ tasks.forEach(t=>{ html += `<div class="task">${t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`; }); }
      box.innerHTML=html; grid.appendChild(box);
    }
    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${monthIdx+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  function buildICS(startDate, spanDays, tasks, minutes, meta){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }
})();
</script>
</body>
</html>
