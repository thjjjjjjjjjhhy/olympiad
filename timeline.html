<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb;--bg:#f6f7fb}
    body{color:var(--fg);background:var(--bg)}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .calendar-wrap{background:#fff;border-radius:18px;box-shadow:0 1px 6px rgba(0,0,0,.06);padding:10px;margin-top:12px}
    .cal-head{display:flex;justify-content:space-between;align-items:center;margin:4px 4px 10px}
    .legend{font-size:.9rem;color:#475569;margin:6px 4px 0}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cell{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:120px;background:#fff}
    .dow{background:#f8fafc}
    .date{font-weight:700;font-size:.9rem;margin-bottom:2px;color:#334155}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.95rem;line-height:1.35;margin:4px 0}
    .task a{text-decoration:underline}
    .pill{background:#fff;border:1px solid var(--grid);border-radius:999px;padding:6px 10px}
    .nav{display:flex;gap:8px}
    a{color:#0369a1}
    @media print{
      .site-header,.toolbar,.nav,.legend,.actions{display:none!important}
      body{background:#fff}
      .calendar-wrap{box-shadow:none;border:1px solid var(--grid)}
      .cell{break-inside:avoid}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üìÜ Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <span class="pill" id="goalPill"></span>
      <span class="pill" id="minutesPill"></span>
      <span class="pill" id="daysLeftPill"></span>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-left:auto">
        <label class="pill">Minutes/day <input id="mPerDay" type="number" min="15" step="5" style="width:110px;margin-left:6px"></label>
        <label class="pill">Test date <input id="testDate" type="date" style="margin-left:6px"></label>
        <button id="rebuildBtn" class="secondary">Rebuild plan</button>
        <button id="downloadIcs">Download .ics</button>
        <button class="secondary" onclick="window.print()">Print</button>
      </div>
    </div>

    <div id="notices"></div>

    <div class="calendar-wrap">
      <div class="cal-head">
        <div>
          <h3 id="monthTitle" style="margin:0 0 2px">Month</h3>
          <div class="legend">Early: book learning & exercises ‚Ä¢ About a month out: ‚â§2 full mocks/week (Wed/Sat), each followed by a review day.</div>
        </div>
        <div class="nav">
          <button id="prevMonth" class="secondary">‚Üê Previous</button>
          <button id="nextMonth" class="secondary">Next ‚Üí</button>
        </div>
      </div>
      <div class="cal" id="grid"></div>
    </div>
  </main>

  <footer class="container" style="margin:14px 0 24px">¬© 2025 OlympiadPrep.</footer>

<script>
(function(){
  const errBox = document.getElementById('errBox');
  window.addEventListener('error', (e)=>{
    errBox.style.display='block';
    errBox.textContent = 'Runtime error: ' + (e.message||'Unknown');
  });

  /* ---------- Inputs ---------- */
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  if(!input){
    document.getElementById('planSummary').innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }
  const bookPrefs = JSON.parse(localStorage.getItem('bookPrefs')||'{}'); // legacy
  const selectedBooks = new Set(input.selectedBooks || Object.keys(bookPrefs).filter(k=>bookPrefs[k]));
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  document.getElementById('mPerDay').value = input.minutesPerDay || 60;
  document.getElementById('testDate').value = input.testDate || todayStr;

  const goal = (input.goal||'amc10').toLowerCase();
  const minutesPerDay = Number(input.minutesPerDay||60);
  const testDate = new Date((input.testDate||todayStr)+'T00:00:00');
  const daysLeft = Math.max(1, Math.ceil((testDate - today)/86400000));

  document.getElementById('goalPill').textContent = `Goal: ${goal.toUpperCase()}`;
  document.getElementById('minutesPill').textContent = `Daily time: ${minutesPerDay} minutes`;
  document.getElementById('daysLeftPill').textContent = `Days until test: ${daysLeft}`;
  document.getElementById('planSummary').innerHTML =
    `Start: <b>${today.toLocaleDateString()}</b> ‚Üí Test: <b>${testDate.toLocaleDateString()}</b> ‚Ä¢ Window: <b>${daysLeft}</b> days ‚Ä¢ Goal: <b>${goal.toUpperCase()}</b>.`;

  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0);
    const t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes/day (‚â•15) and choose a future test date.'); return; }
    input.minutesPerDay = m; input.testDate = t;
    localStorage.setItem('studyPlanInput', JSON.stringify(input));
    location.reload();
  };

  /* ---------- Book catalogs ---------- */
  const V1=1, V2=2;
  function minutesPerPage(vol){ return (vol===V1) ? 2.2 : (isUSAMOTrack?3.2:2.7); }
  function minutesPerExercise(vol){ return (vol===V1) ? 6.0 : (isUSAMOTrack?9.0:8.0); }

  const READS_VOL1 = {
    "Polynomials and Algebra":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 6: Quadratic Equations", pStart:52, pEnd:60, exCount:32},
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 21: Functions (basics)", pStart:187, pEnd:190, exCount:16}
    ],
    "Number Theory":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 5.4: Modular Arithmetic", pStart:42, pEnd:45, exCount:30},
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 5.6‚Äì5.7: Primes and Factors", pStart:47, pEnd:48, exCount:18}
    ],
    "Combinatorics":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 25: Learning to Count", pStart:221, pEnd:229, exCount:40}
    ],
    "Probability":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 25: Counting as a foundation for Probability", pStart:221, pEnd:229, exCount:24}
    ],
    "Sequences and Series":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 24: Sequences and Series", pStart:211, pEnd:217, exCount:28}
    ],
    "Functions":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 21: Functions", pStart:187, pEnd:190, exCount:16}
    ],
    "Geometry":[
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 11.8: Area of a Triangle", pStart:109, pEnd:109, exCount:12},
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Ch. 14: Angle Chasing & Ch. 15: Area", pStart:133, pEnd:138, exCount:36},
      {book:'Art of Problem Solving Volume 1', vol:V1, chapter:"Chapter 18: Three-Dimensional Geometry", pStart:165, pEnd:169, exCount:20}
    ]
  };

  const READS_VOL2 = {
    "Polynomials and Algebra":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 6: Polynomials", pStart:52, pEnd:65, exCount:34},
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Functional Equations (intro)", pStart:69, pEnd:73, exCount:18}
    ],
    "Number Theory":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 23: Divisibility and Congruences", pStart:252, pEnd:262, exCount:34},
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 24: Diophantine Equations", pStart:266, pEnd:274, exCount:26}
    ],
    "Combinatorics":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 15: Combinatorics & Binomial Theorem", pStart:170, pEnd:176, exCount:30},
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 25.6: Colorings", pStart:280, pEnd:280, exCount:12}
    ],
    "Probability":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Expected Value & Conditioning", pStart:148, pEnd:159, exCount:18}
    ],
    "Sequences and Series":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 16: Sequences & Recurrences", pStart:180, pEnd:191, exCount:36}
    ],
    "Geometry":[
      {book:'Art of Problem Solving Volume 2', vol:V2, chapter:"Chapter 22: Inversion & Homothety", pStart:241, pEnd:247, exCount:16}
    ]
  };

  const PROOF_MODULES = [
    {title:'Velleman ‚Äî Direct & Contrapositive Proofs', pages:[45,65]},
    {title:'Velleman ‚Äî Proof by Contradiction', pages:[85,98]},
    {title:'Velleman ‚Äî Induction', pages:[120,136]}
  ];

  /* ---------- Emphasis & selections ---------- */
  const onAIMETrack = (goal==='aime' || goal==='usamo' || goal==='usajmo');
  const isUSAMOTrack = (goal==='usamo' || goal==='usajmo');

  // Default book choices if none specified
  if(selectedBooks.size===0){
    if(goal==='amc10' || goal==='amc12') selectedBooks.add('aops-v1');
    else { selectedBooks.add('aops-v2'); selectedBooks.add('velleman'); }
  }

  function poolsForTopic(topic){
    let pool = [];
    if(selectedBooks.has('aops-v1')) pool = pool.concat(READS_VOL1[topic]||[]);
    if(selectedBooks.has('aops-v2')) pool = pool.concat(READS_VOL2[topic]||[]);
    return pool;
  }

  /* ---------- Topic weights from diagnostic ---------- */
  const subs = input.subscores || {};
  const allTopics = ["Polynomials and Algebra","Number Theory","Geometry","Combinatorics","Probability","Sequences and Series","Functions"];
  const topicsPresent = Object.keys(subs).length ? Object.keys(subs) : allTopics;
  const weights = {};
  topicsPresent.forEach(k=>{
    const r=(subs[k]?.right||0), t=(subs[k]?.total||1);
    weights[k] = 1 - r/t + 0.05; // weaker ‚Üí heavier
  });
  function pickTopicWeighted(){
    const keys = Object.keys(weights); const sum = keys.reduce((s,k)=>s+weights[k],0) || 1;
    let r = Math.random()*sum;
    for(const k of keys){ r -= weights[k]; if(r<=0) return k; }
    return keys[0];
  }

  /* ---------- Practice test pools (full sets) ---------- */
  const PRACTICE = {
    amc10: [
      { name:"2020 AMC 10A", url:"https://artofproblemsolving.com/wiki/index.php/2020_AMC_10A_Problems" },
      { name:"2020 AMC 10B", url:"https://artofproblemsolving.com/wiki/index.php/2020_AMC_10B_Problems" },
      { name:"2019 AMC 10A", url:"https://artofproblemsolving.com/wiki/index.php/2019_AMC_10A_Problems" },
      { name:"2019 AMC 10B", url:"https://artofproblemsolving.com/wiki/index.php/2019_AMC_10B_Problems" },
      { name:"2018 AMC 10A", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_10A_Problems" },
      { name:"2018 AMC 10B", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_10B_Problems" }
    ],
    amc12: [
      { name:"2020 AMC 12A", url:"https://artofproblemsolving.com/wiki/index.php/2020_AMC_12A_Problems" },
      { name:"2020 AMC 12B", url:"https://artofproblemsolving.com/wiki/index.php/2020_AMC_12B_Problems" },
      { name:"2019 AMC 12A", url:"https://artofproblemsolving.com/wiki/index.php/2019_AMC_12A_Problems" },
      { name:"2019 AMC 12B", url:"https://artofproblemsolving.com/wiki/index.php/2019_AMC_12B_Problems" },
      { name:"2018 AMC 12A", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12A_Problems" },
      { name:"2018 AMC 12B", url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12B_Problems" }
    ],
    aime: [
      { name:"AIME I 2020", url:"https://artofproblemsolving.com/wiki/index.php/2020_AIME_I_Problems" },
      { name:"AIME II 2020", url:"https://artofproblemsolving.com/wiki/index.php/2020_AIME_II_Problems" },
      { name:"AIME I 2019", url:"https://artofproblemsolving.com/wiki/index.php/2019_AIME_I_Problems" },
      { name:"AIME II 2019", url:"https://artofproblemsolving.com/wiki/index.php/2019_AIME_II_Problems" },
      { name:"AIME I 2018", url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_I_Problems" },
      { name:"AIME II 2018", url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_II_Problems" }
    ],
    usamo: [
      { name:"USA(J)MO 2020", url:"https://artofproblemsolving.com/wiki/index.php/USAJMO_Problems_and_Solutions#2020_USAJMO" },
      { name:"USA(J)MO 2019", url:"https://artofproblemsolving.com/wiki/index.php/USAJMO_Problems_and_Solutions#2019_USAJMO" },
      { name:"USA(J)MO 2018", url:"https://artofproblemsolving.com/wiki/index.php/USAJMO_Problems_and_Solutions#2018_USAJMO" }
    ]
  };

  /* ---------- Helpers ---------- */
  const fmt = (d)=>d.toISOString().slice(0,10);
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const diffDays = (a,b)=>Math.ceil((b-a)/86400000);
  const startOfWeekSunday = (d)=>{ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate()-x.getDay()); return fmt(x); };

  /* ---------- Day builders ---------- */
  function buildStudyDay(minutesTarget){
    // Choose topic by weakness
    const topic = pickTopicWeighted();
    // Pick a unit (favor Vol2 for AIME/USAMO, Vol1 for AMC via selectedBooks set)
    const pool = poolsForTopic(topic);
    if(pool.length===0){
      return [{ html:`üìò ${topic}: Read AoPS on this topic and solve a small set of exercises.`, mins:minutesTarget }];
    }
    const unit = pool[Math.floor(Math.random()*pool.length)];

    // Split into reading + exercises (+ optional proof for high levels)
    const baseReadShare = (goal==='amc10'||goal==='amc12') ? 0.55 : 0.45;
    let readBudget = Math.max(8, Math.round(minutesTarget * baseReadShare));
    let exBudget   = Math.max(6, minutesTarget - readBudget);

    // Proof module share for high goals (steals from exercises)
    const addProof = (isUSAMOTrack || goal==='aime') && selectedBooks.has('velleman');
    let proofBudget = 0;
    if(addProof){
      proofBudget = Math.min( Math.round(minutesTarget * (isUSAMOTrack?0.20:0.10)), exBudget-6 );
      if(proofBudget<0) proofBudget=0;
      exBudget -= proofBudget;
    }

    // Reading: choose pages to fit budget
    const rRate = minutesPerPage(unit.vol);
    const pAvail = unit.pEnd - unit.pStart + 1;
    let pages = Math.max(2, Math.min(pAvail, Math.floor((readBudget + 0.3*rRate)/rRate)));
    let from = unit.pStart, to = unit.pStart + pages - 1;
    let usedRead = Math.round(pages * rRate);

    // Exercises: choose count to fit exBudget
    const eRate = minutesPerExercise(unit.vol);
    let exCnt = Math.max(1, Math.min(unit.exCount, Math.floor((exBudget + 0.25*eRate)/eRate)));
    let usedEx = Math.round(exCnt * eRate);

    // Proof: take one module chunk if budgeted
    const items = [];
    items.push({ html:`üìò <b>${topic}</b>: ${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})`, mins:usedRead, type:'reading' });
    items.push({ html:`üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): ${exCnt===1 ? 'Problem 1' : 'Problems 1‚Äì'+exCnt}`, mins:usedEx, type:'bookex' });

    if(proofBudget>=12){
      const mod = PROOF_MODULES[Math.floor(Math.random()*PROOF_MODULES.length)];
      items.push({ html:`üìó <b>Proof module</b>: ${mod.title} (pages ${mod.pages[0]}‚Äì${mod.pages[1]}). Write at least one full proof.`, mins:proofBudget, type:'proof' });
    }

    // Balance to target (internal; UI hides minutes)
    function total(arr){ return Math.round(arr.reduce((s,t)=>s+(t.mins||0),0)); }
    let cur = total(items);
    const slack = 2;

    if(cur < minutesTarget - slack){
      // try adding more exercises if capacity
      const gap = minutesTarget - cur;
      const extra = Math.min(unit.exCount - exCnt, Math.max(1, Math.floor((gap + 0.25*eRate)/eRate)));
      if(extra>0){
        exCnt += extra; usedEx = Math.round(exCnt*eRate);
        items[1].mins = usedEx;
        items[1].html = `üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): Problems 1‚Äì${exCnt}`;
        cur = total(items);
      }
      // if still short, extend reading if pages remain
      if(cur < minutesTarget - slack){
        const morePages = Math.min(pAvail - pages, Math.max(0, Math.floor((minutesTarget-cur + 0.3*rRate)/rRate)));
        if(morePages>0){
          pages += morePages; to = unit.pStart + pages - 1; usedRead = Math.round(pages*rRate);
          items[0].mins = usedRead;
          items[0].html = `üìò <b>${topic}</b>: ${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})`;
          cur = total(items);
        }
      }
    } else if(cur > minutesTarget + slack){
      // trim exercises first
      let over = cur - minutesTarget;
      const canTrimEx = Math.max(0, exCnt - 1);
      if(canTrimEx>0){
        const trimCnt = Math.min(canTrimEx, Math.ceil(over / eRate));
        exCnt -= trimCnt; usedEx = Math.round(exCnt*eRate);
        items[1].mins = usedEx;
        items[1].html = exCnt<=1
          ? `üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): Problem 1`
          : `üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): Problems 1‚Äì${exCnt}`;
        cur = total(items);
        over = cur - minutesTarget;
      }
      // then trim reading pages if needed
      if(cur > minutesTarget + slack){
        const trimPages = Math.min(pages - 2, Math.ceil((cur - minutesTarget)/rRate));
        if(trimPages>0){
          pages -= trimPages; to = unit.pStart + pages - 1; usedRead = Math.round(pages*rRate);
          items[0].mins = usedRead;
          items[0].html = `üìò <b>${topic}</b>: ${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})`;
        }
      }
    }

    return items;
  }

  function buildTuneUpDay(minutesTarget, weakestTopic){
    const topic = weakestTopic || pickTopicWeighted();
    const pool = poolsForTopic(topic);
    if(pool.length===0) return [{ html:`üîß Tune-up: Review notes and rework recent misses in ${topic}.`, mins:minutesTarget }];
    const unit = pool[Math.floor(Math.random()*pool.length)];
    // lighter read
    const rRate = minutesPerPage(unit.vol), eRate = minutesPerExercise(unit.vol);
    const readBudget = Math.round(minutesTarget*0.6), exBudget = minutesTarget - readBudget;
    const pages = Math.max(2, Math.min(unit.pEnd-unit.pStart+1, Math.floor((readBudget + 0.3*rRate)/rRate)));
    const from = unit.pStart, to = unit.pStart + pages - 1;
    const exCnt = Math.max(1, Math.min(unit.exCount, Math.floor((exBudget + 0.25*eRate)/eRate)));
    return [
      { html:`üîß <b>Tune-up (${topic})</b>: ${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})`, mins:Math.round(pages*rRate) },
      { html:`üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}): ${exCnt===1?'Problem 1':'Problems 1‚Äì'+exCnt}`, mins:Math.round(exCnt*eRate) }
    ];
  }

  /* ---------- Build whole plan ---------- */
  function buildPlan(){
    const start = new Date(today);
    const end = new Date(testDate);
    const totalDays = Math.max(1, diffDays(start, end));

    // Practice tests start ‚â•30 days out if there‚Äôs enough runway; otherwise closer
    const wantStartAtLeast = 30;
    const practiceWindow = (totalDays >= wantStartAtLeast + 5)
      ? wantStartAtLeast
      : Math.max(7, Math.ceil(totalDays * 0.5)); // short runway pulls tests closer

    const practiceStart = addDays(end, -practiceWindow + 1);
    const practiceStartStr = fmt(practiceStart);

    // Weekly constraint: ‚â§2 tests/week on Wed/Sat (3,6). Short runway adds Tue/Fri backups.
    const preferredDOW = [3,6];                 // Wed, Sat
    const backupDOW   = [2,5,3,6];              // Tue, Fri, Wed, Sat
    const testsPerWeek = {};                    // week-key -> count
    const reservedReview = new Set();           // dates reserved for review (day after test)

    const pool = (goal==='amc10') ? PRACTICE.amc10
               : (goal==='amc12') ? PRACTICE.amc12
               : (goal==='aime')  ? PRACTICE.aime
               : PRACTICE.usamo;
    let poolIdx = 0;

    // Find weakest topic for tune-ups
    const ordered = Object.entries(weights).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
    const weakest = ordered[0] || "Polynomials and Algebra";

    const days = [];
    for(let cur=new Date(start); fmt(cur) <= fmt(end); cur=addDays(cur,1)){
      const dateStr = fmt(cur);
      const items = [];

      if(reservedReview.has(dateStr)){
        items.push({ html:`‚úÖ Review yesterday‚Äôs full mock: re-solve all missed/guessed problems. Write solutions and update your error log.`, mins:minutesPerDay });
        days.push({ date: dateStr, items });
        continue;
      }

      const inPractice = (dateStr >= practiceStartStr);
      if(inPractice){
        const weekKey = startOfWeekSunday(cur);
        const count = testsPerWeek[weekKey] || 0;
        const shortRunway = (diffDays(start, end) < 30);
        const allowed = shortRunway ? backupDOW : preferredDOW;

        if(count < 2 && allowed.includes(cur.getDay())){
          const test = pool[poolIdx % pool.length]; poolIdx++;
          items.push({ html:`üìù <a href="${test.url}" target="_blank" rel="noopener">Full practice test: ${test.name}</a>`, mins:Math.round(minutesPerDay*0.9) });
          items.push({ html:`üîé Simulate official conditions: strict timing, quiet room, no calculator (AMC), integer answers (AIME).`, mins:Math.round(minutesPerDay*0.1) });
          testsPerWeek[weekKey] = count + 1;

          // reserve next day for review
          const next = addDays(cur,1);
          if(fmt(next) <= fmt(end)) reservedReview.add(fmt(next));

          days.push({ date: dateStr, items });
          continue;
        }

        // Non-test day in practice window: light tune-up on weakest topic
        buildTuneUpDay(minutesPerDay, weakest).forEach(x=>items.push(x));
        days.push({ date: dateStr, items });
        continue;
      }

      // Early phase: pure study day (book reading + exercises, occasional proof)
      buildStudyDay(minutesPerDay).forEach(x=>items.push(x));
      days.push({ date: dateStr, items });
    }

    return days;
  }

  const PLAN_DAYS = buildPlan();

  /* ---------- Diagnostic nudges ---------- */
  (function addNotices(){
    const box = document.getElementById('notices');
    let html = '';
    const total = Object.values(input.subscores||{}).reduce((s,v)=>s+(v.total||0),0);
    const correct = Object.values(input.subscores||{}).reduce((s,v)=>s+(v.right||0),0);
    if(total){
      const pct = Math.round(100*correct/total);
      if((goal==='aime' || goal==='usamo' || goal==='usajmo') && pct < 40){
        html += `<div class="card" style="background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12">Your diagnostic score (${pct}%) suggests starting with an easier path. Consider taking the ${goal==='aime' ? 'AMC 12' : 'AIME'} diagnostic first.</div>`;
      } else if((goal==='amc10' || goal==='amc12') && pct > 85){
        html += `<div class="card" style="background:#eef6ff;border:1px solid #cfe3ff;color:#0b3b8a">Great job on the diagnostic (${pct}%)! You might also try the ${goal==='amc10' ? 'AMC 12' : 'AIME'} diagnostic to stretch yourself.</div>`;
      }
    }
    box.innerHTML = html;
  })();

  /* ---------- Calendar (month pager) ---------- */
  const grid = document.getElementById('grid');
  const monthTitle = document.getElementById('monthTitle');

  const startDate = new Date(today);
  const endDate = new Date(testDate);
  const months = buildMonthList(startDate, endDate);
  let monthIdx = 0;

  document.getElementById('prevMonth').onclick = ()=>{ monthIdx = Math.max(0, monthIdx-1); renderMonth(months[monthIdx]); };
  document.getElementById('nextMonth').onclick = ()=>{ monthIdx = Math.min(months.length-1, monthIdx+1); renderMonth(months[monthIdx]); };

  function buildMonthList(s,e){
    const out=[]; let cur=new Date(s.getFullYear(), s.getMonth(), 1); const last=new Date(e.getFullYear(), e.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur=new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }

  function renderMonth({year, month}){
    grid.innerHTML='';
    const header = new Date(year,month,1).toLocaleString(undefined,{month:'long',year:'numeric'});
    monthTitle.textContent = header;

    // DOW row
    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const c=document.createElement('div'); c.className='cell dow'; c.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(c);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='cell out-of-range'; grid.appendChild(e); }

    const keySet = new Map(PLAN_DAYS.map(d=>[d.date, d.items]));
    for(let d=1; d<=daysInMonth; d++){
      const dateObj=new Date(year,month,d); dateObj.setHours(0,0,0,0);
      const key = dateObj.toISOString().slice(0,10);
      const items = keySet.get(key) || [];
      const inRange = (dateObj>=today && dateObj<=testDate);

      const box=document.createElement('div');
      let cls='cell';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(key===todayStr) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${d}</div>`;
      if(inRange){
        if(items.length===0){
          html += `<div class="task" style="color:#94a3b8">‚Äî</div>`;
        } else {
          items.forEach(it=>{ html += `<div class="task">${it.html}</div>`; });
        }
      }
      box.innerHTML = html;
      grid.appendChild(box);
    }
  }

  renderMonth(months[monthIdx]);

  /* ---------- ICS export ---------- */
  document.getElementById('downloadIcs').onclick = ()=>{
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    const days = Math.max(1, Math.ceil((testDate - today)/86400000));
    for(let i=0;i<days;i++){
      const day=new Date(today.getTime()+i*86400000);
      const key=day.toISOString().slice(0,10);
      const items=(PLAN_DAYS.find(x=>x.date===key)||{}).items||[];
      if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0));
      const endUTC=new Date(startUTC.getTime()+minutesPerDay*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR');
    const blob = new Blob([lines.join('\\r\\n')], {type:'text/calendar'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
})();
</script>
</body>
</html>
