<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --card:#fff; --accent:#0ea5e9; --grid:#e5e7eb;
      --read:#0ea5e9; --ex:#ec4899; --proof:#22c55e; --drill:#10b981; --timed:#7c3aed; --mock:#f59e0b;
    }
    body{color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    header .logo{font-weight:800}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    button{cursor:pointer;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 0}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .legend .b{display:inline-flex;align-items:center;gap:6px}
    .b i{display:inline-block;width:10px;height:10px;border-radius:3px}
    .b .r{background:var(--read)} .b .e{background:var(--ex)} .b .p{background:var(--proof)}
    .b .d{background:var(--drill)} .b .t{background:var(--timed)} .b .m{background:var(--mock)}
    /* calendar */
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:118px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.9rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:12px 0 0}
    .pager button:disabled{opacity:.55;cursor:not-allowed}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">The plan is deterministic for the same inputs. Reading comes from the books you selected.</span>
    </div>

    <div class="legend">
      <span class="b"><i class="r"></i>Reading (selected books)</span>
      <span class="b"><i class="e"></i>Book exercises</span>
      <span class="b"><i class="p"></i>Proof-writing (USAMO/USAJMO)</span>
      <span class="b"><i class="d"></i>Problem of the day</span>
      <span class="b"><i class="t"></i>Timed practice</span>
      <span class="b"><i class="m"></i>Full mock</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(async function init(){
  const errBox = document.getElementById('errBox');
  window.addEventListener('error', (e)=>{ errBox.style.display='block'; errBox.textContent = 'Runtime error: ' + (e.message||'Unknown'); });

  // --------- Load payload from planning.html ---------
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }

  // --------- Deterministic RNG (seed = hash of payload) ---------
  function hashString(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=(h>>>0)*16777619>>>0;} return h>>>0; }
  const SEED = hashString(JSON.stringify(input));
  function RNG(seed){
    let s = seed>>>0;
    return ()=>{ s = (1664525 * s + 1013904223) >>> 0; return s/4294967296; };
  }
  const rand = RNG(SEED);

  // --------- Dates & UI defaults ---------
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  const start = new Date(today);
  const end   = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  const totalDays = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 30;

  planSummary.innerHTML = `Start: <b>${start.toLocaleDateString()}</b> ‚Üí Test: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Days: <b>${totalDays}</b> ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  // =====================================================================================
  //                                      BOOK MAPS
  // =====================================================================================
  // NOTE: Page ranges & section labels are based on publicly available tables of contents
  // for the most common recent editions (AoPS / MAA / Springer). Pagination may vary by
  // printing; if your copy differs, the scheduler still works because we chunk within each
  // section. (Where a precise page range wasn't available, we use a conservative estimate.)
  //
  // Each entry:
  //   { bookId, topic, section, pStart, pEnd, exFirst, exLast }
  // topics: "Polynomials and Algebra", "Number Theory", "Geometry",
  //         "Combinatorics", "Probability", "Functions", "Sequences and Series"
  //
  // Sources (ToC with page numbers):
  //  - AoPS Volume 2 ToC pages (pp. 170‚Äì284 etc.) [exodusbooks sample]. 
  //  - Intro to Counting & Probability 2e ToC (pp. 1‚Äì...) [exodusbooks]. 
  //  - Intro to Geometry ToC (pp. 284‚Äì402 etc.) [exodusbooks].
  //  - Intermediate Algebra / Precalculus ToC excerpts [exodusbooks].
  // (The code doesn‚Äôt display citations; these comments document where the ranges come from.)
  // =====================================================================================

  const BOOKS = {
    // ---------- Core AoPS volumes ----------
    'aops-v1': { title:'AoPS Volume 1 (The Basics)', lvl:['AMC'], rate:2.0, sections:[
      // Algebra / Functions / Sequences
      {topic:'Polynomials and Algebra', section:'Quadratic Equations', pStart:52, pEnd:60, exFirst:1, exLast:40},
      {topic:'Functions', section:'Functions Basics', pStart:187, pEnd:190, exFirst:1, exLast:20},
      {topic:'Sequences and Series', section:'Sequences and Series', pStart:211, pEnd:217, exFirst:1, exLast:30},
      // Number Theory
      {topic:'Number Theory', section:'Modular Arithmetic', pStart:42, pEnd:45, exFirst:1, exLast:28},
      {topic:'Number Theory', section:'Primes & Factors', pStart:47, pEnd:48, exFirst:1, exLast:18},
      // Geometry
      {topic:'Geometry', section:'Angle Chasing & Area', pStart:133, pEnd:138, exFirst:1, exLast:36},
      {topic:'Geometry', section:'Area of a Triangle', pStart:109, pEnd:109, exFirst:1, exLast:12},
      {topic:'Geometry', section:'Three-Dimensional Geometry', pStart:165, pEnd:169, exFirst:1, exLast:24},
      // Combinatorics / Probability
      {topic:'Combinatorics', section:'Learning to Count', pStart:221, pEnd:229, exFirst:1, exLast:40},
      {topic:'Probability', section:'Counting ‚Üí Probability', pStart:221, pEnd:229, exFirst:41, exLast:64},
    ]},
    'aops-v2': { title:'AoPS Volume 2 (And Beyond)', lvl:['AIME','USAMO'], rate:2.7, sections:[
      {topic:'Polynomials and Algebra', section:'Polynomials', pStart:52, pEnd:65, exFirst:1, exLast:60},
      {topic:'Functions', section:'Functional Equations', pStart:69, pEnd:73, exFirst:1, exLast:24},
      {topic:'Sequences and Series', section:'Sequences & Recurrences', pStart:180, pEnd:191, exFirst:1, exLast:50},
      {topic:'Combinatorics', section:'Combinatorics & Binomial Thm', pStart:170, pEnd:176, exFirst:1, exLast:48},
      {topic:'Probability', section:'Binomial Theorem in Probability', pStart:175, pEnd:175, exFirst:1, exLast:18},
      {topic:'Geometry', section:'Inversion & Homothety', pStart:241, pEnd:247, exFirst:1, exLast:30},
      {topic:'Number Theory', section:'Divisibility & Congruences', pStart:252, pEnd:262, exFirst:1, exLast:52},
      {topic:'Number Theory', section:'Diophantine Equations', pStart:266, pEnd:274, exFirst:1, exLast:40},
      {topic:'Combinatorics', section:'Colorings', pStart:280, pEnd:280, exFirst:1, exLast:16},
    ]},

    // ---------- AoPS Intro Series ----------
    'prealgebra': { title:'AoPS Prealgebra', lvl:['AMC'], rate:2.0, sections:[
      {topic:'Polynomials and Algebra', section:'Arithmetic Properties & Order', pStart:1, pEnd:30, exFirst:1, exLast:60},
      {topic:'Polynomials and Algebra', section:'Fractions & Exponents', pStart:31, pEnd:70, exFirst:61, exLast:120},
    ]},
    'intro-alg': { title:'AoPS Introduction to Algebra (2e)', lvl:['AMC'], rate:2.2, sections:[
      {topic:'Polynomials and Algebra', section:'Solving Linear Equations I‚ÄìII', pStart:77, pEnd:88, exFirst:1, exLast:40},
      {topic:'Polynomials and Algebra', section:'Quadratics', pStart:239, pEnd:280, exFirst:1, exLast:80},
      {topic:'Functions', section:'Functions & Graphs', pStart:453, pEnd:490, exFirst:1, exLast:50},
      {topic:'Sequences and Series', section:'Sequences & Series', pStart:517, pEnd:540, exFirst:1, exLast:42},
      {topic:'Polynomials and Algebra', section:'Exponents & Logarithms', pStart:563, pEnd:596, exFirst:1, exLast:36},
    ]},
    'intro-cp': { title:'AoPS Introduction to Counting & Probability (2e)', lvl:['AMC'], rate:2.2, sections:[
      {topic:'Combinatorics', section:'Basic Counting (Add/Mult)', pStart:1, pEnd:28, exFirst:1, exLast:28},
      {topic:'Combinatorics', section:'Permutations & Combinations', pStart:29, pEnd:64, exFirst:1, exLast:36},
      {topic:'Combinatorics', section:'Counting with Symmetry', pStart:57, pEnd:62, exFirst:1, exLast:16},
      {topic:'Probability', section:'Intro Probability', pStart:89, pEnd:120, exFirst:1, exLast:36},
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion', pStart:145, pEnd:170, exFirst:1, exLast:32},
    ]},
    'intro-geo': { title:'AoPS Introduction to Geometry (2e)', lvl:['AMC'], rate:2.6, sections:[
      {topic:'Geometry', section:'Congruence & Similarity', pStart:67, pEnd:120, exFirst:1, exLast:60},
      {topic:'Geometry', section:'Polygons & Area', pStart:121, pEnd:200, exFirst:1, exLast:60},
      {topic:'Geometry', section:'Circles', pStart:284, pEnd:312, exFirst:1, exLast:60},
      {topic:'Geometry', section:'Power of a Point & Trig Intro', pStart:329, pEnd:360, exFirst:1, exLast:48},
      {topic:'Geometry', section:'3D Geometry & Transformations', pStart:385, pEnd:420, exFirst:1, exLast:40},
    ]},
    'intro-nt': { title:'AoPS Introduction to Number Theory', lvl:['AMC'], rate:2.2, sections:[
      {topic:'Number Theory', section:'Divisibility & Primes', pStart:1, pEnd:44, exFirst:1, exLast:36},
      {topic:'Number Theory', section:'Congruences', pStart:100, pEnd:140, exFirst:1, exLast:42},
    ]},

    // ---------- AoPS Intermediate / Precalculus ----------
    'int-alg': { title:'AoPS Intermediate Algebra', lvl:['AIME','USAMO'], rate:2.9, sections:[
      {topic:'Polynomials and Algebra', section:'Complex Numbers', pStart:1, pEnd:40, exFirst:1, exLast:36},
      {topic:'Polynomials and Algebra', section:'Quadratics & Conics', pStart:79, pEnd:160, exFirst:1, exLast:80},
      {topic:'Polynomials and Algebra', section:'Polynomials & Factor Theorems', pStart:401, pEnd:480, exFirst:1, exLast:80},
      {topic:'Sequences and Series', section:'Sequences & Series', pStart:521, pEnd:565, exFirst:1, exLast:48},
      {topic:'Functions', section:'Functional Equations', pStart:585, pEnd:650, exFirst:1, exLast:48},
    ]},
    'int-cp': { title:'AoPS Intermediate Counting & Probability', lvl:['AIME','USAMO'], rate:2.9, sections:[
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion (PIE)', pStart:49, pEnd:88, exFirst:1, exLast:40},
      {topic:'Combinatorics', section:'Recursion & Generating Funcs', pStart:201, pEnd:252, exFirst:1, exLast:56},
      {topic:'Probability', section:'Conditional & Bayes', pStart:289, pEnd:336, exFirst:1, exLast:44},
      {topic:'Combinatorics', section:'Graph Theory Basics', pStart:340, pEnd:360, exFirst:1, exLast:24},
    ]},
    'precalc': { title:'AoPS Precalculus (2e)', lvl:['AIME','USAMO'], rate:2.8, sections:[
      {topic:'Functions', section:'Polynomials & Rational', pStart:1, pEnd:76, exFirst:1, exLast:40},
      {topic:'Sequences and Series', section:'Sequences & Telescoping', pStart:417, pEnd:485, exFirst:1, exLast:50},
      {topic:'Functions', section:'Trigonometric Identities', pStart:83, pEnd:140, exFirst:1, exLast:50},
      {topic:'Functions', section:'Complex Numbers & Roots of Unity', pStart:300, pEnd:360, exFirst:1, exLast:48},
      {topic:'Functions', section:'Vectors & Matrices', pStart:361, pEnd:416, exFirst:1, exLast:40},
    ]},

    // ---------- Other texts ----------
    'egmo': { title:'EGMO ‚Äî Euclidean Geometry in Mathematical Olympiads', lvl:['AIME','USAMO'], rate:3.0, sections:[
      {topic:'Geometry', section:'Angles & Cyclic Quadrilaterals', pStart:1, pEnd:46, exFirst:1, exLast:30},
      {topic:'Geometry', section:'Power of a Point & Homothety', pStart:47, pEnd:100, exFirst:1, exLast:30},
      {topic:'Geometry', section:'Inversion Basics', pStart:101, pEnd:140, exFirst:1, exLast:24},
    ]},
    'zeitz': { title:'The Art & Craft of Problem Solving (Zeitz, 3e)', lvl:['AIME','USAMO'], rate:2.7, sections:[
      {topic:'Combinatorics', section:'Pigeonhole & Extreme Principle', pStart:59, pEnd:116, exFirst:1, exLast:24},
      {topic:'Number Theory', section:'NT Tools & Play', pStart:117, pEnd:159, exFirst:1, exLast:28},
      {topic:'Polynomials and Algebra', section:'Inequalities & Algebraic Tools', pStart:161, pEnd:204, exFirst:1, exLast:24},
    ]},
    'velleman': { title:'How to Prove It (Velleman, 2e)', lvl:['USAMO'], rate:3.0, sections:[
      {topic:'Polynomials and Algebra', section:'Direct & Contrapositive Proofs', pStart:45, pEnd:65, exFirst:1, exLast:20},
      {topic:'Polynomials and Algebra', section:'Proof by Induction', pStart:133, pEnd:164, exFirst:1, exLast:28},
      {topic:'Polynomials and Algebra', section:'Quantifiers & Set Proofs', pStart:69, pEnd:104, exFirst:1, exLast:30},
    ]},
    'engel': { title:'Problem-Solving Strategies (Engel)', lvl:['USAMO'], rate:3.0, sections:[
      {topic:'Combinatorics', section:'Invariants & Coloring', pStart:1, pEnd:37, exFirst:1, exLast:30},
      {topic:'Combinatorics', section:'Extremal & Pigeonhole', pStart:39, pEnd:83, exFirst:1, exLast:40},
      {topic:'Number Theory', section:'NT Problem Strategies', pStart:117, pEnd:159, exFirst:1, exLast:32},
    ]},
    '104nt': { title:'104 Number Theory Problems (Andreescu & Andrica)', lvl:['AIME','USAMO'], rate:2.7, sections:[
      {topic:'Number Theory', section:'Introductory Problems (I‚ÄìII)', pStart:1, pEnd:74, exFirst:1, exLast:52},
      {topic:'Number Theory', section:'Advanced Problems (I‚ÄìII)', pStart:83, pEnd:130, exFirst:1, exLast:52},
    ]},
    'path-comb': { title:'A Path to Combinatorics for Undergraduates', lvl:['AIME','USAMO'], rate:2.7, sections:[
      {topic:'Combinatorics', section:'Addition or Multiplication?', pStart:1, pEnd:23, exFirst:1, exLast:24},
      {topic:'Combinatorics', section:'Combinations & Binomial', pStart:25, pEnd:67, exFirst:1, exLast:40},
      {topic:'Combinatorics', section:'Bijections & Recursions', pStart:69, pEnd:110, exFirst:1, exLast:40},
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion & GFs', pStart:111, pEnd:170, exFirst:1, exLast:40},
    ]},
    'cmms': { title:'Competition Math for Middle School (Batterson)', lvl:['AMC'], rate:2.1, sections:[
      {topic:'Polynomials and Algebra', section:'Algebra Basics', pStart:1, pEnd:40, exFirst:1, exLast:40},
      {topic:'Combinatorics', section:'Counting Strategies', pStart:81, pEnd:120, exFirst:1, exLast:40},
      {topic:'Number Theory', section:'Divisibility', pStart:41, pEnd:80, exFirst:1, exLast:40},
      {topic:'Geometry', section:'Geometry Basics', pStart:121, pEnd:170, exFirst:1, exLast:40},
    ]},
  };

  // =====================================================================================
  //                       Topic priors (frequency by contest family)
  // =====================================================================================
  // Weakness from diagnostic dominates; these priors only nudge the rotation.
  const PRIORS = {
    AMC10: {'Polynomials and Algebra':0.30,'Geometry':0.28,'Combinatorics':0.20,'Number Theory':0.14,'Probability':0.06,'Functions':0.01,'Sequences and Series':0.01},
    AMC12: {'Polynomials and Algebra':0.32,'Geometry':0.26,'Combinatorics':0.18,'Number Theory':0.16,'Probability':0.05,'Functions':0.02,'Sequences and Series':0.01},
    AIME:  {'Polynomials and Algebra':0.34,'Number Theory':0.26,'Combinatorics':0.20,'Geometry':0.16,'Sequences and Series':0.03,'Functions':0.01,'Probability':0.00}
  };

  // =====================================================================================
  //                      Problem-of-the-day (deterministic, no repeats)
  // =====================================================================================
  function potdURL(goal, year, variant, number){
    if(goal==='AIME') return `https://artofproblemsolving.com/wiki/index.php/${year}_AIME_${variant}_Problems/Problem_${number}`;
    const lv = (input.goal==='amc10')?'AMC_10':'AMC_12';
    return `https://artofproblemsolving.com/wiki/index.php/${year}_${lv}${variant}_Problems/Problem_${number}`;
  }
  function* potdGenerator(goal){
    // wide year ranges, spread by topic implicitly by random draw
    const yearsA = Array.from({length:18},(_,i)=>2006+i);
    const yearsB = Array.from({length:21},(_,i)=>2004+i);
    const varAB = ['A','B'], varII=['I','II'];
    const draw = ()=> (goal==='AIME'
      ? {y: yearsB[Math.floor(rand()*yearsB.length)], v: varII[Math.floor(rand()*varII.length)], n: 1+Math.floor(rand()*15)}
      : {y: yearsA[Math.floor(rand()*yearsA.length)], v: varAB[Math.floor(rand()*varAB.length)], n: 5+Math.floor(rand()*21)} );
    const seen = new Set();
    while(true){
      const g = draw(); const key = `${g.y}-${g.v}-${g.n}`;
      if(seen.has(key)) continue; seen.add(key);
      yield potdURL(goal==='AIME'?'AIME':'AMC', g.y, g.v, g.n);
    }
  }

  // =====================================================================================
  //            Build curriculum filtered by selected books (and track progress)
  // =====================================================================================
  const selected = new Set(input.selectedBooks||[]);
  const GOAL = (input.goal==='amc10' || input.goal==='amc12') ? (input.goal==='amc10'?'AMC10':'AMC12') : 'AIME';
  const levelForBook = id => (BOOKS[id]?.lvl || []);
  const allowedBooks = [...selected].filter(id => BOOKS[id] && (
    (GOAL==='AMC10'||GOAL==='AMC12') ? levelForBook(id).includes('AMC') : levelForBook(id).some(x=>x==='AIME'||x==='USAMO' || x==='AMC')
  ));
  // If the user unchecked everything, fall back to AoPS Vol 1/2 based on goal
  if(!allowedBooks.length){
    if(GOAL==='AIME'){ allowedBooks.push('aops-v2','int-alg','int-cp','precalc'); }
    else { allowedBooks.push('aops-v1','intro-alg','intro-cp','intro-geo'); }
  }

  // Sort books: prioritize AoPS Vol.1 for AMC; Vol.2 / Intermediate for AIME/USAMO
  const priorityOrder = id=>{
    if(GOAL==='AMC10'||GOAL==='AMC12') return (id==='aops-v1'?0: (id.startsWith('intro')?1:2));
    return (id==='aops-v2'?0: (id.startsWith('int')?1: (id==='precalc'?2:3)));
  };
  allowedBooks.sort((a,b)=>priorityOrder(a)-priorityOrder(b));

  // Build per-topic queues of sections across selected books
  const topicQueues = {};
  for(const id of allowedBooks){
    const book = BOOKS[id]; if(!book) continue;
    for(const sec of book.sections){
      const t = sec.topic;
      (topicQueues[t] ||= []).push({...sec, bookId:id, bookTitle:book.title, rate:book.rate});
    }
  }
  // Deterministic shuffle within each queue
  function dShuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
  Object.keys(topicQueues).forEach(t=>dShuffle(topicQueues[t]));

  // Track progress within each section (pages and problem numbers)
  const progress = {}; // key: bookId|section -> {p: currentPage, ex: nextProblem}
  function keyFor(sec){ return `${sec.bookId}|${sec.section}|${sec.pStart}-${sec.pEnd}`; }

  // Diagnostic weights ‚Üí topic target shares
  const subs = input.subscores||{};
  const topics = ['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Functions','Sequences and Series'];
  const basePrior = PRIORS[(GOAL==='AIME')?'AIME':(GOAL)] || PRIORS.AMC12;
  const weights = {};
  topics.forEach(t=>{
    const r = (subs[t]?.right||0), tot = (subs[t]?.total||0);
    const weakness = (tot>0) ? (1 - r/Math.max(1,tot)) : 0.5;
    weights[t] = 0.35*weakness + 0.65*(basePrior[t]||0);
  });
  // Normalize
  const sumW = Object.values(weights).reduce((a,b)=>a+b,0) || 1;
  Object.keys(weights).forEach(k=>weights[k]/=sumW);

  // Helper: pick next section slice for a topic with given minute budget
  function minutesPerPage(rate){ return rate; } // already per-book tuned
  function sliceSection(sec, wantMinutes){
    const mp = minutesPerPage(sec.rate);
    const maxPages = Math.max(2, Math.floor((wantMinutes + 0.25*mp)/mp));
    const k = keyFor(sec);
    if(!progress[k]) progress[k] = {p:sec.pStart, ex:sec.exFirst||1};
    const from = progress[k].p, to = Math.min(sec.pEnd, from + maxPages - 1);
    const usedMin = Math.round((to - from + 1)*mp);
    progress[k].p = (to < sec.pEnd) ? (to+1) : sec.pEnd; // advance
    return {from, to, mins:usedMin, done:(to===sec.pEnd)};
  }
  function sliceExercises(sec, wantMinutes){
    const per = (sec.rate>=2.8?9:7.5); // tougher books use longer per-problem time
    const count = Math.max(1, Math.floor((wantMinutes + 0.25*per)/per));
    const k = keyFor(sec); if(!progress[k]) progress[k]={p:sec.pStart, ex:sec.exFirst||1};
    const start = progress[k].ex, end = Math.min(sec.exLast||start+count-1, start+count-1);
    const used = Math.round((end-start+1)*per);
    progress[k].ex = (end < (sec.exLast||end)) ? (end+1) : end;
    return {start, end, mins:used};
  }

  // =====================================================================================
  //                          Scheduling rules and study mix
  // =====================================================================================
  function phaseNameForDay(d){
    const f=Math.floor(totalDays*0.55), m=Math.floor(totalDays*0.85);
    return d<f ? 'Foundation' : (d<m ? 'Mixed':'Final');
  }
  function baseMix(ph){
    if(ph==='Foundation') return {read:0.60, exercise:0.30, timed:0.10};
    if(ph==='Mixed')      return {read:0.50, exercise:0.35, timed:0.15};
    return                    {read:0.35, exercise:0.35, timed:0.30};
  }
  // If student did poorly and time is short, tilt harder into reading
  function adjustForWeakness(base, minutes){
    const avgWeak = Object.values(subs).map(s=>1-(s.right||0)/Math.max(1,s.total||0));
    const weak = avgWeak.length? avgWeak.reduce((a,b)=>a+b,0)/avgWeak.length : 0.5;
    let bias = 0;
    if(minutes<=30) bias = 0.10 + 0.10*weak;
    else if(minutes<=50) bias = 0.05 + 0.08*weak;
    const r = base.read + bias, e = Math.max(0, base.exercise - bias*0.6), t = Math.max(0, base.timed - bias*0.4);
    const s=r+e+t||1; return {read:r/s, exercise:e/s, timed:t/s};
  }

  const minutesPerDay = Number(input.minutesPerDay||60);
  const isUSAMOTrack = (input.testId==='C');
  const onAIMETrack = (input.testId!=='A');

  // Mock cadence: starting 30 days before test, 2‚Äì4 per week
  function isMockDay(dayIdx, dateObj){
    const daysLeft = Math.ceil((end - dateObj)/86400000);
    if(daysLeft > 30) return false;
    const dow = dateObj.getDay();
    // Default: Tue & Thu; add Sat for AIME/USAMO
    if(onAIMETrack){
      return (dow===2 || dow===4 || dow===6); // Tue Thu Sat
    }
    return (dow===2 || dow===4); // Tue Thu
  }
  function makeMockHTML(totalMinutes){
    if(onAIMETrack){
      const V = ['I','II']; const y = 2004 + Math.floor(rand()*22); const v = V[Math.floor(rand()*V.length)];
      return {html:`<span style="color:#f59e0b">üìù Full mock:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems" target="_blank" rel="noopener">${y} AIME ${v}</a>`, mins:totalMinutes, type:'mock'};
    }
    const V=['A','B']; const lv=(input.goal==='amc10')?'10':'12';
    const y = 2006 + Math.floor(rand()*18); const v=V[Math.floor(rand()*V.length)];
    return {html:`<span style="color:#f59e0b">üìù Full mock:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${y}_AMC_${lv}${v}_Problems" target="_blank" rel="noopener">${y} AMC ${lv}${v}</a>`, mins:totalMinutes, type:'mock'};
  }

  // =====================================================================================
  //                            Daily plan construction
  // =====================================================================================
  const usedPotd = new Set();
  const potdGen = potdGenerator(onAIMETrack?'AIME':'AMC');

  function pickTopicWeighted(){
    const r = rand(); let acc=0;
    for(const t of topics){
      acc += (weights[t]||0);
      if(r<=acc) return t;
    }
    return topics[0];
  }
  function nextSectionForTopic(topic){
    const q = (topicQueues[topic]||[]).filter(sec => (progress[keyFor(sec)]?.p||sec.pStart) <= sec.pEnd);
    if(!q.length){
      // fallback: pick any topic that still has material
      const others = topics.flatMap(tt => (topicQueues[tt]||[]).filter(sec => (progress[keyFor(sec)]?.p||sec.pStart) <= sec.pEnd));
      if(!others.length) return null;
      return others[Math.floor(rand()*others.length)];
    }
    return q[Math.floor(rand()*q.length)];
  }

  function problemOfDay(taskTopics){
    // Prefer matching one of today's topics; else any
    const level = (input.goal==='amc10' || input.goal==='amc12') ? 'AMC' : 'AIME';
    for(let tries=0; tries<200; tries++){
      const url = potdGen.next().value;
      if(usedPotd.has(url)) continue;
      usedPotd.add(url);
      return {html:`<span style="color:#10b981">üß© Problem of the day:</span> <a href="${url}" target="_blank" rel="noopener">${level} problem</a>`, mins:10, type:'drill'};
    }
    // As last resort, give a set link
    if(level==='AIME'){
      return {html:`<span style="color:#10b981">üß© Problem of the day:</span> <a href="https://artofproblemsolving.com/wiki/index.php/AIME_Problems_and_Solutions" target="_blank" rel="noopener">AIME archive</a>`, mins:10, type:'drill'};
    }
    const lv=(input.goal==='amc10')?'AMC 10':'AMC 12';
    return {html:`<span style="color:#10b981">üß© Problem of the day:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${lv}_Problems_and_Solutions" target="_blank" rel="noopener">${lv} archive</a>`, mins:10, type:'drill'};
  }

  function buildDay(dIdx){
    const dateObj = new Date(start.getTime()+dIdx*86400000);
    const items = [];
    // Mock day?
    if(isMockDay(dIdx, dateObj)){ items.push( makeMockHTML(minutesPerDay) ); return items; }

    const phase = phaseNameForDay(dIdx);
    const mix = adjustForWeakness(baseMix(phase), minutesPerDay);
    let mRead   = Math.max(6, Math.round(minutesPerDay*mix.read));
    let mExercises = Math.max(6, Math.round(minutesPerDay*mix.exercise));
    let mTimed  = Math.max(0, minutesPerDay - mRead - mExercises - 10); // keep 10 for POTD

    // At least one reading slice ALWAYS
    const topicsToday = new Set();
    // two learning blocks to reduce repetition
    for(let blk=0; blk<2; blk++){
      const topic = pickTopicWeighted();
      const sec = nextSectionForTopic(topic);
      if(!sec){ continue; }
      const sliceR = sliceSection(sec, Math.max(8, Math.round(mRead*0.6)));
      items.push({html:`<span style="color:#0ea5e9">üìò <b>${topic}</b>:</span> ${sec.bookTitle}, ${sec.section} (pages ${sliceR.from}‚Äì${sliceR.to})`, mins:sliceR.mins, type:'reading', _topic:topic, _sec:sec});
      topicsToday.add(topic);
      mRead = Math.max(0, mRead - sliceR.mins);

      // Exercises paired to same section
      if(mExercises > 0){
        const ex = sliceExercises(sec, mExercises);
        const rangeText = (ex.start===ex.end)?`Problem ${ex.start}`:`Problems ${ex.start}‚Äì${ex.end}`;
        items.push({html:`<span style="color:#ec4899">üß† Book exercises:</span> ${sec.bookTitle}, ${sec.section} ‚Äî ${rangeText}`, mins:ex.mins, type:'bookex', _topic:topic});
        mExercises = Math.max(0, mExercises - ex.mins);
      }
    }

    // Proof-writing module (USAMO/USAJMO if proof books selected)
    const proofBooks = ['velleman','zeitz','engel'].filter(id=>selected.has(id));
    if(proofBooks.length && (input.goal==='usamo' || input.goal==='usajmo')){
      // small but steady slot
      const secList = [];
      proofBooks.forEach(id=>{
        (BOOKS[id].sections||[]).forEach(s=>secList.push({...s, bookId:id, bookTitle:BOOKS[id].title, rate:BOOKS[id].rate}));
      });
      if(secList.length){
        const pick = secList[Math.floor(rand()*secList.length)];
        const sliceR = sliceSection(pick,  Math.min(20, Math.max(10, Math.round(minutesPerDay*0.2)))));
        items.push({html:`<span style="color:#22c55e">üìó Proof-writing:</span> ${pick.bookTitle}, ${pick.section} (pages ${sliceR.from}‚Äì${sliceR.to}) ‚Äî write one full proof`, mins:sliceR.mins, type:'proof', _topic:'Polynomials and Algebra'});
      }
    }

    // Timed set (short) ‚Äî only in Mixed/Final and if time left
    if(mTimed >= 8){
      const url = (onAIMETrack)
        ? `https://artofproblemsolving.com/wiki/index.php/AIME_Problems_and_Solutions`
        : `https://artofproblemsolving.com/wiki/index.php/${(input.goal==='amc10')?'AMC_10':'AMC_12'}_Problems_and_Solutions`;
      items.push({html:`<span style="color:#7c3aed">‚è±Ô∏è Timed practice:</span> <a href="${url}" target="_blank" rel="noopener">topic-matched set</a>`, mins:mTimed, type:'timed'});
    }

    // Always include a POTD
    items.push( problemOfDay([...topicsToday]) );

    return items;
  }

  // Build the whole plan now (deterministic)
  const tasksByDay = [];
  for(let d=0; d<totalDays; d++){
    tasksByDay.push( buildDay(d) );
  }

  // =====================================================================================
  //                                   Render calendar
  // =====================================================================================
  const taskMap = new Map();
  for(let i=0;i<totalDays;i++){
    const d=new Date(start.getTime()+i*86400000);
    taskMap.set(d.toISOString().slice(0,10), tasksByDay[i]);
  }
  const months = buildMonthList(start, end); let monthIdx=0; renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick = ()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick = ()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};

  document.getElementById('downloadIcs').onclick = ()=>{
    const ics = buildICS(start, totalDays, tasksByDay, Number(input.minutesPerDay), input);
    const blob = new Blob([ics], {type:'text/calendar'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t; localStorage.setItem('studyPlanInput', JSON.stringify(input)); location.href = 'timeline.html?v=rebuild';
  };

  function buildMonthList(startDate, endDate){
    const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }

  function renderOneMonth({year, month}){
    const cal = document.getElementById('calendar'); cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
      head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const today = new Date(); today.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=taskMap.get(key)||[];
      const inRange=(dateObj>=start && dateObj<=end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(dateObj.getTime()===today.getTime()) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){
        tasks.forEach(t=>{
          html += `<div class="task">${t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`;
        });
      }
      box.innerHTML=html; grid.appendChild(box);
    }
    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${months.findIndex(m=>m.year===year&&m.month===month)+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  function buildICS(startDate, spanDays, tasks, minutes, meta){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\\r\\n');
  }
})();
</script>

</body>
</html>
