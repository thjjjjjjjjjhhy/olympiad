<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg);background:#f8fafc}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input, select{border:1px solid var(--grid);border-radius:10px;padding:8px 10px;background:#fff}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px;background:#fff}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:120px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.92rem;margin:4px 0;line-height:1.38}
    .task a{text-decoration:underline}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#eef2f7;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    .offday-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .offday-pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--grid);background:#fff;border-radius:999px;padding:6px 10px}
    .notice{border-left:4px solid var(--accent);background:#f0f9ff;padding:10px;border-radius:8px;margin:8px 0}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <div class="offday-group">
        <b>Weekly off-days:</b>
        <label class="offday-pill"><input type="checkbox" value="1"> Mon</label>
        <label class="offday-pill"><input type="checkbox" value="2"> Tue</label>
        <label class="offday-pill"><input type="checkbox" value="3"> Wed</label>
        <label class="offday-pill"><input type="checkbox" value="4"> Thu</label>
        <label class="offday-pill"><input type="checkbox" value="5"> Fri</label>
        <label class="offday-pill"><input type="checkbox" value="6"> Sat</label>
        <label class="offday-pill"><input type="checkbox" value="0"> Sun</label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">We prioritize your selected books and weak topics. Final month emphasizes full mocks.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (from your selected books)</span>
      <span>üß† Book exercises (specific problem ranges)</span>
      <span>üìó Proof module (if selected)</span>
      <span>üß© Problem of the day (last 20 years)</span>
      <span>üìù Full mock and review</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>

    <div id="advice" class="notice" style="display:none"></div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
/* ============================================================================
   UTILITIES
============================================================================ */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
function cyrb53(str, seed=0){let h1=0xdeadbeef^seed,h2=0x41c6ce57^seed;for(let i=0;i<str.length;i++){const ch=str.charCodeAt(i);h1=Math.imul(h1^ch,2654435761);h2=Math.imul(h2^ch,1597334677);}h1=Math.imul(h1^(h1>>>16),2246822507)^Math.imul(h2^(h2>>>13),3266489909);h2=Math.imul(h2^(h2>>>16),2246822507)^Math.imul(h1^(h1>>>13),3266489909);return 4294967296*(2097151&(h2>>>0))+(h1>>>0);}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function fmtDate(d){return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});}
function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function daysBetween(a,b){return Math.ceil((b-a)/86400000);}

/* ============================================================================
   INPUT
============================================================================ */
const errBox=document.getElementById('errBox');
window.addEventListener('error', (e)=>{errBox.style.display='block';errBox.textContent='Runtime error: '+(e.message||'Unknown');});

const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
const planSummary=document.getElementById('planSummary');

if(!input){
  planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
} else {
  const seedStr = JSON.stringify({g:input.goal,t:input.testDate,m:input.minutesPerDay,b:input.selectedBooks||[],s:input.subscores||{}});
  const seed = cyrb53(seedStr);
  Math.random = mulberry32(seed);
}

/* ============================================================================
   POTD (20-year window; controlled difficulty; no repeats)
============================================================================ */
(function(){
  function last20Years(latest){const start=latest-19,out=[];for(let y=start;y<=latest;y++) out.push(y); return out;}
  function amcURL(level,year,varn,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_AMC_${level}${varn}_Problems/Problem_${num}`;}
  function aimeURL(year,varn,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_AIME_${varn}_Problems/Problem_${num}`;}
  function usamoURL(year,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_USAMO_Problems/Problem_${num}`;}
  function usajmoURL(year,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_USAJMO_Problems/Problem_${num}`;}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  function build(goal, latest){
    const yrs=last20Years(latest), out=[];
    if(goal==='amc10'||goal==='amc12'){
      const lvl=(goal==='amc10'?'10':'12'), V=['A','B'];
      for(const y of yrs){for(const v of V){for(let n=1;n<=20;n++){out.push({label:`${y} AMC ${lvl}${v} ‚Äî Problem ${n}`,url:amcURL(lvl,y,v,n),key:`AMC${lvl}-${y}-${v}-${n}`});}}}
    } else if(goal==='aime'){
      const V=['I','II']; for(const y of yrs){for(const v of V){for(let n=1;n<=13;n++){out.push({label:`${y} AIME ${v} ‚Äî Problem ${n}`,url:aimeURL(y,v,n),key:`AIME-${y}-${v}-${n}`});}}}
    } else { // usamo/usajmo
      for(const y of yrs){for(let n=1;n<=6;n++){ if(input.goal==='usamo') out.push({label:`${y} USAMO ‚Äî Problem ${n}`,url:usamoURL(y,n),key:`USAMO-${y}-${n}`}); else out.push({label:`${y} USAJMO ‚Äî Problem ${n}`,url:usajmoURL(y,n),key:`USAJMO-${y}-${n}`});}}
    }
    return shuffle(out);
  }

  const POTD = { _q:[], _used:new Set(),
    init(goal){ this._q = build(goal, new Date().getFullYear()); this._used.clear(); },
    next(){ while(this._q.length){const c=this._q.pop(); if(this._used.has(c.key)) continue; this._used.add(c.key); return c;} return null;}
  };
  window.__POTD = POTD;
})();

/* ============================================================================
   BOOK CONTENT: granular banks for ALL books (pages + exercise ranges)
   NOTE: Page numbers/ranges are edition-based approximations for planning.
         You can refine per your copy; the scheduler will consume them sequentially.
============================================================================ */
const BOOKS_META = { rates:{ V1:2.0, V2:2.7, INTRO:2.1, INT:2.6, PRECALC:2.5, OTHER:2.4, EGMO:2.8, PROOF:2.8 } };

// Helper to generate repeated slices
function slices(pStart, pEnd, step){
  const out=[]; let s=pStart;
  while(s<=pEnd){ const e=Math.min(pEnd, s+step-1); out.push([s,e]); s=e+1; }
  return out;
}
// Build many granular units quickly
function buildUnits(bookTitle, kind, chapter, titlePrefix, pageStart, pageEnd, stepPages, exStart, exEnd, exPerSlice){
  const segs = slices(pageStart, pageEnd, stepPages);
  return segs.map((pg, i)=>({
    chapter, title:`${titlePrefix} ${i+1}`, pStart:pg[0], pEnd:pg[1],
    exStart: exStart ? (exStart + i*exPerSlice) : undefined,
    exEnd:   exEnd   ? Math.min(exEnd, (exStart + i*exPerSlice + exPerSlice -1)) : undefined,
    exCount: exPerSlice
  }));
}

const BOOK_BANK = {
  // ============================ AoPS Volume 1 ============================
  'aops-v1': {
    id:'aops-v1', title:'AoPS Volume 1 (The Basics)', kind:'V1',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('AoPS V1','V1','Chapter 6: Quadratic Equations','Quadratics',52,60,3,60,91,6),
        ...buildUnits('AoPS V1','V1','Chapter 7: Exponents & Radicals','Exponents/Radicals',61,76,4,92,116,6),
        ...buildUnits('AoPS V1','V1','Chapter 8: Inequalities','Inequalities',77,96,4,117,138,6)
      ],
      'Number Theory':[
        ...buildUnits('AoPS V1','V1','Chapter 5.4: Modular Arithmetic','Mod arithmetic',42,48,3,140,154,6),
        ...buildUnits('AoPS V1','V1','Chapter 5.6‚Äì5.7: Primes/Factors','Primes & factors',47,56,3,155,176,6)
      ],
      'Geometry':[
        ...buildUnits('AoPS V1','V1','Chapter 14‚Äì15: Angles & Area','Angle chase & area',133,145,3,178,206,6),
        ...buildUnits('AoPS V1','V1','Chapter 18: 3D Geometry','3D geometry',165,176,3,207,220,6)
      ],
      'Combinatorics':[
        ...buildUnits('AoPS V1','V1','Chapter 25: Learning to Count','Counting basics',221,236,4,226,260,6)
      ],
      'Probability':[
        ...buildUnits('AoPS V1','V1','Chapter 25: Probability via Counting','Probability',221,236,4,226,260,6)
      ],
      'Functions':[
        ...buildUnits('AoPS V1','V1','Chapter 21: Functions','Functions',187,198,3,198,210,6)
      ],
      'Sequences and Series':[
        ...buildUnits('AoPS V1','V1','Chapter 24: Sequences & Series','Sequences & series',211,222,3,222,240,6)
      ]
    }
  },

  // ============================ AoPS Volume 2 ============================
  'aops-v2': {
    id:'aops-v2', title:'AoPS Volume 2 (And Beyond)', kind:'V2',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('AoPS V2','V2','Chapter 6: Polynomials','Polynomials I',52,65,3,66,100,6)
      ],
      'Number Theory':[
        ...buildUnits('AoPS V2','V2','Chapter 23: Divisibility & Congruences','Divisibility & congruences',252,262,3,262,290,6),
        ...buildUnits('AoPS V2','V2','Chapter 24: Diophantine Equations','Diophantine equations',266,274,3,274,300,6)
      ],
      'Geometry':[
        ...buildUnits('AoPS V2','V2','Chapter 22: Inversion & Homothety','Inversion & homothety',241,247,3,247,260,6)
      ],
      'Combinatorics':[
        ...buildUnits('AoPS V2','V2','Chapter 15: Combinatorics & Binomial','Binomial & combinatorics',170,178,3,178,210,6),
        ...buildUnits('AoPS V2','V2','Chapter 25.6: Colorings','Colorings/Burnside',280,282,1,282,290,4)
      ],
      'Probability':[
        ...buildUnits('AoPS V2','V2','Chapter 15.5: Binomial Distributions','Distributions',175,176,1,176,186,5)
      ],
      'Functions':[
        ...buildUnits('AoPS V2','V2','Chapter 7: Functional Equations','Functional equations',69,75,3,75,90,6)
      ],
      'Sequences and Series':[
        ...buildUnits('AoPS V2','V2','Chapter 16: Sequences & Recurrences','Recurrences',180,191,3,191,210,6)
      ]
    }
  },

  // ============================ AoPS Intro series ============================
  'prealgebra': {
    id:'prealgebra', title:'AoPS Prealgebra', kind:'INTRO',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('Prealgebra','INTRO','Percents & Proportions','Ratios & percents',210,246,4,246,310,6)
      ]
    }
  },
  'intro-alg': {
    id:'intro-alg', title:'AoPS Introduction to Algebra', kind:'INTRO',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('Intro Alg','INTRO','Linear Equations','Linear techniques',28,64,4,64,120,6),
        ...buildUnits('Intro Alg','INTRO','Quadratics','Quadratics',120,160,4,160,220,6)
      ],
      'Functions':[
        ...buildUnits('Intro Alg','INTRO','Functions & Graphs','Domain/range',196,228,4,228,260,6)
      ],
      'Sequences and Series':[
        ...buildUnits('Intro Alg','INTRO','Sequences','Arithmetic/geometric',228,260,4,260,300,6)
      ]
    }
  },
  'intro-cp': {
    id:'intro-cp', title:'AoPS Introduction to Counting & Probability', kind:'INTRO',
    topics:{
      'Combinatorics':[
        ...buildUnits('Intro C&P','INTRO','Counting Strategies','Add/multiply rules',16,52,4,52,110,6),
        ...buildUnits('Intro C&P','INTRO','Combinations','nCr basics',58,92,4,92,140,6)
      ],
      'Probability':[
        ...buildUnits('Intro C&P','INTRO','Basic Probability','Outcomes & events',90,128,4,128,170,6)
      ]
    }
  },
  'intro-geo': {
    id:'intro-geo', title:'AoPS Introduction to Geometry', kind:'INTRO',
    topics:{
      'Geometry':[
        ...buildUnits('Intro Geo','INTRO','Triangles I','Angles & congruence',38,76,4,76,130,6),
        ...buildUnits('Intro Geo','INTRO','Area','Area methods',116,154,4,154,200,6),
        ...buildUnits('Intro Geo','INTRO','Circles & Polygons','Circle geometry',200,252,4,252,300,6)
      ]
    }
  },
  'intro-nt': {
    id:'intro-nt', title:'AoPS Introduction to Number Theory', kind:'INTRO',
    topics:{
      'Number Theory':[
        ...buildUnits('Intro NT','INTRO','Divisibility','gcd/lcm',18,58,4,58,120,6),
        ...buildUnits('Intro NT','INTRO','Congruences','Mod arithmetic',98,144,4,144,200,6),
        ...buildUnits('Intro NT','INTRO','Primes','Prime powers',146,188,4,188,240,6)
      ]
    }
  },

  // ============================ Intermediate / Advanced ============================
  'int-alg': {
    id:'int-alg', title:'AoPS Intermediate Algebra', kind:'INT',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('Int Alg','INT','Polynomials I','Factor/symmetric',10,56,4,56,120,6),
        ...buildUnits('Int Alg','INT','Inequalities','AM-GM/CS',176,212,4,212,260,6)
      ],
      'Functions':[
        ...buildUnits('Int Alg','INT','Functional Equations','Iterates & structure',256,300,4,300,340,6)
      ],
      'Sequences and Series':[
        ...buildUnits('Int Alg','INT','Series','Telescoping/partials',296,340,4,340,380,6)
      ]
    }
  },
  'int-cp': {
    id:'int-cp', title:'AoPS Intermediate Counting & Probability', kind:'INT',
    topics:{
      'Combinatorics':[
        ...buildUnits('Int C&P','INT','PIE & Applications','PIE',38,84,4,84,140,6),
        ...buildUnits('Int C&P','INT','Recurrences','Recurrence methods',108,150,4,150,200,6),
        ...buildUnits('Int C&P','INT','Generating Functions','GF intro',200,236,4,236,280,6)
      ],
      'Probability':[
        ...buildUnits('Int C&P','INT','Expected Value','Linearity',158,196,4,196,240,6),
        ...buildUnits('Int C&P','INT','Markov / Conditional','Conditioning',240,276,4,276,320,6)
      ]
    }
  },
  'precalc': {
    id:'precalc', title:'AoPS Precalculus', kind:'PRECALC',
    topics:{
      'Functions':[
        ...buildUnits('Precalc','PRECALC','Functions & Inverses','Composition/inverse',18,64,4,64,120,6),
        ...buildUnits('Precalc','PRECALC','Trigonometric Functions','Trig for olympiads',180,220,4,220,260,6)
      ],
      'Sequences and Series':[
        ...buildUnits('Precalc','PRECALC','Recurrences','Linear recurrences',218,264,4,264,320,6)
      ],
      'Polynomials and Algebra':[
        ...buildUnits('Precalc','PRECALC','Polynomial Behavior','Roots/graphs',298,340,4,340,390,6)
      ]
    }
  },

  // ============================ Geometry & Proof tracks ============================
  'egmo': {
    id:'egmo', title:'EGMO ‚Äî Euclidean Geometry in Mathematical Olympiads', kind:'EGMO',
    topics:{
      'Geometry':[
        ...buildUnits('EGMO','EGMO','Power of a Point & Homothety','Similarity toolkit',58,100,4,100,150,6),
        ...buildUnits('EGMO','EGMO','Inversion','Inversion basics',148,190,4,190,240,6),
        ...buildUnits('EGMO','EGMO','Advanced Circle Geometry','Mixtilinear/Apollonius',190,230,4,230,280,6)
      ]
    }
  },
  'zeitz': {
    id:'zeitz', title:'The Art & Craft of Problem Solving (Zeitz)', kind:'OTHER',
    topics:{
      'Combinatorics':[
        ...buildUnits('Zeitz','OTHER','Pigeonhole/Invariant/Extremal','Core strategies',88,132,4,132,190,6)
      ],
      'Polynomials and Algebra':[
        ...buildUnits('Zeitz','OTHER','Algebraic Tactics','Manipulation',118,160,4,160,210,6)
      ],
      'Number Theory':[
        ...buildUnits('Zeitz','OTHER','Congruences & Order','NT tactics',148,190,4,190,240,6)
      ],
      'Geometry':[
        ...buildUnits('Zeitz','OTHER','Transformations/Extremal','Geo tactics',178,220,4,220,270,6)
      ]
    }
  },
  'velleman': {
    id:'velleman', title:'How to Prove It (Velleman)', kind:'PROOF',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('Velleman','PROOF','Direct & Contrapositive Proofs','Foundations',44,88,6,88,118,5)
      ],
      'Number Theory':[
        ...buildUnits('Velleman','PROOF','Induction','Proof by induction',90,128,6,128,156,5)
      ],
      'Combinatorics':[
        ...buildUnits('Velleman','PROOF','Sets & Functions','Set proofs',8,44,6,44,74,5)
      ],
      'Geometry':[
        ...buildUnits('Velleman','PROOF','Relations','Equivalence/ordering',128,164,6,164,190,5)
      ]
    }
  },
  'engel': {
    id:'engel', title:'Problem-Solving Strategies (Engel)', kind:'PROOF',
    topics:{
      'Combinatorics':[
        ...buildUnits('Engel','PROOF','Extremal Principle','Extremal & invariants',58,98,6,98,140,5)
      ],
      'Number Theory':[
        ...buildUnits('Engel','PROOF','NT Strategies','Diophantine/invariants',98,140,6,140,180,5)
      ],
      'Geometry':[
        ...buildUnits('Engel','PROOF','Geometric Inequalities','Inequalities in geo',140,180,6,180,220,5)
      ]
    }
  },

  // ============================ Topic-specific companions ============================
  '104nt': {
    id:'104nt', title:'104 Number Theory Problems (Andreescu & Andrica)', kind:'OTHER',
    topics:{
      'Number Theory':[
        ...buildUnits('104 NT','OTHER','Training Sets A','Practice sets',1,60,6,1,120,8),
        ...buildUnits('104 NT','OTHER','Training Sets B','Practice sets',61,120,6,121,220,8)
      ]
    }
  },
  'path-comb': {
    id:'path-comb', title:'A Path to Combinatorics (Andreescu & Feng)', kind:'OTHER',
    topics:{
      'Combinatorics':[
        ...buildUnits('Path Comb','OTHER','Counting Foundations','Counting methods',1,90,6,90,180,8)
      ]
    }
  },
  'cmms': {
    id:'cmms', title:'Competition Math for Middle School', kind:'INTRO',
    topics:{
      'Polynomials and Algebra':[
        ...buildUnits('CMMS','INTRO','Algebra Review','Equations/expressions',8,60,4,60,120,6)
      ],
      'Number Theory':[
        ...buildUnits('CMMS','INTRO','Number Theory Review','Divisibility',28,80,4,80,140,6)
      ],
      'Combinatorics':[
        ...buildUnits('CMMS','INTRO','Counting Basics','Perm/comb',68,110,4,110,160,6)
      ],
      'Probability':[
        ...buildUnits('CMMS','INTRO','Probability Basics','Classical probability',88,120,4,120,160,6)
      ],
      'Geometry':[
        ...buildUnits('CMMS','INTRO','Geometry Review','Angles/area',108,160,4,160,210,6)
      ]
    }
  }
};

/* ============================================================================
   PRACTICE BANK (compact; PotD supplies breadth)
============================================================================ */
const CORE_BANK = {
  AMC10: [
    {contest:"AMC10",year:2016,variant:"A",number:16,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_16",minutes:12},
    {contest:"AMC10",year:2011,variant:"A",number:21,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10A_Problems/Problem_21",minutes:13},
    {contest:"AMC10",year:2016,variant:"A",number:17,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_17",minutes:12},
    {contest:"AMC10",year:2013,variant:"A",number:19,topic:"Sequences and Series",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10A_Problems/Problem_19",minutes:13},
    {contest:"AMC10",year:2016,variant:"B",number:18,topic:"Functions",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10B_Problems/Problem_18",minutes:12},
    {contest:"AMC10",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10A_Problems/Problem_16",minutes:12}
  ],
  AMC12: [
    {contest:"AMC12",year:2018,variant:"B",number:22,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12B_Problems/Problem_22",minutes:15},
    {contest:"AMC12",year:2013,variant:"B",number:22,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_12B_Problems/Problem_22",minutes:16},
    {contest:"AMC12",year:2011,variant:"A",number:19,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_19",minutes:13},
    {contest:"AMC12",year:2011,variant:"A",number:20,topic:"Probability",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_20",minutes:14},
    {contest:"AMC12",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_12A_Problems/Problem_16",minutes:12}
  ],
  AIME: [
    {contest:"AIME",year:2016,variant:"II",number:6,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_II_Problems/Problem_6",minutes:18},
    {contest:"AIME",year:2015,variant:"I",number:1,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_1",minutes:14},
    {contest:"AIME",year:2019,variant:"I",number:4,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2019_AIME_I_Problems/Problem_4",minutes:18},
    {contest:"AIME",year:2015,variant:"I",number:4,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_4",minutes:16},
    {contest:"AIME",year:2013,variant:"I",number:11,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_I_Problems/Problem_11",minutes:18},
    {contest:"AIME",year:2021,variant:"I",number:12,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2021_AIME_I_Problems/Problem_12",minutes:20}
  ]
};
function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }
function jmoSetURL(kind,y){ return `https://artofproblemsolving.com/wiki/index.php/${y}_${kind}_Problems`; }

/* ============================================================================
   INIT
============================================================================ */
(function init(){
  if(!input) return;

  const today=new Date(); today.setHours(0,0,0,0);
  const todayStr=today.toISOString().slice(0,10);
  document.getElementById('testDate').min=todayStr;

  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  // off-days from payload
  const offDays=(input.offDays&&Array.isArray(input.offDays))?input.offDays.map(Number):[];
  document.querySelectorAll('.offday-group input[type="checkbox"]').forEach(cb=>{
    cb.checked = offDays.includes(Number(cb.value));
  });

  const start=new Date(today);
  const end=new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays=Math.ceil((end-start)/86400000);
  const days=(Number.isFinite(rawDays)&&rawDays>0)?rawDays:14;

  document.getElementById('advice').style.display='none';
  planSummary.innerHTML = `Start: <b>${fmtDate(start)}</b> ‚Üí Test: <b>${fmtDate(end)}</b> ‚Ä¢ Window: <b>${days}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  window.__POTD.init(input.goal);
  const plan=buildPlan(start,end,days);
  renderCalendar(start,end,plan);

  document.getElementById('downloadIcs').onclick=()=>{
    const ics=buildICS(start,plan,input);
    const blob=new Blob([ics],{type:'text/calendar'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('rebuildBtn').onclick=()=>{
    const m=Number(document.getElementById('mPerDay').value||0), t=document.getElementById('testDate').value;
    if(m<15||!t){ alert('Enter minutes per day (‚â• 15) and a future test date.'); return; }
    const offs=[...document.querySelectorAll('.offday-group input[type="checkbox"]:checked')].map(cb=>Number(cb.value));
    input.minutesPerDay=m; input.testDate=t; input.offDays=offs;
    localStorage.setItem('studyPlanInput', JSON.stringify(input));
    location.href='timeline.html?v=rebuild';
  };
})();

/* ============================================================================
   WEIGHTS (diagnostic + contest emphasis)
============================================================================ */
function topicWeightsFromDiagnostic(subs){
  const cats=['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Functions','Sequences and Series'];
  const w={}; cats.forEach(k=>w[k]=1.0);
  for(const k of cats){
    const r=(subs?.[k]?.right||0), t=(subs?.[k]?.total||0);
    const miss= t>0 ? (1-r/t) : 0.6;
    w[k]=0.6+1.2*miss;
  }
  const emphasis={
    amc10:{'Polynomials and Algebra':1.2,'Geometry':1.2,'Number Theory':1.0,'Combinatorics':1.0,'Probability':1.0,'Functions':0.9,'Sequences and Series':0.9},
    amc12:{'Polynomials and Algebra':1.25,'Geometry':1.2,'Number Theory':1.05,'Combinatorics':1.0,'Probability':1.0,'Functions':1.0,'Sequences and Series':1.0},
    aime:{'Polynomials and Algebra':1.25,'Number Theory':1.2,'Combinatorics':1.15,'Geometry':1.1,'Probability':1.05,'Functions':1.0,'Sequences and Series':1.0},
    usamo:{'Number Theory':1.2,'Geometry':1.2,'Combinatorics':1.15,'Polynomials and Algebra':1.1,'Functions':1.0,'Sequences and Series':1.0,'Probability':0.95},
    usajmo:{'Number Theory':1.2,'Geometry':1.2,'Combinatorics':1.15,'Polynomials and Algebra':1.1,'Functions':1.0,'Sequences and Series':1.0,'Probability':0.95}
  }[input.goal||'amc12']||{};
  for(const k in w){ w[k]*=(emphasis[k]||1.0); }
  return w;
}

/* ============================================================================
   SCHEDULER
============================================================================ */
function buildPlan(start, end, totalDays){
  const minutesPerDay=Number(input.minutesPerDay||60);
  const selectedBooks=new Set(input.selectedBooks||[]);
  const offDays=(input.offDays||[]).map(Number);
  const weights=topicWeightsFromDiagnostic(input.subscores||{});
  const topics=Object.keys(weights);

  // Build content index from selected books
  const CONTENT={};
  selectedBooks.forEach(id=>{ if(BOOK_BANK[id]) CONTENT[id]=BOOK_BANK[id]; });
  if(Object.keys(CONTENT).length===0){
    if(input.goal==='aime'||input.goal==='usamo'||input.goal==='usajmo') CONTENT['aops-v2']=BOOK_BANK['aops-v2'];
    else CONTENT['aops-v1']=BOOK_BANK['aops-v1'];
  }

  // Progress cursors per (book, topic, unit) and within-unit page cursor:
  const prog = {}; // key book|topic -> {uIdx:number}
  function K(bookId, topic){return `${bookId}|${topic}`;}

  // Helper: has any reading left overall?
  function hasAnyReadingLeft(){
    for(const bid in CONTENT){
      const book=CONTENT[bid];
      for(const topic in book.topics){
        const arr=book.topics[topic];
        for(let i=0;i<arr.length;i++){
          const u=arr[i];
          if(u._pCursor===undefined) return true;
          if(u._pCursor<=u.pEnd) return true;
        }
      }
    }
    return false;
  }

  function minutesPerPage(kind){ return (BOOKS_META.rates[kind]||2.5); }

  // Topic picker (weighted)
  function pickTopic(){
    const sum=topics.reduce((s,k)=>s+(weights[k]||0),0);
    let r=Math.random()*sum;
    for(const k of topics){ r-= (weights[k]||0); if(r<=0) return k; }
    return topics[0];
  }

  // Reading allocator: prefer chosen topic, else any topic that has content; never stops unless fully exhausted
  function nextReadingChunk(preferredTopic, budgetMins){
    const tryTopics = [];
    if(preferredTopic) tryTopics.push(preferredTopic);
    // add all topics sorted by weight high‚Üílow to keep weakness focus
    const sorted = [...topics].sort((a,b)=> (weights[b]||0)-(weights[a]||0));
    for(const t of sorted){ if(!tryTopics.includes(t)) tryTopics.push(t); }

    for(const t of tryTopics){
      for(const bid in CONTENT){
        const book=CONTENT[bid]; const arr=book.topics?.[t]||[];
        if(!arr.length) continue;
        const key=K(bid,t);
        const cursor=(prog[key]||{uIdx:0});
        let uIdx=cursor.uIdx;
        // advance until a unit with pages left
        while(uIdx<arr.length && (arr[uIdx]._pCursor!==undefined && arr[uIdx]._pCursor>arr[uIdx].pEnd)){ uIdx++; }
        if(uIdx>=arr.length){ prog[key]={uIdx}; continue; }
        const unit=arr[uIdx];
        unit._pCursor = unit._pCursor===undefined ? unit.pStart : unit._pCursor;
        const remaining = unit.pEnd - unit._pCursor + 1;
        if(remaining<=0){ prog[key]={uIdx:uIdx+1}; continue; }
        const rate=minutesPerPage(book.kind);
        const pages = clamp(Math.floor((budgetMins + 0.3*rate)/rate), 2, remaining);
        const from=unit._pCursor, to=unit._pCursor+pages-1;
        const used=Math.round(pages*rate);
        unit._pCursor = to+1;
        if(unit._pCursor>unit.pEnd) prog[key]={uIdx:uIdx+1}; else prog[key]={uIdx};
        return {html:`üìò <b>${t}</b>: ${book.title}, ${unit.chapter} ‚Äî ${unit.title} (pages ${from}‚Äì${to})`, mins:used, type:'reading', _book:book, _unit:unit, _topic:t, _from:from, _to:to};
      }
    }
    return null;
  }

  // Aligned exercises from a unit
  function nextExercisesForUnit(unit, book, wantMins){
    const per = (book.kind==='V1'||book.kind==='INTRO')?6.0: (book.kind==='EGMO'||book.kind==='PROOF')?9.0 : 8.0;
    const cnt = Math.max(1, Math.floor((wantMins + 0.25*per)/per));
    unit._exCursor = unit._exCursor || (unit.exStart||1);
    const start = unit._exCursor;
    const end = Math.min(unit.exEnd|| (start+cnt-1), start+cnt-1);
    const used = Math.round((end-start+1)*per);
    unit._exCursor = end+1;
    const rangeText = (start===end) ? `Problem ${start}` : `Problems ${start}‚Äì${end}`;
    const exPages = (unit.exStart && unit.exEnd) ? ` (exercises pages ${unit.exStart}‚Äì${unit.exEnd})` : '';
    const topicGuess = 'topic' in unit ? unit.topic : '‚Äî';
    return {html:`üß† <b>Book exercises</b> (${book.title}, ${unit.chapter}): ${rangeText}${exPages}`, mins:used, type:'bookex', _topic:topicGuess };
  }

  // Practice (small; topic-matched)
  const usedPractice=new Set();
  function makeTopicPractice(blockMinutes, preferredTopics){
    const level=(input.goal==='amc10')?'AMC10':(input.goal==='amc12')?'AMC12':'AIME';
    const per=(input.goal==='aime'||input.goal==='usamo'||input.goal==='usajmo')?16:10;
    const target=Math.max(1, Math.floor((blockMinutes + 0.25*per)/per));
    const chosen=[];
    const topics = preferredTopics && preferredTopics.length ? preferredTopics : Object.keys(weights);
    for(const topic of topics){
      const pool=(CORE_BANK[level]||[]).filter(p=>p.topic===topic);
      for(const p of pool){
        const id=`${p.contest}-${p.year}-${p.variant}-${p.number}`;
        if(usedPractice.has(id)) continue;
        chosen.push(p); usedPractice.add(id);
        if(chosen.length>=target) break;
      }
      if(chosen.length>=target) break;
    }
    if(chosen.length<target){
      for(const p of (CORE_BANK[level]||[])){
        const id=`${p.contest}-${p.year}-${p.variant}-${p.number}`;
        if(usedPractice.has(id)) continue;
        chosen.push(p); usedPractice.add(id);
        if(chosen.length>=target) break;
      }
    }
    if(!chosen.length) return null;
    const list = chosen.map(p=>`<a href="${p.url}" target="_blank" rel="noopener">${p.year} ${p.contest}${p.contest==='AIME'?' '+p.variant:' '+p.variant} Problem ${p.number}</a>`).join(', ');
    return {html:`üß© Topic-matched set: ${list}`, mins:blockMinutes, type:'drill'};
  }

  // Proof module (MO tracks)
  const proofIDs=['velleman','zeitz','engel','egmo'].filter(id=>selectedBooks.has(id));
  const proofPool=[];
  if(proofIDs.length){
    proofIDs.forEach(id=>{
      const bk=BOOK_BANK[id]; if(!bk) return;
      for(const t in bk.topics){ for(const u of bk.topics[t]) proofPool.push({book:bk, unit:u}); }
    });
  }
  let proofIdx=0;
  function scheduleProofBlock(blockMinutes){
    if(!proofPool.length || blockMinutes<12) return [];
    const out=[]; let used=0;
    while(used+18<=blockMinutes && proofIdx<proofPool.length){
      const item=proofPool[proofIdx++];
      const per=BOOKS_META.rates.PROOF;
      const pages=clamp(Math.floor((18+0.3*per)/per),2,(item.unit.pEnd-item.unit.pStart+1));
      const from=item.unit.pStart; const to=Math.min(item.unit.pEnd, from+pages-1);
      out.push({html:`üìó <b>Proof module</b>: ${item.book.title}, ${item.unit.chapter} ‚Äî ${item.unit.title} (pages ${from}‚Äì${to}). Write at least one full proof from the exercise set.`, mins:18, type:'proof'});
      used += 18;
      item.unit.pStart = to+1;
      if(item.unit.pStart<=item.unit.pEnd) { proofIdx--; } // not finished, keep it
      else { /* advance to next */ }
    }
    return out;
  }

  // Build day list with off-days
  const days=[];
  for(let i=0;i<totalDays;i++){
    const d=new Date(start.getTime()+i*86400000);
    const wk=d.getDay();
    days.push({date:d, off: offDays.includes(wk), tasks:[]});
  }

  // Phases
  const fCut=Math.floor(days.length*0.55), mCut=Math.floor(days.length*0.85);
  function phaseAt(i){ return (i<fCut)?'Foundation':(i<mCut?'Mixed':'Final'); }

  // Mocks near test: 2‚Äì4/week
  function shouldMock(date){
    const daysToTest=daysBetween(date,end);
    if(daysToTest>30) return false;
    const wd=date.getDay();
    const boost=minutesPerDay>=90;
    if(input.goal==='aime' || input.goal==='usamo' || input.goal==='usajmo'){
      return (wd===2||wd===4||wd===6||(boost&&wd===0));
    } else {
      return (wd===2||wd===5||(boost&&wd===0)||(boost&&wd===6));
    }
  }
  const usedMocks=new Set();
  function makeMock(totalMinutes){
    if(input.goal==='aime'){
      const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i), V=['I','II'];
      for(let k=0;k<40;k++){ const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)], id=`AIME-${y}-${v}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${aimeSetURL(y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AIME ${v} (15 problems). Review & update your error log.</a>`, mins:totalMinutes, type:'mock'}; }
    } else if(input.goal==='usamo'||input.goal==='usajmo'){
      const kind=(input.goal==='usamo')?'USAMO':'USAJMO'; const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i);
      for(let k=0;k<20;k++){ const y=years[Math.floor(Math.random()*years.length)], id=`${kind}-${y}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${jmoSetURL(kind,y)}" target="_blank" rel="noopener">üìù Full mock: ${y} ${kind}. Spend 2√ó time on post-mortem & proof writing.</a>`, mins:totalMinutes, type:'mock'}; }
    } else {
      const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i), V=['A','B']; const lv=(input.goal==='amc10')?'10':'12';
      for(let k=0;k<40;k++){ const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)], id=`AMC${lv}-${y}-${v}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${amcSetURL(lv,y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AMC ${lv}${v}. Review & update your error log.</a>`, mins:totalMinutes, type:'mock'}; }
    }
    return {html:`üìù Full mock & review`, mins:totalMinutes, type:'mock'};
  }

  // Mix ratios
  function baseMixForPhase(ph){
    if(ph==='Foundation') return {read:0.55, ex:0.30, practice:0.15, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.10:0.00};
    if(ph==='Mixed')      return {read:0.45, ex:0.30, practice:0.25, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.12:0.00};
    return                  {read:0.35, ex:0.25, practice:0.40, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.12:0.00};
  }
  function adjustedMix(base,m){
    const adj=(m<=35)?{r:+0.08, p:-0.05}:{r:0,p:0};
    let r=base.read+adj.r, e=base.ex, p=Math.max(0,base.practice+adj.p), pr=base.proof;
    const s=r+e+p+pr; r/=s; e/=s; p/=s; pr/=s; return {read:r,ex:e,practice:p,proof:pr};
  }

  // Build each day
  const tasksByDay=[];
  for(let i=0;i<days.length;i++){
    const day=days[i]; const d=day.date;
    const tlist=[];
    if(day.off){ tasksByDay.push(tlist); continue; }

    const phase=phaseAt(i);
    if(shouldMock(d)){ tlist.push(makeMock(minutesPerDay)); tasksByDay.push(tlist); continue; }

    const mix=adjustedMix(baseMixForPhase(phase), minutesPerDay);
    let mRead=Math.round(minutesPerDay*mix.read),
        mEx  =Math.round(minutesPerDay*mix.ex),
        mPrac=Math.round(minutesPerDay*mix.practice),
        mProof=Math.round(minutesPerDay*mix.proof);

    // reading: strongly prefer weak topics
    let topicsChosen=[];
    let tries=0;
    while(mRead>=6 && tries<3){
      const t=pickTopic();
      const r=nextReadingChunk(t, mRead);
      if(r){ tlist.push(r); mRead=Math.max(0,mRead-r.mins); topicsChosen.push(r._topic); }
      else { // fallback to any available
        const any=nextReadingChunk(null, mRead);
        if(any){ tlist.push(any); mRead=Math.max(0,mRead-any.mins); topicsChosen.push(any._topic); }
        else break;
      }
      tries++;
    }

    // ensure at least one reading if content remains (addressed issue)
    if(tlist.filter(x=>x.type==='reading').length===0 && hasAnyReadingLeft()){
      const backfill = nextReadingChunk(null, Math.max(10, Math.round(minutesPerDay*0.35)));
      if(backfill){ tlist.push(backfill); mRead=Math.max(0,mRead-backfill.mins); topicsChosen.push(backfill._topic); }
    }

    // exercises aligned to most recent reading
    if(mEx>=6){
      const lastRead=[...tlist].reverse().find(t=>t.type==='reading');
      if(lastRead){
        const ex=nextExercisesForUnit(lastRead._unit, lastRead._book, mEx);
        if(ex){ tlist.push(ex); mEx=Math.max(0,mEx-ex.mins); }
      }
      // if we still have exercise budget and readings exist earlier, attach to the earliest reading
      if(mEx>=6){
        const firstRead=tlist.find(t=>t.type==='reading');
        if(firstRead){
          const ex2=nextExercisesForUnit(firstRead._unit, firstRead._book, mEx);
          if(ex2){ tlist.push(ex2); mEx=0; }
        }
      }
    }

    // proof (MO tracks)
    if(mProof>0){
      const pf=scheduleProofBlock(mProof);
      pf.forEach(x=>tlist.push(x));
    }

    // practice set matched to today's topics
    if(mPrac>=8){
      const uniqTopics=Array.from(new Set(topicsChosen));
      const pr=makeTopicPractice(mPrac, uniqTopics);
      if(pr) tlist.push(pr);
    }

    // PotD every non-mock day
    const potd=window.__POTD.next();
    if(potd){
      tlist.push({html:`üß© <b>Problem of the day</b>: <a href="${potd.url}" target="_blank" rel="noopener">${potd.label}</a>`, mins:0, type:'potd'});
    }

    // If STILL no reading and content remains (extreme corner), force a small reading
    if(tlist.filter(x=>x.type==='reading').length===0 && hasAnyReadingLeft()){
      const forceRead=nextReadingChunk(null, 12);
      if(forceRead) tlist.unshift(forceRead);
    }

    tasksByDay.push(tlist);
  }

  // Advice for low score & low minutes
  const subs=input.subscores||{};
  const R=Object.values(subs).reduce((s,x)=>s+(x.right||0),0);
  const T=Object.values(subs).reduce((s,x)=>s+(x.total||0),0);
  const pct=T?Math.round(100*R/T):50;
  if(pct<=35 && minutesPerDay<=40){
    const adv=document.getElementById('advice');
    adv.style.display='block';
    adv.innerHTML=`You scored about <b>${pct}%</b> with limited daily time. We biased your plan toward reading/learning and proof-building (if selected). Consider targeting <b>45‚Äì60</b> minutes to accelerate progress.`;
  }

  // Map dates ‚Üí tasks
  const planMap=new Map();
  for(let i=0;i<days.length;i++){
    const date=days[i].date;
    planMap.set(date.toISOString().slice(0,10), tasksByDay[i]);
  }
  return {map:planMap, tasksByDay, start, end};
}

/* ============================================================================
   CALENDAR
============================================================================ */
function renderCalendar(start, end, plan){
  const cal=document.getElementById('calendar'); cal.innerHTML='';
  const months=buildMonthList(start,end); let monthIdx=0;

  function buildMonthList(startDate,endDate){
    const out=[]; let cur=new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last=new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur=new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }

  function renderOneMonth({year,month}){
    cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header=new Date(year,month,1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f3f4f6';
      head.innerHTML=`<div class="date" style="opacity:.75">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const today=new Date(); today.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=plan.map.get(key)||[];
      const inRange=(dateObj>=plan.start && dateObj<=plan.end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(sameDay(dateObj,today)) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){
        tasks.forEach(t=>{
          html += `<div class="task">${ t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`;
        });
      }
      box.innerHTML=html; grid.appendChild(box);
    }

    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${months.indexOf(months.find(m=>m.year===year&&m.month===month))+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick=()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick=()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};
}

/* ============================================================================
   ICS EXPORT
============================================================================ */
function buildICS(startDate, plan, meta){
  function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()+0).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
  const tasksByDay=plan.tasksByDay; const minutes=Number(input.minutesPerDay);
  for(let i=0;i<tasksByDay.length;i++){
    const day=new Date(startDate.getTime()+i*86400000); const items=tasksByDay[i]||[]; if(!items.length) continue;
    const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
    const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
    lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
  }
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
</script>

</body>
</html>
