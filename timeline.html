<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:110px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.9rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">Low study time leans into reading; final days emphasize full mocks. Reading sources reflect the books you selected.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (selected books)</span>
      <span>üß† Book exercises (specific problem numbers)</span>
      <span>üìó Proof module (if selected)</span>
      <span>üß© Problem of the day (random, no repeats within 21 days)</span>
      <span>‚è±Ô∏è Timed practice set</span>
      <span>üìù Full mock and review</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(async function init(){
  const errBox = document.getElementById('errBox');
  window.addEventListener('error', (e)=>{
    errBox.style.display='block';
    errBox.textContent = 'Runtime error: ' + (e.message||'Unknown');
  });

  // ------------ Read input payload ------------
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }

  // ------------ Calendar window & UI ------------
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  const start = new Date(today);
  const end   = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  const days = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 14;

  planSummary.innerHTML = `Start: <b>${start.toLocaleDateString()}</b> ‚Üí Test: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Window: <b>${days}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  // ------------ Study knobs ------------
  const THRESH = {read:10, drill:10, timed:8};
  const QUOTA_SLACK = 2;

  // ------------ Tracks ------------
  const selectedBooks = new Set(input.selectedBooks || []);
  const onAIMETrack = (input.testId!=='A');
  const isUSAMOTrack = (input.testId==='C');

  // ------------ Diagnostic weights ------------
  const subs = input.subscores||{};
  const cats = Object.keys(subs).length ? Object.keys(subs) :
    ['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Sequences and Series','Functions','Probability'];
  const weights={}; cats.forEach(k=>{const r=(subs[k]?.right||0), t=(subs[k]?.total||1); weights[k]=1 - r/t + 0.05});

  // ------------ Reading banks (same content as before) ------------
  const V1=1, V2=2;
  function minutesPerPage(vol){ return (vol===V1)?2.0:(isUSAMOTrack?3.2:2.7); }

  const READS_VOL1 = {
    "Number Theory":[
      {id:"V1-NT-5.4", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 5.4: Modular Arithmetic", pStart:42, pEnd:45, exCount:30, subs:['modular']},
      {id:"V1-NT-5.6-5.7", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 5.6‚Äì5.7: Primes and Factors", pStart:47, pEnd:48, exCount:18, subs:['primes-factors']},
    ],
    "Combinatorics":[
      {id:"V1-C-25", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 25: Learning to Count", pStart:221, pEnd:229, exCount:40, subs:['basic-counting']},
    ],
    "Probability":[
      {id:"V1-P-25", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 25: Counting as a foundation for Probability", pStart:221, pEnd:229, exCount:24, subs:['basic-prob']},
    ],
    "Sequences and Series":[
      {id:"V1-S-24", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 24: Sequences and Series", pStart:211, pEnd:217, exCount:28, subs:['sequences']},
    ],
    "Functions":[
      {id:"V1-F-21", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 21: Functions", pStart:187, pEnd:190, exCount:16, subs:['functions']},
    ],
    "Polynomials and Algebra":[
      {id:"V1-A-6", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 6: Quadratic Equations", pStart:52, pEnd:60, exCount:32, subs:['quadratics']},
    ],
    "Geometry":[
      {id:"V1-G-11.8", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 11.8: Area of a Triangle", pStart:109, pEnd:109, exCount:12, subs:['triangle-area']},
      {id:"V1-G-14-15", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 14: Angle Chasing and Chapter 15: Area", pStart:133, pEnd:138, exCount:36, subs:['angle-area']},
      {id:"V1-G-18", book:'AoPS Volume 1', vol:V1, chapter:"Chapter 18: Three-Dimensional Geometry", pStart:165, pEnd:169, exCount:20, subs:['3d-geometry']},
    ],
  };
  const READS_VOL2 = {
    "Number Theory":[
      {id:"V2-NT-23", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 23: Divisibility and Congruences", pStart:252, pEnd:262, exCount:34, subs:['modular-adv']},
      {id:"V2-NT-24", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 24: Diophantine Equations", pStart:266, pEnd:274, exCount:26, subs:['diophantine']},
    ],
    "Combinatorics":[
      {id:"V2-C-15", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 15: Combinatorics and the Binomial Theorem", pStart:170, pEnd:176, exCount:30, subs:['binomial']},
      {id:"V2-C-25.6", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 25.6: Colorings", pStart:280, pEnd:280, exCount:12, subs:['colorings']},
    ],
    "Probability":[
      {id:"V2-P-15.5", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 15.5: Binomial Theorem for distributions", pStart:175, pEnd:175, exCount:10, subs:['prob-binomial']},
    ],
    "Sequences and Series":[
      {id:"V2-S-16", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 16: Sequences and Recurrences", pStart:180, pEnd:191, exCount:36, subs:['recurrences']},
    ],
    "Functions":[
      {id:"V2-F-7", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 7: Functional Equations", pStart:69, pEnd:73, exCount:18, subs:['functional-eq']},
    ],
    "Polynomials and Algebra":[
      {id:"V2-A-6", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 6: Polynomials", pStart:52, pEnd:65, exCount:34, subs:['polynomials']},
    ],
    "Geometry":[
      {id:"V2-G-22", book:'AoPS Volume 2', vol:V2, chapter:"Chapter 22: Geometry Tidbits ‚Äî Inversion and Homothety", pStart:241, pEnd:247, exCount:16, subs:['geo-advanced']},
    ],
  };

  // ------------------------------------------------------------
  //  PROBLEM BANKS (as before; can be extended via /data/*.json)
  // ------------------------------------------------------------
  const CORE_BANK = {
    AMC10: [
      {id:"2016-10A-16",contest:"AMC10",year:2016,variant:"A",number:16,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_16",minutes:12},
      {id:"2015-10B-17",contest:"AMC10",year:2015,variant:"B",number:17,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10B_Problems/Problem_17",minutes:12},
      {id:"2012-10A-16",contest:"AMC10",year:2012,variant:"A",number:16,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2012_AMC_10A_Problems/Problem_16",minutes:12},
      {id:"2011-10A-21",contest:"AMC10",year:2011,variant:"A",number:21,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10A_Problems/Problem_21",minutes:13},
      {id:"2013-10B-22",contest:"AMC10",year:2013,variant:"B",number:22,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10B_Problems/Problem_22",minutes:14},
      {id:"2010-10A-18",contest:"AMC10",year:2010,variant:"A",number:18,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2010_AMC_10A_Problems/Problem_18",minutes:12},
      {id:"2016-10A-17",contest:"AMC10",year:2016,variant:"A",number:17,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_17",minutes:12},
      {id:"2010-10A-18P",contest:"AMC10",year:2010,variant:"A",number:18,topic:"Probability",url:"https://artofproblemsolving.com/wiki/index.php/2010_AMC_10A_Problems/Problem_18",minutes:12},
      {id:"2013-10A-19",contest:"AMC10",year:2013,variant:"A",number:19,topic:"Sequences and Series",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10A_Problems/Problem_19",minutes:13},
      {id:"2016-10B-18",contest:"AMC10",year:2016,variant:"B",number:18,topic:"Functions",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10B_Problems/Problem_18",minutes:12},
      {id:"2015-10A-16G",contest:"AMC10",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10A_Problems/Problem_16",minutes:12},
      {id:"2011-10B-21G",contest:"AMC10",year:2011,variant:"B",number:21,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10B_Problems/Problem_21",minutes:14},
      {id:"2013-10A-19G",contest:"AMC10",year:2013,variant:"A",number:19,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10A_Problems/Problem_19",minutes:13},
    ],
    AMC12: [
      {id:"2018-12B-22",contest:"AMC12",year:2018,variant:"B",number:22,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12B_Problems/Problem_22",minutes:15},
      {id:"2015-12A-22",contest:"AMC12",year:2015,variant:"A",number:22,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_12A_Problems/Problem_22",minutes:16},
      {id:"2013-12B-22",contest:"AMC12",year:2013,variant:"B",number:22,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_12B_Problems/Problem_22",minutes:16},
      {id:"2011-12A-19",contest:"AMC12",year:2011,variant:"A",number:19,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_19",minutes:13},
      {id:"2011-12A-20",contest:"AMC12",year:2011,variant:"A",number:20,topic:"Probability",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_20",minutes:14},
      {id:"2021-12A-12",contest:"AMC12",year:2021,variant:"A",number:12,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2021_AMC_12A_Problems/Problem_12",minutes:14},
      {id:"2015-12A-16G",contest:"AMC12",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_12A_Problems/Problem_16",minutes:12},
    ],
    AIME: [
      {id:"2016-AII-6",contest:"AIME",year:2016,variant:"II",number:6,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_II_Problems/Problem_6",minutes:18},
      {id:"2014-AI-6",contest:"AIME",year:2014,variant:"I",number:6,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2014_AIME_I_Problems/Problem_6",minutes:18},
      {id:"2016-AI-7",contest:"AIME",year:2016,variant:"I",number:7,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_I_Problems/Problem_7",minutes:18},
      {id:"2015-AI-1",contest:"AIME",year:2015,variant:"I",number:1,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_1",minutes:14},
      {id:"2013-AI-11",contest:"AIME",year:2013,variant:"I",number:11,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_I_Problems/Problem_11",minutes:18},
      {id:"2009-AII-7",contest:"AIME",year:2009,variant:"II",number:7,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2009_AIME_II_Problems/Problem_7",minutes:20},
      {id:"2018-AI-2",contest:"AIME",year:2018,variant:"I",number:2",topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_I_Problems/Problem_2",minutes:14},
      {id:"2019-AI-4",contest:"AIME",year:2019,variant:"I",number:4,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2019_AIME_I_Problems/Problem_4",minutes:18},
      {id:"2020-AI-9",contest:"AIME",year:2020,variant:"I",number:9,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2020_AIME_I_Problems/Problem_9",minutes:19},
      {id:"2021-AI-12",contest:"AIME",year:2021,variant:"I",number:12,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2021_AIME_I_Problems/Problem_12",minutes:20},
      {id:"2023-AI-14",contest:"AIME",year:2023,variant:"I",number:14,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2023_AIME_I_Problems/Problem_14",minutes:22},
      {id:"2015-AI-4G",contest:"AIME",year:2015,variant:"I",number:4,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_4",minutes:16},
      {id:"2018-AII-14G",contest:"AIME",year:2018,variant:"II",number:14,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2018_AIME_II_Problems/Problem_14",minutes:24},
      {id:"2022-AI-3G",contest:"AIME",year:2022,variant:"I",number:3,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2022_AIME_I_Problems/Problem_3",minutes:16},
      {id:"1993-A-10G",contest:"AIME",year:1993,variant:"",number:10,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/1993_AIME_Problems/Problem_10",minutes:18}
    ]
  };

  // Optional JSON extension
  async function tryFetchJSON(path){
    try{ const r = await fetch(path, {cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
    catch(e){ return null; }
  }
  const EXT_BANK = { AMC10:[], AMC12:[], AIME:[] };
  const extAMC = await tryFetchJSON('data/amc_bank.json');
  const extAIME= await tryFetchJSON('data/aime_bank.json');
  if(extAMC && Array.isArray(extAMC)) EXT_BANK.AMC10 = extAMC.filter(x=>x.contest==="AMC10").concat(extAMC.filter(x=>x.contest==="AMC12"));
  if(extAMC && Array.isArray(extAMC)) EXT_BANK.AMC12 = extAMC.filter(x=>x.contest==="AMC12");
  if(extAIME && Array.isArray(extAIME)) EXT_BANK.AIME = extAIME.filter(x=>x.contest==="AIME");

  function buildTopicIndex(level){
    const all = (CORE_BANK[level]||[]).concat(EXT_BANK[level]||[]);
    const seen = new Set(); const byTopic = {};
    all.forEach(p=>{
      const key = `${p.contest}-${p.year}-${p.variant||''}-${p.number}`;
      if(seen.has(key)) return; seen.add(key);
      byTopic[p.topic] = byTopic[p.topic] || [];
      byTopic[p.topic].push(p);
    });
    Object.values(byTopic).forEach(arr=>{
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j]]; }
    });
    return byTopic;
  }
  const BANK_BY_TOPIC = {
    AMC10: buildTopicIndex('AMC10'),
    AMC12: buildTopicIndex('AMC12'),
    AIME:  buildTopicIndex('AIME')
  };

  // ---------- POD with 21-day cool-off ----------
  const usedProblems = new Map(); // key -> lastDayIndex
  const COOLDOWN = 21;
  function goalLevelFromInput(){ return (input.goal==='amc10') ? 'AMC10' : (input.goal==='amc12' ? 'AMC12' : 'AIME'); }

  function pickOneProblem(level, topicList, dayIndex){
    const allTopics = Object.keys(BANK_BY_TOPIC[level]||{});
    const topics = (topicList && topicList.length) ? topicList.slice() : allTopics.slice();
    for(let i=topics.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [topics[i],topics[j]]=[topics[j],topics[i]]; }

    // pass 1: unused problems
    for(const t of topics){
      const pool = (BANK_BY_TOPIC[level] && BANK_BY_TOPIC[level][t]) || [];
      for(const p of pool){
        const key = `${p.contest}-${p.year}-${p.variant||''}-${p.number}`;
        if(!usedProblems.has(key)) { usedProblems.set(key, dayIndex); return p; }
      }
    }
    // pass 2: allow reuse if last seen > COOLDOWN days
    for(const t of topics){
      const pool = (BANK_BY_TOPIC[level] && BANK_BY_TOPIC[level][t]) || [];
      for(const p of pool){
        const key = `${p.contest}-${p.year}-${p.variant||''}-${p.number}`;
        const last = usedProblems.get(key) ?? -9999;
        if(dayIndex - last > COOLDOWN) { usedProblems.set(key, dayIndex); return p; }
      }
    }
    return null;
  }

  function makeProblemOfTheDay(blockMinutes, preferredTopics, dayIndex){
    const level = goalLevelFromInput();
    const p = pickOneProblem(level, preferredTopics, dayIndex);
    const html = p
      ? `üß© <b>Problem of the day</b>: <a href="${p.url}" target="_blank" rel="noopener">${p.year} ${p.contest}${p.contest==='AIME' ? ' ' + (p.variant||'') : ' ' + (p.variant||'')} Problem ${p.number}</a>`
      : `üß© <b>Problem of the day</b>: <em>choose any new problem from recent contests in your weak topic</em>`;
    return {html, mins:blockMinutes, type:'drill'};
  }

  function makeTimedPractice(blockMinutes, preferredTopics, dayIndex){
    const level = goalLevelFromInput();
    const picks = [];
    const t1 = pickOneProblem(level, preferredTopics, dayIndex); if(t1) picks.push(t1);
    const t2 = (blockMinutes>=16) ? pickOneProblem(level, preferredTopics, dayIndex) : null; if(t2) picks.push(t2);
    const list = picks.length
      ? picks.map(p=>`<a href="${p.url}" target="_blank" rel="noopener">${p.year} ${p.contest}${p.contest==='AIME' ? ' ' + (p.variant||'') : ' ' + (p.variant||'')} P${p.number}</a>`).join(', ')
      : '<em>topic set</em>';
    const html = `‚è±Ô∏è <b>Timed practice</b>: ${list}`;
    return {html, mins:blockMinutes, type:'timed'};
  }

  // ---------- Mocks ----------
  function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
  function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }
  function makeMock(totalMinutes){
    if(onAIMETrack){
      const years=[...Array(22)].map((_,i)=>2004+i); const V=['I','II'];
      const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)];
      return {html:`<a href="${aimeSetURL(y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AIME ${v} (timed). Review & update your error log.</a>`, mins:totalMinutes, type:'mock'};
    }
    const years=[...Array(18)].map((_,i)=>2006+i); const V=['A','B']; const lv=(input.goal==='amc10')?'10':'12';
    const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)];
    return {html:`<a href="${amcSetURL(lv,y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AMC ${lv}${v} (timed). Review & update your error log.</a>`, mins:totalMinutes, type:'mock'};
  }

  // ---------- Unit progress with wrap/review ----------
  const unitProgress = new Map(); // id -> { nextPage, nextExercise, round }
  function getProg(u){
    if(!unitProgress.has(u.id)){
      unitProgress.set(u.id, { nextPage: u.pStart, nextExercise: 1, round: 0 });
    }
    return unitProgress.get(u.id);
  }
  function formatReading(unit, from, to, round){
    const review = round>0 ? ' ‚Äî review' : '';
    return `${unit.book}, ${unit.chapter} (pages ${from}‚Äì${to})${review}`;
  }

  // Pools per topic using selected books
  function availableUnitsFor(cat){
    let units = [];
    if(selectedBooks.has('aops-v1') && READS_VOL1[cat]) units = units.concat(READS_VOL1[cat].map(x=>({...x, type:'pages'})));
    if(selectedBooks.has('aops-v2') && READS_VOL2[cat]) units = units.concat(READS_VOL2[cat].map(x=>({...x, type:'pages'})));
    return units;
  }

  // Weighted topic with light cooldown
  const RECENT_TOPIC_WINDOW = 3;
  const recentTopics = [];
  function pushRecentTopic(t){
    recentTopics.push(t);
    if(recentTopics.length>RECENT_TOPIC_WINDOW) recentTopics.shift();
  }
  function pickTopic(){
    const entries = Object.entries(weights);
    for(let attempt=0; attempt<5; attempt++){
      const sum=entries.reduce((a,[,w])=>a+w,0); let r=Math.random()*sum;
      let chosen = entries[0][0];
      for(const [k,w] of entries){ r-=w; if(r<=0){ chosen=k; break; } }
      const recentCount = recentTopics.filter(t=>t===chosen).length;
      if(recentCount < 2) return chosen;
    }
    return entries[0][0];
  }

  function scheduleReadingUnified(phaseName, blockMinutes){
    const tasks = [];
    if(blockMinutes < 4) return tasks;

    const phaseBias = (phaseName==='Foundation') ? 0.60 : (phaseName==='Mixed' ? 0.55 : 0.45);
    let readBudget = Math.max(6, Math.round(blockMinutes * phaseBias));
    let exBudget = Math.max(0, blockMinutes - readBudget);

    let chunks=0;
    while(readBudget >= 4 && chunks < 3){
      let cat = pickTopic();
      let units = availableUnitsFor(cat);
      if(!units.length){
        // try another category
        const alt = cats.find(c=>availableUnitsFor(c).length);
        if(!alt) break;
        cat = alt; units = availableUnitsFor(cat);
      }

      // pick unit with smallest nextPage to progress steadily
      units.sort((a,b)=>getProg(a).nextPage - getProg(b).nextPage);
      let unit = units[0];
      let prog = getProg(unit);

      // if this unit fully consumed pages, wrap to review
      const pagesAvail = unit.pEnd - prog.nextPage + 1;
      if(pagesAvail <= 0){
        prog.nextPage = unit.pStart;
        prog.nextExercise = 1;
        prog.round += 1;
      }

      // recompute after possible wrap
      prog = getProg(unit);
      const rate = minutesPerPage(unit.vol);
      const pagesAvail2 = Math.max(0, unit.pEnd - prog.nextPage + 1);
      if(pagesAvail2 <= 0) break;

      const pagesTarget = Math.max(2, Math.min(pagesAvail2, Math.floor((readBudget + 0.3*rate)/rate)));
      const from = prog.nextPage, to = prog.nextPage + pagesTarget - 1;
      const readMins = Math.round(pagesTarget*rate);

      tasks.push({html:`üìò <b>${cat}</b>: ${formatReading(unit, from, to, prog.round)}`, mins:readMins, type:'reading', _ref:unit, _from:from, _to:to, _sub:(unit.subs||[]), _topic:cat});
      pushRecentTopic(cat);

      prog.nextPage = to + 1;
      readBudget -= readMins;
      chunks++;

      // exercises with progress (wrap when done)
      if(exBudget >= 6){
        const ex = buildExercisesFromUnit(unit, exBudget);
        if(ex){ ex._topic = cat; tasks.push(ex); exBudget -= ex.mins; }
      }
    }

    // ensure something exists
    if(!tasks.length){
      for(const cat of cats){
        const units = availableUnitsFor(cat);
        if(!units.length) continue;
        const u=units[0], p=getProg(u), rate=minutesPerPage(u.vol);
        const pagesAvail = Math.max(0, u.pEnd - p.nextPage + 1) || (u.pEnd - u.pStart + 1);
        const pagesTarget = Math.max(2, Math.min(pagesAvail, Math.floor((blockMinutes+0.3*rate)/rate)));
        const from = p.nextPage, to = p.nextPage + pagesTarget - 1;
        const readMins = Math.round(pagesTarget*rate);
        tasks.push({html:`üìò <b>${cat}</b>: ${formatReading(u, from, to, p.round)}`, mins:readMins, type:'reading', _ref:u, _from:from, _to:to, _topic:cat});
        p.nextPage = to + 1;
        break;
      }
    }
    return tasks;
  }

  function buildExercisesFromUnit(unit, wantMins){
    const per = (unit.vol===V1) ? 6.0 : (isUSAMOTrack?9.0:8.0);
    const prog = getProg(unit);
    const total = unit.exCount || 30;
    const remaining = Math.max(0, total - (prog.nextExercise - 1));

    let take;
    if(remaining <= 0){
      // wrap for review set
      prog.nextExercise = 1;
      prog.round += 1;
      take = Math.max(1, Math.floor((wantMins + 0.25*per)/per));
    } else {
      take = Math.max(1, Math.floor((wantMins + 0.25*per)/per));
      take = Math.min(take, remaining);
    }

    const start = prog.nextExercise, end = prog.nextExercise + take - 1;
    const used = Math.round(take * per);
    prog.nextExercise = end + 1;

    const review = prog.round>0 ? ' ‚Äî review' : '';
    const rangeText = (start===end) ? `Problem ${start}` : `Problems ${start}‚Äì${end}`;
    return {html:`üß† <b>Book exercises</b> (${unit.book}, ${unit.chapter}${review}): ${rangeText}`, mins:used, type:'bookex', _topic:canonicalTopic(unit.subs||[])};
  }

  function canonicalTopic(subs){
    const s = (subs[0]||'').toLowerCase();
    if(s.includes('mod')||s.includes('prime')||s.includes('dioph')) return 'Number Theory';
    if(s.includes('count')||s.includes('color')||s.includes('binom')) return 'Combinatorics';
    if(s.includes('prob')) return 'Probability';
    if(s.includes('sequence')||s.includes('recur')) return 'Sequences and Series';
    if(s.includes('function')||s.includes('functional')) return 'Functions';
    if(s.includes('poly')||s.includes('quadratic')||s.includes('viet')) return 'Polynomials and Algebra';
    if(s.includes('3d')||s.includes('angle')||s.includes('triangle')||s.includes('geo')) return 'Geometry';
    return 'Polynomials and Algebra';
  }

  // ---------- Proof module (unchanged) ----------
  const PROOF_BOOKS_SELECTED = ['velleman','zeitz','engel','egmo'].filter(id=>selectedBooks.has(id));
  const PROOF_MODULE = {
    'velleman': [
      {label:'Direct and Contrapositive Proofs (Velleman)', mins:20},
      {label:'Induction (Velleman)', mins:20}
    ],
    'zeitz': [
      {label:'Pigeonhole / Extremal (Zeitz)', mins:20},
      {label:'Invariants / Monovariants (Zeitz)', mins:20}
    ],
    'egmo': [
      {label:'Power of a Point & Homothety (EGMO)', mins:20},
      {label:'Inversion basics (EGMO)', mins:20}
    ],
    'engel': [
      {label:'Combinatorial Arguments (Engel)', mins:20}
    ]
  };
  let proofCursor = 0;
  const proofLinearList = PROOF_BOOKS_SELECTED.flatMap(id=>PROOF_MODULE[id]||[]);
  function scheduleProofBlock(blockMinutes){
    if(!proofLinearList.length || blockMinutes<10) return [];
    const out=[]; let used=0;
    while(used+15<=blockMinutes && proofCursor<proofLinearList.length){
      const item = proofLinearList[proofCursor++ % proofLinearList.length];
      out.push({html:`üìó <b>Proof module</b>: ${item.label}. Write at least one full proof.`, mins:item.mins, type:'proof'});
      used += item.mins;
    }
    if(blockMinutes - used >= 10){
      const item = proofLinearList[proofCursor % proofLinearList.length];
      out.push({html:`üìó <b>Proof module</b>: ${item.label} (short set).`, mins:blockMinutes-used, type:'proof'});
    }
    return out;
  }

  // ---------- Study day composition ----------
  function baseMixForPhase(ph){ return (ph==='Foundation')?{read:0.65,drill:0.25,timed:0.10}:(ph==='Mixed')?{read:0.50,drill:0.35,timed:0.15}:{read:0.35,drill:0.35,timed:0.30}; }
  function adjustedMix(base,m){
    let br=0, tt=0, td=0; if(m<=30){br=0.20;tt=0.15;td=0.05}else if(m<=60){br=0.10;tt=0.06;td=0.04}
    let r=base.read+br, d=Math.max(0,base.drill-td), t=Math.max(0,base.timed-tt); const s=r+d+t||1; return {read:r/s, drill:d/s, timed:t/s};
  }
  function phaseNameForDay(d){ const totalDays = Math.ceil((end - start)/86400000); const f=Math.floor(totalDays*0.55), m=Math.floor(totalDays*0.85); return d<f?'Foundation':(d<m?'Mixed':'Final'); }

  const minutesPerDay = Number(input.minutesPerDay||60);
  const totalDays = days;

  const tasksByDay=[];
  for(let d=0; d<totalDays; d++){
    const phase = phaseNameForDay(d);

    // Final 3 days: full mock
    if(d >= totalDays-3){ tasksByDay.push([ makeMock(minutesPerDay) ]); continue; }

    // Weekly mocks in last ~30 days (about every 7 days)
    const daysLeft = totalDays - d;
    const inMockWindow = daysLeft <= 30 && daysLeft > 3;
    const isWeeklyMockDay = inMockWindow && ((daysLeft % 7) === 2);
    if(isWeeklyMockDay){ tasksByDay.push([ makeMock(minutesPerDay) ]); continue; }

    // Regular study
    const mix = adjustedMix(baseMixForPhase(phase), minutesPerDay);
    let mRead=Math.round(minutesPerDay*mix.read), mDrill=Math.round(minutesPerDay*mix.drill), mTimed=Math.max(0, minutesPerDay - mRead - mDrill);
    if(minutesPerDay >= THRESH.read && mRead < THRESH.read){
      let need = THRESH.read - mRead;
      const takeT = Math.min(need, mTimed); mTimed -= takeT; need -= takeT;
      const takeD = Math.min(need, mDrill); mDrill -= takeD; need -= need;
      mRead = Math.min(minutesPerDay, Math.max(mRead, THRESH.read));
      if(mRead + mDrill + mTimed > minutesPerDay){
        const diff = mRead + mDrill + mTimed - minutesPerDay;
        const t2 = Math.min(diff, mTimed); mTimed -= t2;
        const rem = diff - t2; if(rem>0) mDrill = Math.max(0, mDrill - rem);
      }
    }
    if(mRead<THRESH.read && mDrill<THRESH.drill && mTimed<THRESH.timed){ mRead = minutesPerDay; mDrill = 0; mTimed = 0; }

    const dayTasks=[];
    if(mRead > 0){ scheduleReadingUnified(phase, mRead).forEach(t=>dayTasks.push(t)); }
    if(PROOF_BOOKS_SELECTED.length){
      const proofShare = isUSAMOTrack ? 0.22 : (onAIMETrack ? 0.12 : 0.0);
      const proofBudget = Math.round(minutesPerDay * proofShare);
      if(proofBudget>0){
        const p = scheduleProofBlock(proofBudget);
        p.forEach(t=>dayTasks.push(t));
        mDrill = Math.max(0, mDrill - proofBudget);
      }
    }

    const todaysTopics = Array.from(new Set(dayTasks.map(t=>t._topic).filter(Boolean)));

    // Always add a POD
    const podMinutes = Math.max(6, Math.min(Math.max(mDrill, 6), minutesPerDay));
    dayTasks.push( makeProblemOfTheDay(podMinutes, todaysTopics, d) );

    // Timed practice if budget left
    if(mTimed>=THRESH.timed) dayTasks.push( makeTimedPractice(mTimed, todaysTopics, d) );

    balanceToQuota(dayTasks, minutesPerDay, phase, todaysTopics, d);
    tasksByDay.push(dayTasks);
  }

  function totalMins(arr){ return Math.round(arr.reduce((s,t)=>s+(t.mins||0),0)); }
  function balanceToQuota(arr, target, phaseName, prefTopics, dayIdx){
    let cur = totalMins(arr);
    if(Math.abs(cur - target) <= QUOTA_SLACK) return;

    if(cur < target){
      const gap = target - cur;
      const pod = arr.find(t=>t.type==='drill');
      if(pod){ pod.mins += gap; return; }
      arr.push(makeProblemOfTheDay(gap, prefTopics, dayIdx));
      return;
    }
    let over = cur - target;

    function shrinkPractice(idx, delta){
      const t = arr[idx];
      if(!t || (t.type!=='timed' && t.type!=='drill')) return 0;
      const minBlock = (t.type==='timed')?THRESH.timed:6;
      const newBlock = Math.max(minBlock, t.mins - delta);
      if(newBlock >= t.mins) return 0;
      const saved = t.mins - newBlock; t.mins = newBlock; return saved;
    }
    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){ over -= shrinkPractice(i, over) || 0; }
    if(over<=QUOTA_SLACK) return;

    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){
      const t=arr[i];
      if(t && t.type==='bookex'){
        const per = 8;
        const newBlock=Math.max(4, t.mins - over);
        if(newBlock < t.mins){ over -= (t.mins - newBlock); t.mins=newBlock; }
      }
    }
    if(over<=QUOTA_SLACK) return;

    for(let i=arr.length-1;i>=0 && over>QUOTA_SLACK;i--){
      const t=arr[i];
      if(t && (t.type==='reading' || t.type==='proof') && t.mins){
        const newBlock = Math.max(4, t.mins - over);
        if(newBlock < t.mins){ over -= (t.mins - newBlock); t.mins=newBlock; }
      }
    }
  }

  // ------------ Calendar rendering ------------
  const taskMap = new Map();
  for(let i=0;i<days;i++){
    const d = new Date(start.getTime()+i*86400000);
    const key = d.toISOString().slice(0,10);
    taskMap.set(key, tasksByDay[i]);
  }

  const months = buildMonthList(start, end); let monthIdx=0; renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick = ()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick = ()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};

  document.getElementById('downloadIcs').onclick = ()=>{
    const ics = buildICS(start, days, tasksByDay, Number(input.minutesPerDay), input);
    const blob = new Blob([ics], {type:'text/calendar'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t; localStorage.setItem('studyPlanInput', JSON.stringify(input)); location.href = 'timeline.html?v=rebuild';
  };

  function buildMonthList(startDate, endDate){
    const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }
  function renderOneMonth({year, month}){
    const cal = document.getElementById('calendar'); cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
      head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const today = new Date(); today.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=taskMap.get(key)||[];
      const inRange=(dateObj>=start && dateObj<=end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(dateObj.getTime()===today.getTime()) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){ tasks.forEach(t=>{ html += `<div class="task">${t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`; }); }
      box.innerHTML=html; grid.appendChild(box);
    }
    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${months.indexOf(months.find(m=>m.year===year&&m.month===month))+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  function buildICS(startDate, spanDays, tasks, minutes, meta){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }
})();
</script>
</body>
</html>
