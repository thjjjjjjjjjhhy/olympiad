<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Study Timeline - OlympiadPrep</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root { --fg:#111; --muted:#6b7280; --card:#fff; --accent:#0ea5e9; }
    body { background:#f6f9fc }
    .wrap { max-width:1100px; margin:0 auto; padding:16px }
    .cal { display:grid; grid-template-columns:repeat(7,1fr); gap:12px; }
    .day { background:#fff; border-radius:16px; padding:12px; box-shadow:0 1px 4px rgba(0,0,0,.06); min-height:150px; display:flex; flex-direction:column; }
    .day h4 { margin:0 0 8px; font-size:0.95rem; color:#111 }
    .item { margin:6px 0; line-height:1.35 }
    .item a { text-decoration:underline }
    .muted { color:var(--muted); }
    .nav { display:flex; justify-content:space-between; align-items:center; margin:12px 0; }
    .nav button { border:0; background:var(--accent); color:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer }
    .legend { margin:8px 0 16px; color:var(--muted); font-size:.92rem }
    .pill { display:inline-block; border:1px solid #e5e7eb; border-radius:999px; padding:2px 8px; margin-left:6px; color:#334155; font-size:.78rem }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <button id="prevBtn">‚Üê Previous month</button>
      <h2 id="title">Study Timeline</h2>
      <button id="nextBtn">Next month ‚Üí</button>
    </div>
    <div class="legend">
      The plan leans on <strong>AoPS Volume 1</strong> for AMC prep, <strong>AoPS Volume 2</strong> for AIME/USA(J)MO, and mixes in proof-writing from <strong>Velleman</strong>, <strong>Zeitz</strong>, <strong>Engel</strong>, and <strong>EGMO</strong> (with page numbers). Practice problems match the day‚Äôs topics.
      <span class="pill" id="goalPill"></span>
    </div>
    <div id="calendar" class="cal"></div>
    <div class="nav" style="margin-top:16px">
      <button id="prevBtn2">‚Üê Previous month</button>
      <div></div>
      <button id="nextBtn2">Next month ‚Üí</button>
    </div>
  </div>

  <script>
  // ---------- Past contest problem deep links (subset; expand as needed) ----------
  const AMC = {
    "2010-10A-9": "https://artofproblemsolving.com/wiki/index.php/2010_AMC_10A_Problems/Problem_9",
    "2014-10A-21": "https://artofproblemsolving.com/wiki/index.php/2014_AMC_10A_Problems/Problem_21",
    "2012-12A-15": "https://artofproblemsolving.com/wiki/index.php/2012_AMC_12A_Problems/Problem_15"
  };
  const AIME = {
    "2015-I-5": "https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_5",
    "2013-II-7": "https://artofproblemsolving.com/wiki/index.php/2013_AIME_II_Problems/Problem_7",
    "2011-I-9": "https://artofproblemsolving.com/wiki/index.php/2011_AIME_I_Problems/Problem_9"
  };

  // ---------- Proof books with chapter page ranges (by edition noted in the header) ----------
  const PROOF_BOOKS = {
    HTPI3e: { // Velleman
      short: "How to Prove It (Velleman, 3rd ed.)",
      chunks: [
        { id:"htpi-3.1-3.3", label:"Chapter 3 ¬ß3.1‚Äì3.3: Proof Strategies; Negations & Conditionals; Quantifiers", pages:"pp. 139‚Äì173" }, // start ~139; ¬ß3.3 ~172‚Äì173
        { id:"htpi-3.4-3.6", label:"Chapter 3 ¬ß3.4‚Äì3.6: Conjunctions; Disjunctions; Existence & Uniqueness", pages:"pp. 173‚Äì205" },  // shows 203‚Äì205 in viewer
        { id:"htpi-6.1-6.2", label:"Chapter 6 ¬ß6.1‚Äì6.2: Mathematical Induction (base & examples)", pages:"pp. 397‚Äì407" }
      ]
    },
    ZEITZ3e: {
      short: "Art & Craft of Problem Solving (Zeitz, 3rd ed.)",
      chunks: [
        { id:"zeitz-strategies", label:"Chapter 2: Strategies for Investigating Problems", pages:"pp. 12‚Äì57" },
        { id:"zeitz-tactics", label:"Chapter 3: Tactics for Solving Problems", pages:"pp. 58‚Äì104" },
        { id:"zeitz-crossover", label:"Chapter 4: Three Important Crossover Tactics", pages:"pp. 105‚Äì142" }
      ]
    },
    ENGEL: {
      short: "Problem-Solving Strategies (Engel)",
      chunks: [
        { id:"engel-invariance", label:"The Invariance Principle", pages:"pp. 1‚Äì24" },
        { id:"engel-pigeonhole", label:"The Box (Pigeonhole) Principle", pages:"pp. 59‚Äì84" },
        { id:"engel-inequalities", label:"Inequalities", pages:"pp. 161‚Äì204" },
        { id:"engel-funeq", label:"Functional Equations", pages:"pp. 271‚Äì288" }
      ]
    },
    EGMO: {
      short: "EGMO (Evan Chen)",
      chunks: [
        { id:"egmo-angle", label:"Chapter 1: Angle Chasing", pages:"pp. 3‚Äì22" },
        { id:"egmo-circles", label:"Chapter 2: Circles", pages:"pp. 23‚Äì42" },
        { id:"egmo-lengths", label:"Chapter 3: Lengths & Ratios", pages:"pp. 43‚Äì62" }
      ]
    }
  };

  // ---------- Helpers ----------
  const dayMs = 86400000;
  const topicOrder = ["Algebra","Number Theory","Geometry","Counting & Probability"];

  function loadInput(){
    try { return JSON.parse(localStorage.getItem('studyPlanInput')||"{}"); } catch { return {}; }
  }

  function daysBetween(aISO, bISO){
    const a = new Date(aISO), b = new Date(bISO);
    return Math.max(0, Math.round((b - a) / dayMs));
  }

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  function monthStart(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
  function monthEnd(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

  // Pack items to hit the daily ‚Äúminutes‚Äù target, but we DO NOT print minutes in the UI
  function packToMinutes(items, target){
    const out = [];
    let sum = 0;
    for(const it of items){
      if(sum >= target-3) break;
      out.push(it);
      sum += (it.mins||0);
    }
    // try to add more until within +15% if available
    for(const it of items.slice(out.length)){
      if(sum + (it.mins||0) <= Math.ceil(target*1.15)){
        out.push(it); sum += (it.mins||0);
      } else break;
    }
    return out;
  }

  // ---------- Build Plan ----------
  function buildPlan(input){
    const { goal="amc10", testDate, minutesPerDay=40, subscores={} } = input;
    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date(testDate); end.setHours(0,0,0,0);
    const totalDays = Math.max(1, Math.round((end - start)/dayMs)+1);

    // Emphasis: AMC ‚Üí Vol.1; AIME/USA(J)MO ‚Üí Vol.2 + proof books.
    const useVol2 = (goal === "aime" || goal === "usamo" || goal === "usajmo");

    // Phase split: learn early, practice later; when minutes are small, prioritize learning even more.
    const learnBias = minutesPerDay <= 35 ? 0.75 : 0.6;
    const learnDays = Math.max(1, Math.round(totalDays * learnBias));

    // Weakness targeting order from subscores
    const weakToStrong = [...topicOrder].sort((A,B)=>{
      const a = subscores[A]||{right:0,total:0};
      const b = subscores[B]||{right:0,total:0};
      const pa = a.total? (a.right/a.total) : 0;
      const pb = b.total? (b.right/b.total) : 0;
      return pa - pb; // weaker first
    });

    // Day templates (each produces many ‚Äúitems‚Äù with mins)
    function bookRead(vol, chapterLabel, pages, perPage=2){
      // perPage ~ minutes per page (hidden)
      const count = Math.max(1, Math.round(minutesPerDay / perPage / 8)); // chunk by ~8 pages
      const txt = `üìò ${vol}: ${chapterLabel} ‚Äî ${pages}`;
      return [{ type:"read", txt, mins: count*8*perPage }];
    }
    function bookExercises(vol, chapterLabel, pages, fromNo, toNo, perProb=5){
      const count = Math.max(2, Math.round(minutesPerDay / perProb / 4)); // chunk by ~4 probs
      const txt = `üß† Book exercises (${vol}, ${chapterLabel} ‚Äî ${pages}): Problems ${fromNo}‚Äì${toNo}`;
      return [{ type:"ex", txt, mins: count*4*perProb }];
    }
    function proofChunk(bookKey, chunkId, perPage=3){
      const book = PROOF_BOOKS[bookKey];
      const ch = book.chunks.find(c=>c.id===chunkId);
      if(!ch) return [];
      const txt = `‚úçÔ∏è ${book.short}: ${ch.label} ‚Äî ${ch.pages}`;
      // estimate minutes from pages span width
      const span = ch.pages.match(/(\d+)[^0-9]+(\d+)/);
      const pages = span ? Math.max(1, (parseInt(span[2])-parseInt(span[1])+1)) : 8;
      return [{ type:"proof", txt, mins: Math.round(pages*perPage*0.6) }]; // modest chunk
    }
    function contestProb(code, topic){
      const url = AMC[code] || AIME[code];
      return [{ type:"prob", txt:`üß© ${code.replaceAll('-', ' ')} (${topic})`, url, mins: 12 }];
    }

    // Topic ‚Üí representative AoPS chapters (labels & pages)
    const AoPS = useVol2 ? {
      "Algebra":       { vol:"Volume 2", ch:"¬ß6 Polynomials", pages:"pp. 52‚Äì65" },
      "Number Theory": { vol:"Volume 2", ch:"¬ß5 Number Theory Tidbits", pages:"pp. 41‚Äì51" },
      "Geometry":      { vol:"Volume 2", ch:"¬ß22 Geometry Tidbits (Inversion/Homothety)", pages:"pp. 241‚Äì247" },
      "Counting & Probability": { vol:"Volume 2", ch:"¬ß25.6 Colorings", pages:"p. 280" }
    } : {
      "Algebra":       { vol:"Volume 1", ch:"¬ß16 Sequences & Series", pages:"pp. 180‚Äì191" },
      "Number Theory": { vol:"Volume 1", ch:"¬ß5.6‚Äì5.7 Primes & Factors", pages:"pp. 47‚Äì48" },
      "Geometry":      { vol:"Volume 1", ch:"¬ß22 Right Triangle & Circles (selected)", pages:"pp. 260‚Äì268" },
      "Counting & Probability": { vol:"Volume 1", ch:"¬ß24‚Äì25 Counting & Intro Probability (selected)", pages:"pp. 197‚Äì217" }
    };

    // Proof study pool (used more for AIME/USA(J)MO)
    const proofPool = [
      ["HTPI3e","htpi-3.1-3.3"],["ZEITZ3e","zeitz-strategies"],
      ["ENGEL","engel-invariance"],["HTPI3e","htpi-3.4-3.6"],
      ["ZEITZ3e","zeitz-tactics"],["ENGEL","engel-pigeonhole"],
      ["HTPI3e","htpi-6.1-6.2"],["EGMO","egmo-angle"],
      ["ENGEL","engel-inequalities"],["EGMO","egmo-circles"],
      ["ENGEL","engel-funeq"],["EGMO","egmo-lengths"],
      ["ZEITZ3e","zeitz-crossover"]
    ];

    const days = [];
    let today = new Date(start);

    // Phase 1 ‚Äî learning (heavier AoPS + (for upper tracks) proof chunks)
    for(let d=0; d<learnDays; d++){
      const topic = weakToStrong[d % weakToStrong.length];
      const t = AoPS[topic];
      const items = [];
      items.push(...bookRead(t.vol, t.ch, t.pages, useVol2? 2.2 : 1.8));
      items.push(...bookExercises(t.vol, t.ch, t.pages, 1, 12, 5));
      if(useVol2 && d%2===0){
        // interleave proof chunk
        const pc = proofPool[(d/2) % proofPool.length];
        items.push(...proofChunk(pc[0], pc[1], 3));
      }
      days.push({ date: new Date(today), items: packToMinutes(items, minutesPerDay), topic });
      today = new Date(today.getTime()+dayMs);
    }

    // Phase 2 ‚Äî practice-heavy; still keep small review
    const remaining = totalDays - learnDays;
    for(let d=0; d<remaining; d++){
      const topic = weakToStrong[d % weakToStrong.length];
      const t = AoPS[topic];
      const items = [];
      // short refresher reading/exercise
      items.push(...bookRead(t.vol, t.ch, t.pages, useVol2? 2.5 : 2.0));
      items.push(...bookExercises(t.vol, t.ch, t.pages, 5, 16, 6));
      // add 2‚Äì3 past problems tightly matched
      const probs = [];
      if(!useVol2){
        if(topic==="Number Theory") probs.push("2010-10A-9");
        if(topic==="Algebra") probs.push("2012-12A-15");
        if(topic==="Counting & Probability") probs.push("2014-10A-21");
      }else{
        if(topic==="Number Theory") probs.push("2011-I-9","2015-I-5");
        if(topic==="Algebra") probs.push("2013-II-7","2015-I-5");
        if(topic==="Geometry") probs.push("2013-II-7");
      }
      probs.forEach(code => items.push(...contestProb(code, topic)));
      if(useVol2 && d%3===1){
        // periodic proof polish
        const pc = proofPool[(learnDays/2 + d) % proofPool.length];
        items.push(...proofChunk(pc[0], pc[1], 3));
      }
      days.push({ date: new Date(today), items: packToMinutes(items, minutesPerDay), topic });
      today = new Date(today.getTime()+dayMs);
    }

    // Edge suggestion: if scored extremely high/low, nudge to try other diagnostic (handled in planning page text)
    return { days, start, end, goal };
  }

  // ---------- Calendar rendering with month paging ----------
  let PLAN = null;
  let viewMonth = null; // Date at 1st of month currently viewed

  function renderCalendar(){
    const host = document.getElementById('calendar');
    host.innerHTML = '';
    const first = monthStart(viewMonth);
    const last = monthEnd(viewMonth);

    // Header title
    const title = document.getElementById('title');
    title.textContent = `${first.toLocaleString(undefined,{month:'long'})} ${first.getFullYear()} ‚Äî Study Timeline`;

    // Generate grid placeholders to align first weekday
    const prefix = (first.getDay()+6)%7; // Monday=0 if you prefer, adjust as needed
    for(let i=0;i<prefix;i++){ const div=document.createElement('div'); host.appendChild(div); }

    // Render each day in this month if within plan range
    for(let d=1; d<=last.getDate(); d++){
      const date = new Date(first.getFullYear(), first.getMonth(), d);
      const cell = document.createElement('div');
      cell.className = 'day';

      const label = document.createElement('h4');
      label.textContent = String(d);
      cell.appendChild(label);

      const dayObj = PLAN.days.find(x => sameDay(x.date, date));
      if(dayObj){
        // Show items (no minutes printed)
        dayObj.items.forEach(it=>{
          const p = document.createElement('div');
          p.className = 'item';
          if(it.url){
            p.innerHTML = `<a href="${it.url}" target="_blank" rel="noopener">${it.txt}</a>`;
          }else{
            p.textContent = it.txt;
          }
          cell.appendChild(p);
        });
      }else{
        const m = document.createElement('div');
        m.className = 'muted';
        m.textContent = 'No scheduled work';
        cell.appendChild(m);
      }

      host.appendChild(cell);
    }

    // Goal pill
    const pill = document.getElementById('goalPill');
    pill.textContent = (INPUT.goal||'').toUpperCase();
  }

  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  // Navigation
  function shiftMonth(delta){
    viewMonth = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+delta, 1);
    renderCalendar();
  }
  document.getElementById('prevBtn').onclick = ()=>shiftMonth(-1);
  document.getElementById('nextBtn').onclick = ()=>shiftMonth(1);
  document.getElementById('prevBtn2').onclick = ()=>shiftMonth(-1);
  document.getElementById('nextBtn2').onclick = ()=>shiftMonth(1);

  // ---------- Boot ----------
  const INPUT = loadInput();
  PLAN = buildPlan(INPUT);
  viewMonth = new Date(PLAN.start.getFullYear(), PLAN.start.getMonth(), 1);
  renderCalendar();
  </script>
</body>
</html>
