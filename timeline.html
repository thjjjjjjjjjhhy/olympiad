<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg);background:#f8fafc}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    header .logo{font-weight:800}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input, select{border:1px solid var(--grid);border-radius:10px;padding:8px 10px;background:#fff}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px;background:#fff}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:120px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.92rem;margin:4px 0;line-height:1.38}
    .task a{text-decoration:underline}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#eef2f7;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    .offday-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .offday-pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--grid);background:#fff;border-radius:999px;padding:6px 10px}
    .notice{border-left:4px solid var(--accent);background:#f0f9ff;padding:10px;border-radius:8px;margin:8px 0}
    .warn{border-left:4px solid #f59e0b;background:#fffbeb}
    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div id="editionNotice" class="notice warn" style="display:none">
      Exact page numbers are hidden for some books because no <b>Edition Pack</b> was found.
      You can add a JSON in <code>editions/&lt;bookId&gt;.json</code> to enable precise pages for your copy.
      (Sections and problem indices remain accurate by order.)
    </div>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <div class="offday-group">
        <b>Weekly off-days:</b>
        <label class="offday-pill"><input type="checkbox" value="1"> Mon</label>
        <label class="offday-pill"><input type="checkbox" value="2"> Tue</label>
        <label class="offday-pill"><input type="checkbox" value="3"> Wed</label>
        <label class="offday-pill"><input type="checkbox" value="4"> Thu</label>
        <label class="offday-pill"><input type="checkbox" value="5"> Fri</label>
        <label class="offday-pill"><input type="checkbox" value="6"> Sat</label>
        <label class="offday-pill"><input type="checkbox" value="0"> Sun</label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">We prioritize your selected books and weakest topics; final month emphasizes full mocks.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (selected books)</span>
      <span>üß† Book exercises (aligned to the reading section)</span>
      <span>üìó Proof module (if selected)</span>
      <span>üß© Problem of the day (last 20 years)</span>
      <span>üìù Full mock & review</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>

    <div id="advice" class="notice" style="display:none"></div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
/* ============================================================================
   DETERMINISTIC RNG (same inputs ‚Üí same plan)
============================================================================ */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
function cyrb53(str, seed=0){let h1=0xdeadbeef^seed,h2=0x41c6ce57^seed;for(let i=0;i<str.length;i++){const ch=str.charCodeAt(i);h1=Math.imul(h1^ch,2654435761);h2=Math.imul(h2^ch,1597334677);}h1=Math.imul(h1^(h1>>>16),2246822507)^Math.imul(h2^(h2>>>13),3266489909);h2=Math.imul(h2^(h2>>>16),2246822507)^Math.imul(h1^(h1>>>13),3266489909);return 4294967296*(2097151&(h2>>>0))+(h1>>>0);}

/* ============================================================================
   INPUT + SEED
============================================================================ */
const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
const planSummary=document.getElementById('planSummary');
const errBox=document.getElementById('errBox');

if(!input){
  planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
} else {
  const seedStr = JSON.stringify({g:input.goal,t:input.testDate,m:input.minutesPerDay,b:input.selectedBooks||[],s:input.subscores||{}});
  const seed = cyrb53(seedStr);
  Math.random = mulberry32(seed);
}

/* ============================================================================
   SMALL HELPERS
============================================================================ */
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function fmtDate(d){return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});}
function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function daysBetween(a,b){return Math.ceil((b-a)/86400000);}

/* ============================================================================
   PROBLEM OF THE DAY (last 20y; controlled difficulty)
============================================================================ */
(function(){
  function last20Years(latest){const start=latest-19,out=[];for(let y=start;y<=latest;y++) out.push(y); return out;}
  function amcURL(level,year,varn,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_AMC_${level}${varn}_Problems/Problem_${num}`;}
  function aimeURL(year,varn,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_AIME_${varn}_Problems/Problem_${num}`;}
  function usamoURL(year,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_USAMO_Problems/Problem_${num}`;}
  function usajmoURL(year,num){return `https://artofproblemsolving.com/wiki/index.php/${year}_USAJMO_Problems/Problem_${num}`;}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  function build(goal, latest){
    const yrs=last20Years(latest), out=[];
    if(goal==='amc10'||goal==='amc12'){
      const lvl=(goal==='amc10'?'10':'12'), V=['A','B'];
      for(const y of yrs){for(const v of V){for(let n=1;n<=20;n++){out.push({label:`${y} AMC ${lvl}${v} ‚Äî Problem ${n}`,url:amcURL(lvl,y,v,n),key:`AMC${lvl}-${y}-${v}-${n}`});}}}
    } else if(goal==='aime'){
      const V=['I','II']; for(const y of yrs){for(const v of V){for(let n=1;n<=13;n++){out.push({label:`${y} AIME ${v} ‚Äî Problem ${n}`,url:aimeURL(y,v,n),key:`AIME-${y}-${v}-${n}`});}}}
    } else { // usamo/usajmo
      for(const y of yrs){for(let n=1;n<=6;n++){ if(input.goal==='usamo') out.push({label:`${y} USAMO ‚Äî Problem ${n}`,url:usamoURL(y,n),key:`USAMO-${y}-${n}`}); else out.push({label:`${y} USAJMO ‚Äî Problem ${n}`,url:usajmoURL(y,n),key:`USAJMO-${y}-${n}`});}}
    }
    return shuffle(out);
  }

  const POTD = { _q:[], _used:new Set(),
    init(goal){ this._q = build(goal, new Date().getFullYear()); this._used.clear(); },
    next(){ while(this._q.length){const c=this._q.pop(); if(this._used.has(c.key)) continue; this._used.add(c.key); return c;} return null;}
  };
  window.__POTD = POTD;
})();

/* ============================================================================
   BOOK CONTENT (edition-agnostic sections; long enough for months)
   - Exact pages are merged later from optional Edition Packs: editions/<bookId>.json
   - Each unit carries: {chapter, secLabel, exStart, exCount, topic}
============================================================================ */
const BOOK_RATES = { V1:2.0, V2:2.7, INTRO:2.1, INT:2.6, PRECALC:2.5, OTHER:2.4, EGMO:2.8, PROOF:2.8 };
function mkSecs(topic, chapter, baseLabel, count, probsPer=6){ 
  const a=[]; for(let i=1;i<=count;i++){ a.push({ topic, chapter, secLabel:`${baseLabel} ${i}`, exStart: (i-1)*probsPer+1, exCount: probsPer }); }
  return a;
}
const BOOK_BANK = {
  'aops-v1': { id:'aops-v1', title:'AoPS Volume 1 (The Basics)', kind:'V1', topics:{
    'Polynomials and Algebra':[
      ...mkSecs('Polynomials and Algebra','Chapter 6: Quadratic Equations','Quadratics ‚Äî section',14,6),
      ...mkSecs('Polynomials and Algebra','Chapter 7: Exponents & Radicals','Exponents/Radicals ‚Äî section',12,6),
      ...mkSecs('Polynomials and Algebra','Chapter 8: Inequalities','Inequalities ‚Äî section',12,6)
    ],
    'Number Theory':[
      ...mkSecs('Number Theory','Chapter 5.4: Modular Arithmetic','Modular arithmetic ‚Äî section',8,6),
      ...mkSecs('Number Theory','Chapter 5.6‚Äì5.7: Primes & Factors','Primes/Factors ‚Äî section',10,6)
    ],
    'Geometry':[
      ...mkSecs('Geometry','Chapter 14‚Äì15: Angles & Area','Angle chase/Area ‚Äî section',12,6),
      ...mkSecs('Geometry','Chapter 18: 3D Geometry','3D geometry ‚Äî section',8,6)
    ],
    'Combinatorics':[
      ...mkSecs('Combinatorics','Chapter 25: Learning to Count','Counting basics ‚Äî section',12,6)
    ],
    'Probability':[
      ...mkSecs('Probability','Chapter 25: Probability via Counting','Probability ‚Äî section',12,6)
    ],
    'Functions':[
      ...mkSecs('Functions','Chapter 21: Functions','Functions ‚Äî section',8,6)
    ],
    'Sequences and Series':[
      ...mkSecs('Sequences and Series','Chapter 24: Sequences & Series','Sequences/Series ‚Äî section',8,6)
    ]
  }},
  'aops-v2': { id:'aops-v2', title:'AoPS Volume 2 (And Beyond)', kind:'V2', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Chapter 6: Polynomials','Polynomials ‚Äî section',14,6) ],
    'Number Theory':[ ...mkSecs('Number Theory','Chapter 23: Divisibility & Congruences','Divisibility ‚Äî section',12,6), ...mkSecs('Number Theory','Chapter 24: Diophantine Equations','Diophantine ‚Äî section',10,6) ],
    'Geometry':[ ...mkSecs('Geometry','Chapter 22: Inversion & Homothety','Inversion/Homothety ‚Äî section',10,6) ],
    'Combinatorics':[ ...mkSecs('Combinatorics','Chapter 15: Combinatorics & Binomial','Binomial/Combinatorics ‚Äî section',12,6), ...mkSecs('Combinatorics','Chapter 25.6: Colorings','Colorings ‚Äî section',6,4) ],
    'Probability':[ ...mkSecs('Probability','Chapter 15.5: Binomial Distributions','Distributions ‚Äî section',6,5) ],
    'Functions':[ ...mkSecs('Functions','Chapter 7: Functional Equations','Functional equations ‚Äî section',10,6) ],
    'Sequences and Series':[ ...mkSecs('Sequences and Series','Chapter 16: Sequences & Recurrences','Recurrences ‚Äî section',12,6) ]
  }},
  'prealgebra': { id:'prealgebra', title:'AoPS Prealgebra', kind:'INTRO', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Percents & Proportions','Ratios/Percents ‚Äî section',20,6) ]
  }},
  'intro-alg': { id:'intro-alg', title:'AoPS Introduction to Algebra', kind:'INTRO', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Linear Equations','Linear ‚Äî section',14,6), ...mkSecs('Polynomials and Algebra','Quadratics','Quadratics ‚Äî section',14,6) ],
    'Functions':[ ...mkSecs('Functions','Functions & Graphs','Functions ‚Äî section',10,6) ],
    'Sequences and Series':[ ...mkSecs('Sequences and Series','Sequences','Sequences ‚Äî section',10,6) ]
  }},
  'intro-cp': { id:'intro-cp', title:'AoPS Introduction to Counting & Probability', kind:'INTRO', topics:{
    'Combinatorics':[ ...mkSecs('Combinatorics','Counting Strategies','Counting ‚Äî section',12,6), ...mkSecs('Combinatorics','Combinations','Combinations ‚Äî section',10,6) ],
    'Probability':[ ...mkSecs('Probability','Basic Probability','Probability ‚Äî section',10,6) ]
  }},
  'intro-geo': { id:'intro-geo', title:'AoPS Introduction to Geometry', kind:'INTRO', topics:{
    'Geometry':[ ...mkSecs('Geometry','Triangles I','Triangles I ‚Äî section',12,6), ...mkSecs('Geometry','Area','Area ‚Äî section',10,6), ...mkSecs('Geometry','Circles & Polygons','Circles/Polygons ‚Äî section',12,6) ]
  }},
  'intro-nt': { id:'intro-nt', title:'AoPS Introduction to Number Theory', kind:'INTRO', topics:{
    'Number Theory':[ ...mkSecs('Number Theory','Divisibility','Divisibility ‚Äî section',12,6), ...mkSecs('Number Theory','Congruences','Congruences ‚Äî section',12,6), ...mkSecs('Number Theory','Primes','Primes ‚Äî section',10,6) ]
  }},
  'int-alg': { id:'int-alg', title:'AoPS Intermediate Algebra', kind:'INT', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Polynomials I','Polynomials I ‚Äî section',16,6), ...mkSecs('Polynomials and Algebra','Inequalities','Inequalities ‚Äî section',12,6) ],
    'Functions':[ ...mkSecs('Functions','Functional Equations','Functional equations ‚Äî section',12,6) ],
    'Sequences and Series':[ ...mkSecs('Sequences and Series','Series','Series ‚Äî section',12,6) ]
  }},
  'int-cp': { id:'int-cp', title:'AoPS Intermediate Counting & Probability', kind:'INT', topics:{
    'Combinatorics':[ ...mkSecs('Combinatorics','PIE & Applications','PIE ‚Äî section',12,6), ...mkSecs('Combinatorics','Recurrences','Recurrences ‚Äî section',10,6), ...mkSecs('Combinatorics','Generating Functions','GF ‚Äî section',10,6) ],
    'Probability':[ ...mkSecs('Probability','Expected Value','Expected value ‚Äî section',10,6), ...mkSecs('Probability','Markov/Conditional','Conditional ‚Äî section',10,6) ]
  }},
  'precalc': { id:'precalc', title:'AoPS Precalculus', kind:'PRECALC', topics:{
    'Functions':[ ...mkSecs('Functions','Functions & Inverses','Functions/Inverses ‚Äî section',12,6), ...mkSecs('Functions','Trigonometric Functions','Trigonometry ‚Äî section',12,6) ],
    'Sequences and Series':[ ...mkSecs('Sequences and Series','Recurrences','Recurrences ‚Äî section',12,6) ],
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Polynomial Behavior','Polynomial behavior ‚Äî section',10,6) ]
  }},
  'egmo': { id:'egmo', title:'EGMO ‚Äî Euclidean Geometry in Mathematical Olympiads', kind:'EGMO', topics:{
    'Geometry':[ ...mkSecs('Geometry','Power of a Point & Homothety','Similarity toolkit ‚Äî section',12,6), ...mkSecs('Geometry','Inversion','Inversion ‚Äî section',10,6), ...mkSecs('Geometry','Advanced Circle Geometry','Circle geometry ‚Äî section',10,6) ]
  }},
  'zeitz': { id:'zeitz', title:'The Art & Craft of Problem Solving (Zeitz)', kind:'OTHER', topics:{
    'Combinatorics':[ ...mkSecs('Combinatorics','Pigeonhole / Extremal / Invariant','Core strategies ‚Äî section',10,6) ],
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Algebraic Tactics','Algebra tactics ‚Äî section',10,6) ],
    'Number Theory':[ ...mkSecs('Number Theory','Congruences & Order','NT tactics ‚Äî section',10,6) ],
    'Geometry':[ ...mkSecs('Geometry','Transformations / Extremal','Geo tactics ‚Äî section',10,6) ]
  }},
  'velleman': { id:'velleman', title:'How to Prove It (Velleman)', kind:'PROOF', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Direct & Contrapositive Proofs','Direct/Contrapositive ‚Äî section',8,5) ],
    'Number Theory':[ ...mkSecs('Number Theory','Induction','Induction ‚Äî section',8,5) ],
    'Combinatorics':[ ...mkSecs('Combinatorics','Sets & Functions','Set proofs ‚Äî section',8,5) ],
    'Geometry':[ ...mkSecs('Geometry','Relations','Relations ‚Äî section',6,5) ]
  }},
  'engel': { id:'engel', title:'Problem-Solving Strategies (Engel)', kind:'PROOF', topics:{
    'Combinatorics':[ ...mkSecs('Combinatorics','Extremal Principle','Extremal ‚Äî section',10,5) ],
    'Number Theory':[ ...mkSecs('Number Theory','NT Strategies','NT strategies ‚Äî section',10,5) ],
    'Geometry':[ ...mkSecs('Geometry','Geometric Inequalities','Geo inequalities ‚Äî section',10,5) ]
  }},
  '104nt': { id:'104nt', title:'104 Number Theory Problems', kind:'OTHER', topics:{
    'Number Theory':[ ...mkSecs('Number Theory','Training Sets A','Training A ‚Äî set',12,8), ...mkSecs('Number Theory','Training Sets B','Training B ‚Äî set',12,8) ]
  }},
  'path-comb': { id:'path-comb', title:'A Path to Combinatorics', kind:'OTHER', topics:{
    'Combinatorics':[ ...mkSecs('Combinatorics','Counting Foundations','Counting foundations ‚Äî section',14,8) ]
  }},
  'cmms': { id:'cmms', title:'Competition Math for Middle School', kind:'INTRO', topics:{
    'Polynomials and Algebra':[ ...mkSecs('Polynomials and Algebra','Algebra Review','Algebra review ‚Äî section',10,6) ],
    'Number Theory':[ ...mkSecs('Number Theory','Number Theory Review','NT review ‚Äî section',10,6) ],
    'Combinatorics':[ ...mkSecs('Combinatorics','Counting Basics','Counting basics ‚Äî section',10,6) ],
    'Probability':[ ...mkSecs('Probability','Probability Basics','Probability basics ‚Äî section',10,6) ],
    'Geometry':[ ...mkSecs('Geometry','Geometry Review','Geometry review ‚Äî section',10,6) ]
  }}
};

/* ============================================================================
   PRACTICE BANK (compact; PotD adds breadth)
============================================================================ */
const CORE_BANK = {
  AMC10: [
    {contest:"AMC10",year:2016,variant:"A",number:16,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_16",minutes:12},
    {contest:"AMC10",year:2011,variant:"A",number:21,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_10A_Problems/Problem_21",minutes:13},
    {contest:"AMC10",year:2016,variant:"A",number:17,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10A_Problems/Problem_17",minutes:12},
    {contest:"AMC10",year:2013,variant:"A",number:19,topic:"Sequences and Series",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_10A_Problems/Problem_19",minutes:13},
    {contest:"AMC10",year:2016,variant:"B",number:18,topic:"Functions",url:"https://artofproblemsolving.com/wiki/index.php/2016_AMC_10B_Problems/Problem_18",minutes:12},
    {contest:"AMC10",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_10A_Problems/Problem_16",minutes:12}
  ],
  AMC12: [
    {contest:"AMC12",year:2018,variant:"B",number:22,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2018_AMC_12B_Problems/Problem_22",minutes:15},
    {contest:"AMC12",year:2013,variant:"B",number:22,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AMC_12B_Problems/Problem_22",minutes:16},
    {contest:"AMC12",year:2011,variant:"A",number:19,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_19",minutes:13},
    {contest:"AMC12",year:2011,variant:"A",number:20,topic:"Probability",url:"https://artofproblemsolving.com/wiki/index.php/2011_AMC_12A_Problems/Problem_20",minutes:14},
    {contest:"AMC12",year:2015,variant:"A",number:16,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AMC_12A_Problems/Problem_16",minutes:12}
  ],
  AIME: [
    {contest:"AIME",year:2016,variant:"II",number:6,topic:"Polynomials and Algebra",url:"https://artofproblemsolving.com/wiki/index.php/2016_AIME_II_Problems/Problem_6",minutes:18},
    {contest:"AIME",year:2015,variant:"I",number:1,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_1",minutes:14},
    {contest:"AIME",year:2019,variant:"I",number:4,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2019_AIME_I_Problems/Problem_4",minutes:18},
    {contest:"AIME",year:2015,variant:"I",number:4,topic:"Geometry",url:"https://artofproblemsolving.com/wiki/index.php/2015_AIME_I_Problems/Problem_4",minutes:16},
    {contest:"AIME",year:2013,variant:"I",number:11,topic:"Number Theory",url:"https://artofproblemsolving.com/wiki/index.php/2013_AIME_I_Problems/Problem_11",minutes:18},
    {contest:"AIME",year:2021,variant:"I",number:12,topic:"Combinatorics",url:"https://artofproblemsolving.com/wiki/index.php/2021_AIME_I_Problems/Problem_12",minutes:20}
  ]
};
function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }
function jmoSetURL(kind,y){ return `https://artofproblemsolving.com/wiki/index.php/${y}_${kind}_Problems`; }

/* ============================================================================
   INIT
============================================================================ */
(function init(){
  if(!input) return;

  const today=new Date(); today.setHours(0,0,0,0);
  const todayStr=today.toISOString().slice(0,10);
  document.getElementById('testDate').min=todayStr;

  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  // off-days from payload
  const offDays=(input.offDays&&Array.isArray(input.offDays))?input.offDays.map(Number):[];
  document.querySelectorAll('.offday-group input[type="checkbox"]').forEach(cb=>{
    cb.checked = offDays.includes(Number(cb.value));
  });

  const start=new Date(today);
  const end=new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays=Math.ceil((end-start)/86400000);
  const days=(Number.isFinite(rawDays)&&rawDays>0)?rawDays:14;

  planSummary.innerHTML = `Start: <b>${fmtDate(start)}</b> ‚Üí Test: <b>${fmtDate(end)}</b> ‚Ä¢ Window: <b>${days}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  window.__POTD.init(input.goal);

  // Load edition packs for selected books (optional)
  const selectedBooks=new Set(input.selectedBooks||[]);
  const packsToLoad=[...selectedBooks].filter(id=>BOOK_BANK[id]).map(id=>`editions/${id}.json`);
  loadEditionPacks(packsToLoad).then(packCount=>{
    if(packCount===0) document.getElementById('editionNotice').style.display='block';
    const plan=buildPlan(start,end,days);
    renderCalendar(start,end,plan);

    document.getElementById('downloadIcs').onclick=()=>{
      const ics=buildICS(start,plan,input);
      const blob=new Blob([ics],{type:'text/calendar'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
    document.getElementById('rebuildBtn').onclick=()=>{
      const m=Number(document.getElementById('mPerDay').value||0), t=document.getElementById('testDate').value;
      if(m<15||!t){ alert('Enter minutes per day (‚â• 15) and a future test date.'); return; }
      const offs=[...document.querySelectorAll('.offday-group input[type="checkbox"]:checked')].map(cb=>Number(cb.value));
      input.minutesPerDay=m; input.testDate=t; input.offDays=offs;
      localStorage.setItem('studyPlanInput', JSON.stringify(input));
      location.href='timeline.html?v=rebuild';
    };
  });
})();

async function loadEditionPacks(paths){
  let count=0;
  for(const p of paths){
    try{
      const r=await fetch(p,{cache:'no-store'});
      if(!r.ok) continue;
      const data=await r.json();
      // Merge pages into sections by order
      const bookId=data.id; const sections=data.sections||[];
      if(BOOK_BANK[bookId]){
        const byTopic=BOOK_BANK[bookId].topics;
        for(const t in byTopic){
          const arr=byTopic[t];
          for(let i=0;i<arr.length;i++){
            if(sections[i]){
              arr[i].pStart=sections[i].pStart;
              arr[i].pEnd=sections[i].pEnd;
              if(sections[i].exPageStart) arr[i].exPageStart=sections[i].exPageStart;
              if(sections[i].exPageEnd)   arr[i].exPageEnd  =sections[i].exPageEnd;
              if(sections[i].secLabel)    arr[i].secLabel   =sections[i].secLabel;
            }
          }
        }
        count++;
      }
    }catch(e){ /* ignore */ }
  }
  return count;
}

/* ============================================================================
   WEIGHTS
============================================================================ */
function topicWeightsFromDiagnostic(subs){
  const cats=['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Functions','Sequences and Series'];
  const w={}; cats.forEach(k=>w[k]=1.0);
  for(const k of cats){
    const r=(subs?.[k]?.right||0), t=(subs?.[k]?.total||0);
    const miss= t>0 ? (1-r/t) : 0.6;
    w[k]=0.6+1.2*miss;
  }
  const emphasis={
    amc10:{'Polynomials and Algebra':1.2,'Geometry':1.2,'Number Theory':1.0,'Combinatorics':1.0,'Probability':1.0,'Functions':0.9,'Sequences and Series':0.9},
    amc12:{'Polynomials and Algebra':1.25,'Geometry':1.2,'Number Theory':1.05,'Combinatorics':1.0,'Probability':1.0,'Functions':1.0,'Sequences and Series':1.0},
    aime:{'Polynomials and Algebra':1.25,'Number Theory':1.2,'Combinatorics':1.15,'Geometry':1.1,'Probability':1.05,'Functions':1.0,'Sequences and Series':1.0},
    usamo:{'Number Theory':1.2,'Geometry':1.2,'Combinatorics':1.15,'Polynomials and Algebra':1.1,'Functions':1.0,'Sequences and Series':1.0,'Probability':0.95},
    usajmo:{'Number Theory':1.2,'Geometry':1.2,'Combinatorics':1.15,'Polynomials and Algebra':1.1,'Functions':1.0,'Sequences and Series':1.0,'Probability':0.95}
  }[input.goal||'amc12']||{};
  for(const k in w){ w[k]*=(emphasis[k]||1.0); }
  return w;
}

/* ============================================================================
   SCHEDULER
============================================================================ */
function buildPlan(start, end, totalDays){
  const minutesPerDay=Number(input.minutesPerDay||60);
  const selectedBooks=new Set(input.selectedBooks||[]);
  const offDays=(input.offDays||[]).map(Number);
  const weights=topicWeightsFromDiagnostic(input.subscores||{});
  const topics=Object.keys(weights);

  // Build content index from selected books (fallback if none)
  const CONTENT={};
  selectedBooks.forEach(id=>{ if(BOOK_BANK[id]) CONTENT[id]=BOOK_BANK[id]; });
  if(Object.keys(CONTENT).length===0){
    if(input.goal==='aime'||input.goal==='usamo'||input.goal==='usajmo') CONTENT['aops-v2']=BOOK_BANK['aops-v2'];
    else CONTENT['aops-v1']=BOOK_BANK['aops-v1'];
  }

  // Progress cursors per (book, topic, section)
  const prog = {}; // key book|topic -> {sIdx:number}
  function K(bookId, topic){return `${bookId}|${topic}`;}

  function minutesPerSection(kind){ // average minutes per section read
    const base=(BOOK_RATES[kind]||2.5);
    return Math.round( base*4 + 6 ); // ~ 14‚Äì18m per slice
  }

  function pickTopic(){
    const sum=topics.reduce((s,k)=>s+(weights[k]||0),0);
    let r=Math.random()*sum;
    for(const k of topics){ r-= (weights[k]||0); if(r<=0) return k; }
    return topics[0];
  }

  function hasAnyReadingLeft(){
    for(const bid in CONTENT){
      const book=CONTENT[bid];
      for(const topic in book.topics){
        const arr=book.topics[topic];
        const key=K(bid,topic);
        const pos=(prog[key]?.sIdx||0);
        if(pos < arr.length) return true;
      }
    }
    return false;
  }

  function nextReadingSection(preferredTopic, maxSlices){
    const tryTopics=[];
    if(preferredTopic) tryTopics.push(preferredTopic);
    const sorted=[...topics].sort((a,b)=>(weights[b]||0)-(weights[a]||0));
    for(const t of sorted){ if(!tryTopics.includes(t)) tryTopics.push(t); }

    for(const t of tryTopics){
      for(const bid in CONTENT){
        const book=CONTENT[bid]; const arr=book.topics?.[t]||[]; if(!arr.length) continue;
        const key=K(bid,t); const pos=(prog[key]?.sIdx||0);
        if(pos >= arr.length) continue;
        // pack up to maxSlices adjacent sections into one reading block
        const take=clamp(maxSlices,1, arr.length-pos);
        const slice=arr.slice(pos, pos+take);
        prog[key]={sIdx:pos+take};
        const first=slice[0], last=slice[slice.length-1];
        const label = (slice.length===1) ? `${first.chapter} ‚Äî ${first.secLabel}` : `${first.chapter} ‚Äî ${first.secLabel} ‚Ä¶ ${last.secLabel}`;
        const pages = (first.pStart && last.pEnd) ? ` (pages ${first.pStart}‚Äì${last.pEnd})` : '';
        const mins = slice.reduce((m,s)=> m + minutesPerSection(book.kind), 0);
        return {html:`üìò <b>${t}</b>: ${book.title}, ${label}${pages}`, mins, type:'reading', _topic:t, _book:book, _units:slice};
      }
    }
    return null;
  }

  function exercisesForSectionBlock(block, wantMins){
    // align to last unit in the block
    const unit = block._units[block._units.length-1];
    const book = block._book;
    const per = (book.kind==='V1'||book.kind==='INTRO')?6.0: (book.kind==='EGMO'||book.kind==='PROOF')?9.0 : 8.0;
    const cnt = Math.max(1, Math.floor((wantMins + 0.25*per)/per));
    unit._exCursor = unit._exCursor || unit.exStart;
    const start = unit._exCursor;
    const end = start + cnt - 1;
    unit._exCursor = end + 1;
    const rangeText = (start===end) ? `Exercise ${start}` : `Exercises ${start}‚Äì${end}`;
    const exPages = (unit.exPageStart && unit.exPageEnd) ? ` (pages ${unit.exPageStart}‚Äì${unit.exPageEnd})` : '';
    const used = Math.round(cnt*per);
    return {html:`üß† <b>Book exercises</b> (${book.title}, ${unit.chapter}, ${unit.secLabel}): ${rangeText}${exPages}`, mins:used, type:'bookex', _topic:block._topic};
  }

  // Practice selection
  const usedPractice=new Set();
  function topicPractice(blockMinutes, preferredTopics){
    const level=(input.goal==='amc10')?'AMC10':(input.goal==='amc12')?'AMC12':'AIME';
    const per=(input.goal==='aime'||input.goal==='usamo'||input.goal==='usajmo')?16:10;
    const target=Math.max(1, Math.floor((blockMinutes + 0.25*per)/per));
    const chosen=[];
    const tList = preferredTopics && preferredTopics.length ? preferredTopics : Object.keys(weights);
    for(const topic of tList){
      const pool=(CORE_BANK[level]||[]).filter(p=>p.topic===topic);
      for(const p of pool){
        const id=`${p.contest}-${p.year}-${p.variant}-${p.number}`;
        if(usedPractice.has(id)) continue;
        chosen.push(p); usedPractice.add(id);
        if(chosen.length>=target) break;
      }
      if(chosen.length>=target) break;
    }
    if(chosen.length<target){
      for(const p of (CORE_BANK[level]||[])){
        const id=`${p.contest}-${p.year}-${p.variant}-${p.number}`;
        if(usedPractice.has(id)) continue;
        chosen.push(p); usedPractice.add(id);
        if(chosen.length>=target) break;
      }
    }
    if(!chosen.length) return null;
    const list = chosen.map(p=>`<a href="${p.url}" target="_blank" rel="noopener">${p.year} ${p.contest}${p.contest==='AIME'?' '+p.variant:' '+p.variant} Problem ${p.number}</a>`).join(', ');
    return {html:`üß© Topic-matched set: ${list}`, mins:blockMinutes, type:'drill'};
  }

  // Proof module
  const proofIDs=['velleman','zeitz','engel','egmo'].filter(id=>selectedBooks.has(id));
  const proofPool=[];
  if(proofIDs.length){
    proofIDs.forEach(id=>{
      const bk=BOOK_BANK[id]; if(!bk) return;
      for(const t in bk.topics){ for(const u of bk.topics[t]) proofPool.push({book:bk, unit:u}); }
    });
  }
  let proofIdx=0;
  function proofBlock(blockMinutes){
    if(!proofPool.length || blockMinutes<12) return [];
    const out=[]; let used=0;
    while(used+18<=blockMinutes && proofIdx<proofPool.length){
      const item=proofPool[proofIdx++];
      out.push({html:`üìó <b>Proof module</b>: ${item.book.title}, ${item.unit.chapter} ‚Äî ${item.unit.secLabel}. Write at least one full proof from this section.`, mins:18, type:'proof'});
      used+=18;
    }
    return out;
  }

  // Build day list with off-days
  const dayRows=[];
  for(let i=0;i<totalDays;i++){
    const d=new Date(start.getTime()+i*86400000);
    dayRows.push({date:d, off: offDays.includes(d.getDay()), tasks:[]});
  }

  // Phase logic
  const fCut=Math.floor(dayRows.length*0.55), mCut=Math.floor(dayRows.length*0.85);
  function phaseAt(i){ return (i<fCut)?'Foundation':(i<mCut?'Mixed':'Final'); }

  function shouldMock(date){
    const daysToTest=daysBetween(date,end);
    if(daysToTest>30) return false;
    const wd=date.getDay();
    const boost=minutesPerDay>=90;
    if(input.goal==='aime' || input.goal==='usamo' || input.goal==='usajmo'){
      return (wd===2||wd===4||wd===6||(boost&&wd===0));
    } else {
      return (wd===2||wd===5||(boost&&wd===0)||(boost&&wd===6));
    }
  }
  const usedMocks=new Set();
  function makeMock(totalMinutes){
    if(input.goal==='aime'){
      const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i), V=['I','II'];
      for(let k=0;k<40;k++){ const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)], id=`AIME-${y}-${v}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${aimeSetURL(y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AIME ${v} (15 problems). Review thoroughly.</a>`, mins:totalMinutes, type:'mock'}; }
    } else if(input.goal==='usamo'||input.goal==='usajmo'){
      const kind=(input.goal==='usamo')?'USAMO':'USAJMO'; const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i);
      for(let k=0;k<20;k++){ const y=years[Math.floor(Math.random()*years.length)], id=`${kind}-${y}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${jmoSetURL(kind,y)}" target="_blank" rel="noopener">üìù Full mock: ${y} ${kind}. Spend 2√ó time on write-ups.</a>`, mins:totalMinutes, type:'mock'}; }
    } else {
      const years=[...Array(20)].map((_,i)=>new Date().getFullYear()-i), V=['A','B']; const lv=(input.goal==='amc10')?'10':'12';
      for(let k=0;k<40;k++){ const y=years[Math.floor(Math.random()*years.length)], v=V[Math.floor(Math.random()*V.length)], id=`AMC${lv}-${y}-${v}`; if(usedMocks.has(id)) continue; usedMocks.add(id); return {html:`<a href="${amcSetURL(lv,y,v)}" target="_blank" rel="noopener">üìù Full mock: ${y} AMC ${lv}${v}. Review error log.</a>`, mins:totalMinutes, type:'mock'}; }
    }
    return {html:`üìù Full mock & review`, mins:totalMinutes, type:'mock'};
  }

  function baseMixForPhase(ph){
    if(ph==='Foundation') return {read:0.55, ex:0.30, practice:0.15, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.10:0.00};
    if(ph==='Mixed')      return {read:0.45, ex:0.30, practice:0.25, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.12:0.00};
    return                  {read:0.35, ex:0.25, practice:0.40, proof:(input.goal==='usamo'||input.goal==='usajmo')?0.12:0.00};
  }
  function adjustedMix(base,m){
    const adj=(m<=35)?{r:+0.08, p:-0.05}:{r:0,p:0};
    let r=base.read+adj.r, e=base.ex, p=Math.max(0,base.practice+adj.p), pr=base.proof;
    const s=r+e+p+pr; r/=s; e/=s; p/=s; pr/=s; return {read:r,ex:e,practice:p,proof:pr};
  }

  const tasksByDay=[];
  for(let i=0;i<dayRows.length;i++){
    const row=dayRows[i]; const d=row.date; const list=[];
    if(row.off){ tasksByDay.push(list); continue; }

    const phase=phaseAt(i);
    if(shouldMock(d)){ list.push(makeMock(minutesPerDay)); // PotD also appears on mock days
      const potd=window.__POTD.next(); if(potd){list.push({html:`üß© <b>Problem of the day</b>: <a href="${potd.url}" target="_blank" rel="noopener">${potd.label}</a>`, mins:0, type:'potd'});}
      tasksByDay.push(list); continue; }

    const mix=adjustedMix(baseMixForPhase(phase), minutesPerDay);
    let mRead=Math.round(minutesPerDay*mix.read),
        mEx  =Math.round(minutesPerDay*mix.ex),
        mPrac=Math.round(minutesPerDay*mix.practice),
        mProof=Math.round(minutesPerDay*mix.proof);

    // Reading: pack multiple short sections if budget is large
    const slicesWanted = Math.max(1, Math.floor(mRead / minutesPerSection('V1')));
    let block = nextReadingSection(pickTopic(), slicesWanted);
    if(!block) block = nextReadingSection(null, slicesWanted);
    if(block){ list.push(block); }

    // If somehow no reading but content remains, force a 1-slice read
    if(!block && hasAnyReadingLeft()){
      const force=nextReadingSection(null, 1);
      if(force){ list.push(force); }
    }

    // Exercises aligned to the reading
    if(mEx>=6){
      const rd=list.find(x=>x.type==='reading');
      if(rd){ const ex=exercisesForSectionBlock(rd, mEx); list.push(ex); }
    }

    // Proof block
    if(mProof>0){
      const pf=proofBlock(mProof); pf.forEach(x=>list.push(x));
    }

    // Practice (match today's topics if possible)
    if(mPrac>=8){
      const todaysTopics=list.filter(x=>x._topic).map(x=>x._topic);
      const uniq=Array.from(new Set(todaysTopics));
      const pr=topicPractice(mPrac, uniq);
      if(pr) list.push(pr);
    }

    // PotD every study day
    const potd=window.__POTD.next(); if(potd){list.push({html:`üß© <b>Problem of the day</b>: <a href="${potd.url}" target="_blank" rel="noopener">${potd.label}</a>`, mins:0, type:'potd'});}

    // Final safeguard: if list is still empty, add a read now
    if(list.length===0 && hasAnyReadingLeft()){
      const back=nextReadingSection(null, 1); if(back) list.push(back);
    }

    tasksByDay.push(list);
  }

  const subs=input.subscores||{}; const R=Object.values(subs).reduce((s,x)=>s+(x.right||0),0);
  const T=Object.values(subs).reduce((s,x)=>s+(x.total||0),0); const pct=T?Math.round(100*R/T):50;
  if(pct<=35 && minutesPerDay<=40){
    const adv=document.getElementById('advice');
    adv.style.display='block';
    adv.innerHTML=`You scored about <b>${pct}%</b> with limited daily time. We biased your plan toward reading/learning (and proof-writing if selected). Consider targeting <b>45‚Äì60</b> minutes to accelerate progress.`;
  }

  // Map for calendar
  const map=new Map(); for(let i=0;i<dayRows.length;i++){ const key=dayRows[i].date.toISOString().slice(0,10); map.set(key, tasksByDay[i]); }
  return {map, tasksByDay, start, end};
}

/* ============================================================================
   CALENDAR RENDER
============================================================================ */
function renderCalendar(start, end, plan){
  const cal=document.getElementById('calendar'); cal.innerHTML='';
  const months=buildMonthList(start,end); let monthIdx=0;

  function buildMonthList(startDate,endDate){
    const out=[]; let cur=new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last=new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur=new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }

  function renderOneMonth({year,month}){
    cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header=new Date(year,month,1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f3f4f6';
      head.innerHTML=`<div class="date" style="opacity:.75">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const today=new Date(); today.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=dateObj.toISOString().slice(0,10); const tasks=plan.map.get(key)||[];
      const inRange=(dateObj>=plan.start && dateObj<=plan.end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(sameDay(dateObj,today)) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){
        tasks.forEach(t=>{
          html += `<div class="task">${ t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`;
        });
      }
      box.innerHTML=html; grid.appendChild(box);
    }

    cal.appendChild(wrap);
    document.getElementById('monthLabel').innerText = `Month ${months.indexOf(months.find(m=>m.year===year&&m.month===month))+1} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(monthIdx===0);
    document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
  }

  renderOneMonth(months[monthIdx]);
  document.getElementById('prevMonth').onclick=()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
  document.getElementById('nextMonth').onclick=()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};
}

/* ============================================================================
   ICS EXPORT
============================================================================ */
function buildICS(startDate, plan, meta){
  function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()+0).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
  const tasksByDay=plan.tasksByDay; const minutes=Number(input.minutesPerDay);
  for(let i=0;i<tasksByDay.length;i++){
    const day=new Date(startDate.getTime()+i*86400000); const items=tasksByDay[i]||[]; if(!items.length) continue;
    const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
    const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
    lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
  }
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
</script>

</body>
</html>
