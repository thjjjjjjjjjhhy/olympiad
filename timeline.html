<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    .hint{color:var(--muted);font-size:.92rem}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{cursor:pointer;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:110px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.86rem;margin:2px 0;line-height:1.25}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    @media print{.site-header,.toolbar{display:none!important}.month{break-inside:avoid}.card{box-shadow:none;border:1px solid var(--grid)}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes/day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:100px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download .ics</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">Weak topics first; final days emphasize timed sets & full mocks.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (AoPS Vol 1/2)</span>
      <span>üß© Targeted drills (exact problems)</span>
      <span>‚è±Ô∏è Timed set (specific problems)</span>
      <span>üìù Full mock + review</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(function(){
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){ planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.'; return; }

  // Guard the date picker to future dates
  const todayStr = new Date().toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;

  // Fill toolbar
  document.getElementById('mPerDay').value = input.minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  // Compute window
  const start = new Date(); start.setHours(0,0,0,0);
  const end = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  // Fallback: if end<=today (or NaN), build a 14-day plan
  const days = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 14;

  const goalToTestName = {A:'AMC 10/12 (Test A)', B:'AIME bridge (Test B)', C:'US(A)JMO-leaning (Test C)'};
  planSummary.innerHTML = `Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Track: <b>${goalToTestName[input.testId]||input.testId}</b> ‚Ä¢ Window: <b>${days}</b> day(s) ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  // Weights from subscores (weak first)
  const subs = input.subscores||{};
  const cats = Object.keys(subs); if(!cats.length) cats.push('Polynomials & Algebra','Number Theory','Geometry','Combinatorics','Sequences & Series','Functions','Probability');
  const weights={}; cats.forEach(k=>{const r=(subs[k]?.right||0), t=(subs[k]?.total||1); weights[k]=1 - r/t + 0.05});

  // Reading map (Ch. instead of ¬ß)
  const READS = {
    "Number Theory":[
      {ref:"Vol.1 Ch.5.4 Modular Arithmetic (pp. 42‚Äì45)"},
      {ref:"Vol.1 Ch.5.6‚Äì5.7 Primes & Factors (pp. 47‚Äì48)"},
      {ref:"Vol.2 Ch.23 Divisibility & Congruences (pp. 252‚Äì262)"},
      {ref:"Vol.2 Ch.24 Diophantine Equations (pp. 266‚Äì274)"},
    ],
    "Combinatorics":[
      {ref:"Vol.1 Ch.25 Learning to Count (pp. 221‚Äì229)"},
      {ref:"Vol.2 Ch.15 Combinatorics & Binomial (pp. 170‚Äì176)"},
      {ref:"Vol.2 Ch.25.6 Colorings (p. 280)"},
    ],
    "Probability":[
      {ref:"Vol.1 Ch.25 Counting (probability foundation) (pp. 221‚Äì229)"},
      {ref:"Vol.2 Ch.15.5 Binomial Theorem for distributions (p. 175)"},
    ],
    "Sequences & Series":[
      {ref:"Vol.1 Ch.24 Sequences & Series (pp. 211‚Äì217)"},
      {ref:"Vol.2 Ch.16 Sequences/Recurrences (pp. 180‚Äì191)"},
    ],
    "Functions":[
      {ref:"Vol.1 Ch.21 Functions (pp. 187‚Äì190)"},
      {ref:"Vol.2 Ch.7 Functional Equations (pp. 69‚Äì73)"},
    ],
    "Polynomials & Algebra":[
      {ref:"Vol.1 Ch.6 Quadratic Equations (pp. 52‚Äì60)"},
      {ref:"Vol.2 Ch.6 Polynomials (pp. 52‚Äì65)"},
    ],
    "Geometry":[
      {ref:"Vol.1 Ch.11.8 Area of a Triangle (p. 109)"},
      {ref:"Vol.1 Ch.14 Angle Chasing (p. 133) & Ch.15 Area (pp. 136‚Äì138)"},
      {ref:"Vol.1 Ch.18 3D Geometry (pp. 165‚Äì169)"},
      {ref:"Vol.2 Ch.22 Geometry Tidbits: Inversion/Homothety (pp. 241‚Äì247)"},
    ],
  };

  // Weighted pick helper
  function pickTopic(){
    const sum=Object.values(weights).reduce((a,b)=>a+b,0);
    let r=Math.random()*sum;
    for(const [k,w] of Object.entries(weights)){ r-=w; if(r<=0) return k; }
    return cats[0];
  }
  function nextReading(cat){
    const arr=READS[cat]||[]; if(!arr.length) return null;
    return arr[Math.floor(Math.random()*arr.length)].ref;
  }

  // AoPS URL builders (exact problems)
  function aimeProblemURL(y,v,n){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems/Problem_${n}`; }
  function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
  function amcProblemURL(level,y,v,n){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems/Problem_${n}`; }
  function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }

  const YEARS_AIME = Array.from({length:20},(_,i)=>2004+i);   // 2004‚Äì2023
  const YEARS_AMC  = Array.from({length:18},(_,i)=>2006+i);   // 2006‚Äì2023
  const VARIANTS   = ['A','B'];
  const VAI        = ['I','II'];

  const minutesPerDay = Number(input.minutesPerDay||60);
  const totalDays = days;
  const phases = [
    {name:"Foundation", start:0, end:Math.floor(totalDays*0.55), mix:{read:0.6, drill:0.3, timed:0.1}},
    {name:"Mixed",      start:Math.floor(totalDays*0.55), end:Math.floor(totalDays*0.85), mix:{read:0.35, drill:0.4, timed:0.25}},
    {name:"Final",      start:Math.floor(totalDays*0.85), end:totalDays, mix:{read:0.15, drill:0.35, timed:0.5}},
  ];

  const onAIMETrack = (input.testId!=='A');
  const amcLevel = (input.goal==='amc10')?'10':'12';
  function rnd(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // NEW: lower thresholds + fallback allocator to guarantee tasks
  const THRESH = {read:10, drill:10, timed:8};

  function chooseAIMEProblems(count, phaseName){
    let low=1, high=15;
    if(phaseName==='Foundation'){ low=1;  high=7; }
    else if(phaseName==='Mixed'){ low=4;  high=12; }
    else { low=6; high=15; }
    const set=new Set();
    while(set.size<count){ set.add(Math.floor(Math.random()*(high-low+1))+low); }
    return [...set].sort((a,b)=>a-b);
  }
  function chooseAMCProblems(level,count,phaseName){
    const ranges = level==='10'
      ? {Foundation:[8,18], Mixed:[12,22], Final:[15,25]}
      : {Foundation:[10,18], Mixed:[12,22], Final:[15,25]};
    const [low,high]=ranges[phaseName]||[10,22];
    const set=new Set();
    while(set.size<count){ set.add(Math.floor(Math.random()*(high-low+1))+low); }
    return [...set].sort((a,b)=>a-b);
  }

  function makeDrillLinks(phase){
    if(onAIMETrack){
      const y=rnd(YEARS_AIME), v=rnd(VAI);
      const nums=chooseAIMEProblems(Math.max(2,Math.round(minutesPerDay/12)), phase.name);
      return nums.map(n=>`<a href="${aimeProblemURL(y,v,n)}" target="_blank" rel="noopener">${y} AIME ${v} #${n}</a>`);
    } else {
      const y=rnd(YEARS_AMC), v=rnd(VARIANTS);
      const nums=chooseAMCProblems(amcLevel, Math.max(3,Math.round(minutesPerDay/10)), phase.name);
      return nums.map(n=>`<a href="${amcProblemURL(amcLevel,y,v,n)}" target="_blank" rel="noopener">${y} AMC ${amcLevel}${v} #${n}</a>`);
    }
  }

  function makeTimedSet(phase){
    if(onAIMETrack){
      const y=rnd(YEARS_AIME), v=rnd(VAI);
      const nums=chooseAIMEProblems(Math.max(3,Math.round(minutesPerDay/15)), phase.name);
      return `‚è±Ô∏è Timed: ${nums.map(n=>`<a href="${aimeProblemURL(y,v,n)}" target="_blank" rel="noopener">${y} AIME ${v} #${n}</a>`).join(', ')}`;
    } else {
      const y=rnd(YEARS_AMC), v=rnd(VARIANTS);
      const nums=chooseAMCProblems(amcLevel, Math.max(4,Math.round(minutesPerDay/12)), phase.name);
      return `‚è±Ô∏è Timed: ${nums.map(n=>`<a href="${amcProblemURL(amcLevel,y,v,n)}" target="_blank" rel="noopener">${y} AMC ${amcLevel}${v} #${n}</a>`).join(', ')}`;
    }
  }

  function makeMock(){
    if(onAIMETrack){ const y=rnd(YEARS_AIME), v=rnd(VAI); return {text:`üìù Full mock: ${y} AIME ${v} (15Q). Review & error log.`, href:aimeSetURL(y,v)}; }
    const y=rnd(YEARS_AMC), v=rnd(VARIANTS); return {text:`üìù Full mock: ${y} AMC ${amcLevel}${v}. Review & error log.`, href:amcSetURL(amcLevel,y,v)};
  }

  // Build tasks
  const tasksByDay=[];
  for(let d=0; d<totalDays; d++){
    const phase = phases.find(p=>d>=p.start && d<p.end) || phases[2];
    let mRead=Math.round(minutesPerDay*phase.mix.read);
    let mDrill=Math.round(minutesPerDay*phase.mix.drill);
    let mTimed=Math.max(0, minutesPerDay - mRead - mDrill);

    // Guarantee at least one actionable block
    if(mRead<THRESH.read && mDrill<THRESH.drill && mTimed<THRESH.timed){
      // collapse all minutes into one useful block (prefer drills for AIME track, reading for AMC track)
      if(onAIMETrack){ mDrill=minutesPerDay; mRead=0; mTimed=0; }
      else{ mRead=minutesPerDay; mDrill=0; mTimed=0; }
    }

    const dayTasks=[];
    if(mRead>=THRESH.read){
      const cat=pickTopic(), ref=nextReading(cat);
      if(ref) dayTasks.push({html:`üìò <b>${cat}</b>: ${ref} (${mRead}m)`});
    }
    if(mDrill>=THRESH.drill){
      const cat=pickTopic(), links=makeDrillLinks(phase);
      dayTasks.push({html:`üß© <b>${cat}</b>: ${links.join(', ')} (${mDrill}m)`});
    }
    if(d>=totalDays-3){
      const mock=makeMock();
      dayTasks.push({html:`<a href="${mock.href}" target="_blank" rel="noopener">${mock.text}</a>`});
    } else if(mTimed>=THRESH.timed){
      dayTasks.push({html: makeTimedSet(phase)+` (${mTimed}m)`});
    }

    // Absolute fallback: if still empty, add a tiny drill
    if(!dayTasks.length){
      const cat=pickTopic(), links=makeDrillLinks(phase);
      dayTasks.push({html:`üß© <b>${cat}</b>: ${links.slice(0,2).join(', ')} (${minutesPerDay}m)`});
    }

    tasksByDay.push(dayTasks);
  }

  renderCalendar(start,totalDays,tasksByDay);

  // ICS
  document.getElementById('downloadIcs').onclick=()=>{
    const ics=buildICS(start,totalDays,tasksByDay,minutesPerDay,input);
    const blob=new Blob([ics],{type:'text/calendar'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  // Rebuild
  document.getElementById('rebuildBtn').onclick=()=>{
    const m=Number(document.getElementById('mPerDay').value||0);
    const t=document.getElementById('testDate').value;
    if(m<15||!t){ alert('Enter minutes/day (‚â•15) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t;
    localStorage.setItem('studyPlanInput', JSON.stringify(input));
    location.reload();
  };

  // Render helpers
  function renderCalendar(startDate, spanDays, tasks){
    const cal=document.getElementById('calendar'); cal.innerHTML='';
    const today=new Date(); today.setHours(0,0,0,0);
    const groups={};
    for(let i=0;i<spanDays;i++){
      const dt=new Date(startDate.getTime()+i*86400000);
      const k=`${dt.getFullYear()}-${dt.getMonth()}`;
      (groups[k]??=[]).push({date:dt,tasks:tasks[i]||[]});
    }
    Object.values(groups).forEach(list=>{
      const month=list[0].date.toLocaleString(undefined,{month:'long',year:'numeric'});
      const wrap=document.createElement('section'); wrap.className='month'; wrap.innerHTML=`<h3>${month}</h3><div class="cal"></div>`;
      const grid=wrap.querySelector('.cal');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const h=document.createElement('div');h.className='day';h.style.background='#f8fafc';h.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`;grid.appendChild(h);});
      const first=list[0].date, lead=first.getDay(); for(let i=0;i<lead;i++){const e=document.createElement('div');e.className='day';e.style.visibility='hidden';grid.appendChild(e);}
      list.forEach(({date,tasks})=>{
        const e=document.createElement('div'); const isToday=(date.getTime()===today.getTime());
        e.className=`day${date<today?' past':''}${isToday?' today':''}`;
        let html=`<div class="date">${date.getDate()}</div>`;
        tasks.forEach(t=>{html+=`<div class="task">${t.html}</div>`;});
        e.innerHTML=html; grid.appendChild(e);
      });
      cal.appendChild(wrap);
    });
  }

  function buildICS(startDate,spanDays,tasks,minutes,meta){
    function dt(x){const y=x.getUTCFullYear(),m=String(x.getUTCMonth()+1).padStart(2,'0'),d=String(x.getUTCDate()).padStart(2,'0');return `${y}${m}${d}T000000Z`;}
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000);
      const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0));
      const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>t.html.replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`,`DTSTAMP:${dt(new Date())}`,`DTSTART:${dt(startUTC)}`,`DTEND:${dt(endUTC)}`,`SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`,`DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }
})();
</script>
</body>
</html>
