<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{--fg:#111;--muted:#6b7280;--card:#fff;--accent:#0ea5e9;--grid:#e5e7eb}
    body{color:var(--fg);background:#fff}
    .container{max-width:1000px;margin:0 auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}

    /* Header with auth slot aligned */
    header.site-header .container{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    header .brand-nav{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    header .logo{font-weight:800}
    header .site-nav{display:flex;gap:12px;flex-wrap:wrap}
    #auth-slot{display:flex;align-items:center;justify-content:flex-end;min-height:32px}

    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    .toolbar{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .toolbar .group{display:grid;gap:6px}
    .toolbar .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    button{cursor:pointer;border:0;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    button.ghost{background:transparent;border:1px solid var(--grid);color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}

    input,select{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    input[type="text"]{min-width:220px}

    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:120px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:4px}
    .out-of-range{opacity:.35}
    .past{opacity:.55}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.92rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}

    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}

    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:10px 0 0}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    .badge{display:inline-block;border:1px solid var(--grid);border-radius:999px;padding:2px 8px;font-size:.8rem;color:#334155;background:#f8fafc;margin-left:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--grid);border-radius:999px;padding:4px 10px;background:#f8fafc;font-size:.82rem;color:#334155}
    .chip .dot{width:8px;height:8px;border-radius:50%}
    .chip.ok .dot{background:#16a34a}
    .chip.pending .dot{background:#f59e0b}
    .chip.off .dot{background:#94a3b8}

    .sep{height:1px;background:#eef2f7;margin:10px 0}

    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand-nav">
        <h1 class="logo">OlympiadPrep</h1>
        <nav class="site-nav">
          <a href="index.html">Home</a>
          <a href="planning.html">Planning</a>
          <a href="books.html">Books</a>
        </nav>
      </div>
      <!-- Google sign-in UI appears here (auth.js renders it) -->
      <div id="auth-slot"></div>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div class="group">
        <label><b>Minutes per day</b></label>
        <input id="mPerDay" type="number" min="15" step="5" style="width:140px">
      </div>
      <div class="group">
        <label><b>Test date</b></label>
        <input id="testDate" type="date">
      </div>
      <div class="group">
        <label><b>Days off</b></label>
        <div class="row">
          <select id="daysOff" multiple size="3" title="Hold Ctrl/Cmd to select multiple">
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
          </select>
          <span class="hint">Select weekly off-days (optional).</span>
        </div>
      </div>

      <div class="sep" style="flex-basis:100%"></div>

      <!-- Cloud sync controls -->
      <div class="group">
        <label><b>Account sync</b></label>
        <div class="row">
          <button id="saveCloud" title="Save this plan to your account">Save to account</button>
          <button id="loadCloud" class="secondary" title="Load your saved plan from your account">Load from account</button>
          <span id="syncBadge" class="chip off"><span class="dot"></span><span>Not signed in</span></span>
        </div>
        <span class="hint">Sign in (top-right). Saves the current <code>studyPlanInput</code> to your account and loads it across devices.</span>
      </div>

      <div class="sep" style="flex-basis:100%"></div>

      <div class="row">
        <button id="rebuildBtn" class="secondary">Rebuild plan</button>
        <button id="downloadIcs">Download calendar (.ics)</button>
        <button class="secondary" onclick="window.print()">Print</button>
      </div>
      <span class="hint">Reading appears every day (unless off/mock). Book tasks reflect your selections.</span>
    </div>

    <div class="legend">
      <span>üìò Reading (selected books)</span>
      <span>üß† Book exercises (specific problem numbers)</span>
      <span>üìó Proof track (if selected)</span>
      <span>üß© Problem of the day (AMC/AIME/USAMO)</span>
      <span>‚è±Ô∏è Topic-aligned timed set</span>
      <span>üìù Full mock and review</span>
      <span>üåø Off day (optional)</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
/* ============================================================================
   TIMELINE ENGINE + ACCOUNT SYNC
   ----------------------------------------------------------------------------
   - Deterministic RNG (seeded)
   - Always includes reading + exercises (from Edition Packs when present)
   - Uses diagnostic subscores to weight topics and difficulty selection
   - Problem-of-day (last 20 years, goal-appropriate, no repeats)
   - Mock schedule ramps 30 days before test
   - Off-days respected (from planning payload or UI)
   - Month pager, ICS export
   - Account Sync (Save/Load via window.olympAuth)
   ========================================================================== */

(function init(){
  const errBox = document.getElementById('errBox');
  window.addEventListener('error', (e)=>{
    errBox.style.display='block';
    errBox.textContent = 'Runtime error: ' + (e.message||'Unknown');
  });

  // ----------------- Input payload -----------------
  const input = JSON.parse(localStorage.getItem('studyPlanInput')||'null');
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    wireCloudButtons(); // still wire so user can load from account
    return;
  }

  // Bring UI in sync
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = today.toISOString().slice(0,10);
  document.getElementById('testDate').min = todayStr;
  const minutesPerDay = Number(input.minutesPerDay||60);
  document.getElementById('mPerDay').value = minutesPerDay;
  document.getElementById('testDate').value = input.testDate || todayStr;

  // Off-days from payload (array of weekday numbers 0..6) + UI
  const daysOffSel = document.getElementById('daysOff');
  const storedOff = Array.isArray(input.offDays) ? input.offDays : [];
  for(const opt of daysOffSel.options){ if(storedOff.includes(Number(opt.value))) opt.selected = true; }

  const start = new Date(today);
  const end   = new Date(document.getElementById('testDate').value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  const days = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 14;

  planSummary.innerHTML = `Start: <b>${start.toLocaleDateString()}</b> ‚Üí Test: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Window: <b>${days}</b> days ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${minutesPerDay}</b>
    <span class="badge">Books: ${((input.selectedBooks||[]).length||0)}</span>`;

  // Cloud controls must be alive regardless
  wireCloudButtons();

  // ----------------- Deterministic RNG -----------------
  const seedStr = (input.generatedAt||'') + '|' + (input.goal||'');
  let _seed = hash32(seedStr);
  function rand(){ _seed^=_seed<<13; _seed^=_seed>>>17; _seed^=_seed<<5; return ((_seed>>>0)/4294967296); }
  function pick(arr){ return arr[Math.floor(rand()*arr.length)] }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function hash32(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

  // ----------------- Topic weights from diagnostic -----------------
  const subs = input.subscores||{};
  const cats = Object.keys(subs);
  if(!cats.length) cats.push('Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Sequences and Series','Functions');
  const weights = {}; // lower accuracy => higher weight
  cats.forEach(k=>{ const r=(subs[k]?.right||0), t=(subs[k]?.total||1); weights[k]=1 - r/t + 0.05 });

  function pickTopicWeighted(){
    const sum=Object.values(weights).reduce((a,b)=>a+b,0)||cats.length;
    let r=rand()*sum;
    for(const [k,w] of Object.entries(weights)){ r-=w; if(r<=0) return k; }
    return cats[0];
  }

  function targetDifficultyFor(topicKey, dayIndex, totalDays){
    const acc = (subs?.[topicKey]?.right || 0) / Math.max(1, (subs?.[topicKey]?.total || 1));
    const early = dayIndex < Math.floor(totalDays*0.5);
    if (acc < 0.35) return early ? 'easy' : 'mixed';
    if (acc < 0.7)  return early ? 'mixed' : 'hard';
    return early ? 'mixed' : 'hard';
  }

  // ----------------- Goal family + emphasis -----------------
  const onAIME = (input.testId!=='A');
  const onUSAMO = (input.testId==='C');

  const EMPHASIS = (()=>{
    if(onUSAMO) return {'Geometry':1.3,'Number Theory':1.25,'Polynomials and Algebra':1.2,'Combinatorics':1.1,'Probability':0.9,'Functions':1.0,'Sequences and Series':0.95};
    if(onAIME)  return {'Number Theory':1.25,'Polynomials and Algebra':1.2,'Combinatorics':1.15,'Geometry':1.05,'Probability':1.0,'Functions':0.95,'Sequences and Series':0.95};
    return        {'Polynomials and Algebra':1.15,'Number Theory':1.1,'Combinatorics':1.05,'Geometry':1.0,'Probability':1.0,'Functions':0.95,'Sequences and Series':0.95};
  })();

  Object.keys(weights).forEach(k=>{ weights[k] = (weights[k]||1) * (EMPHASIS[k]||1); });

  // ----------------- Edition packs (book chapter/page/problemRange) -----------------
  const BOOK_PACK_PATH = {
    'aops-v1': 'data/editions/aops-vol1.json',
    'aops-v2': 'data/editions/aops-vol2.json',
    'intro-alg': 'data/editions/intro-algebra.json',
    'intro-cp': 'data/editions/intro-counting-prob.json',
    'intro-geo': 'data/editions/intro-geometry.json',
    'intro-nt': 'data/editions/intro-number-theory.json',
    'prealgebra': 'data/editions/prealgebra.json',
    'int-alg': 'data/editions/intermediate-algebra.json',
    'int-cp': 'data/editions/intermediate-counting-prob.json',
    'precalc': 'data/editions/precalculus.json',
    'egmo': 'data/editions/egmo.json',
    'zeitz': 'data/editions/zeitz.json',
    'velleman': 'data/editions/velleman.json',
    'engel': 'data/editions/engel.json',
    '104nt': 'data/editions/104nt.json',
    'path-comb': 'data/editions/path-comb.json',
    'cmms': 'data/editions/cmms.json'
  };

  const selectedBooks = new Set(input.selectedBooks || []);
  const selectedPackIds = Object.keys(BOOK_PACK_PATH).filter(id=>selectedBooks.has(id));

  async function tryFetchPack(id){
    const path = BOOK_PACK_PATH[id];
    if(!path) return null;
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return {...j, __bookId:id};
    }catch(e){ return null; }
  }

  function indexSectionsByTopic(packs){
    const byTopic = {};
    for(const pk of packs){
      const sections = Array.isArray(pk.sections)? pk.sections : [];
      for(const s of sections){
        const topic = s.topic || 'Polynomials and Algebra';
        byTopic[topic] = byTopic[topic] || [];
        byTopic[topic].push({
          bookId: pk.__bookId,
          bookTitle: pk.book || pk.__bookId,
          chapter: s.chapter,
          chapterTitle: s.title || `Chapter ${s.chapter}`,
          pages: s.pages || '',
          editionMeta: s,
          topic
        });
      }
    }
    Object.values(byTopic).forEach(arr=>shuffle(arr));
    return byTopic;
  }

  const sectionProgress = new Map(); // bookId#chapter -> {from,to}
  function parsePages(pagesStr){
    const m = (pagesStr||'').match(/(\d+)\s*[‚Äì-]\s*(\d+)/);
    if(m) return {from:Number(m[1]), to:Number(m[2])};
    const n = Number((pagesStr||'').trim());
    if(Number.isFinite(n)) return {from:n, to:n};
    return null;
  }

  function mppFor(bookId){
    const light = ['aops-v1','prealgebra','intro-alg','intro-cp','intro-geo','intro-nt','cmms'];
    const heavy = ['aops-v2','int-alg','int-cp','precalc','egmo'];
    const proofy= ['velleman','zeitz','engel','104nt','path-comb'];
    if(light.includes(bookId)) return 2.0;
    if(heavy.includes(bookId)) return (onUSAMO?3.0:2.6);
    if(proofy.includes(bookId)) return 3.2;
    return 2.4;
  }

  function sliceReading(section, minutesBudget){
    const pg = parsePages(section.pages);
    if(!pg){ return { label: `${section.bookTitle}, ${section.chapterTitle}`, usedMin: Math.max(8, Math.round(minutesBudget*0.8)) }; }
    const key = `${section.bookId}#${section.chapter}`;
    const cur = sectionProgress.get(key) || {from: pg.from, to: pg.from-1};
    const mpp = mppFor(section.bookId);
    const wantPages = Math.max(2, Math.floor((minutesBudget + 0.25*mpp)/mpp));
    let from = Math.max(cur.to+1, pg.from);
    if(from > pg.to) { return { label: `${section.bookTitle}, ${section.chapterTitle} (review)`, usedMin: Math.max(6, Math.round(minutesBudget*0.6)) }; }
    let to = Math.min(pg.to, from + wantPages - 1);
    const usedMin = Math.round((to - from + 1)*mpp);
    sectionProgress.set(key, {from, to});
    const label = `${section.bookTitle}, ${section.chapterTitle} (pages ${from}‚Äì${to})`;
    return {label, usedMin};
  }

  function pickProblemsByHeuristic(sectionMeta, wantCount, target, usedSet, bookTag){
    const res = [];
    if(!sectionMeta || !Array.isArray(sectionMeta.problemRange)) return res;
    const range = sectionMeta.problemRange;
    if(!range || range.length<2) return res;
    const L = Number(range[0]), R = Number(range[1]);
    if(!(Number.isFinite(L) && Number.isFinite(R) && L<=R)) return res;

    const span = R - L + 1;
    const hardTail = Math.max(0, Number(sectionMeta.hardTail || 0));
    const hardStart = Math.max(L, R - hardTail + 1);

    const easy=[], mid=[], hard=[];
    for(let n=L;n<=R;n++){
      const id = `${bookTag||sectionMeta.bookTag||'BK'}-${sectionMeta.chapter||'?'}-${n}`;
      if(usedSet.has(id)) continue;
      if (hardTail>0 && n>=hardStart) { hard.push(n); continue; }
      const pos = (n - L) / (Math.max(1, span - hardTail));
      if (pos <= 0.34) easy.push(n);
      else if (pos <= 0.67) mid.push(n);
      else hard.push(n);
    }
    function take(pool, k){
      shuffle(pool);
      while(pool.length && res.length<k){
        const n = pool.pop();
        const id = `${bookTag||sectionMeta.bookTag||'BK'}-${sectionMeta.chapter||'?'}-${n}`;
        usedSet.add(id);
        res.push(n);
      }
    }
    const order = (target==='hard')? [hard,mid,easy] : (target==='easy')? [easy,mid,hard] : [mid,easy,hard];
    for(const p of order){ if(res.length>=wantCount) break; take(p, wantCount); }
    return res;
  }

  function makeExercisesFromSection(section, minutesBudget, dayIndex, totalDays, usedSet){
    const topic = section.topic || 'Polynomials and Algebra';
    const target = targetDifficultyFor(topic, dayIndex, totalDays);
    const per = 6; // minutes/problem (denser than before)
    const want = Math.max(2, Math.floor((minutesBudget + 0.25*per)/per));
    const nums = pickProblemsByHeuristic(section.editionMeta, want, target, usedSet, section.bookId.toUpperCase());
    if(!nums.length){
      return {html:`üß† <b>Book exercises</b> (${section.bookTitle}, ${section.chapterTitle})`, mins: minutesBudget, type:'bookex', _topic: topic};
    }
    const text = (nums.length<=6) ? `Problems ${nums.join(', ')}` : `Problems ${Math.min(...nums)}‚Äì${Math.max(...nums)} (selected)`;
    const html = `üß† <b>Book exercises</b> (${section.bookTitle}, ${section.chapterTitle}): ${text}`;
    return {html, mins: minutesBudget, type:'bookex', _topic: topic};
  }

  // ----------------- Problem of the day -----------------
  function amcProbURL(year, level, variant, num){
    const L=(level==='10')?'AMC_10':'AMC_12';
    return `https://artofproblemsolving.com/wiki/index.php/${year}_${L}${variant}_Problems/Problem_${num}`;
  }
  function aimeProbURL(year, variant, num){
    return `https://artofproblemsolving.com/wiki/index.php/${year}_AIME_${variant}_Problems/Problem_${num}`;
  }
  function usamoProbURL(year, num){
    return `https://artofproblemsolving.com/wiki/index.php/${year}_USAMO_Problems/Problem_${num}`;
  }
  function usajmoProbURL(year, num){
    return `https://artofproblemsolving.com/wiki/index.php/${year}_USAJMO_Problems/Problem_${num}`;
  }

  const usedContest = new Set();

  function problemOfDay(goal){
    const todayYear = new Date().getFullYear();
    const years = [];
    for(let y=todayYear-20; y<=todayYear-1; y++) years.push(y);

    let tries = 0;
    while(tries<500){
      tries++;
      const y = pick(years);
      if(goal==='aime'||onAIME){
        const variant = pick(['I','II']);
        const num = 1 + Math.floor(rand()*13); // 1..13
        const id = `AIME-${y}-${variant}-${num}`;
        if(usedContest.has(id)) continue;
        usedContest.add(id);
        return {html:`üß© <a href="${aimeProbURL(y,variant,num)}" target="_blank" rel="noopener">Problem of the day: ${y} AIME ${variant} ‚Ä¢ Problem ${num}</a>`, mins: 10, type:'potd'};
      } else if(goal==='usamo' || goal==='usajmo' || onUSAMO){
        if(goal==='usajmo'){
          const num = 1 + Math.floor(rand()*6);
          const id = `USAJMO-${y}-${num}`; if(usedContest.has(id)) continue;
          usedContest.add(id);
          return {html:`üß© <a href="${usajmoProbURL(y,num)}" target="_blank" rel="noopener">Problem of the day: ${y} USAJMO ‚Ä¢ Problem ${num}</a>`, mins: 12, type:'potd'};
        } else {
          const num = 1 + Math.floor(rand()*6);
          const id = `USAMO-${y}-${num}`; if(usedContest.has(id)) continue;
          usedContest.add(id);
          return {html:`üß© <a href="${usamoProbURL(y,num)}" target="_blank" rel="noopener">Problem of the day: ${y} USAMO ‚Ä¢ Problem ${num}</a>`, mins: 15, type:'potd'};
        }
      } else {
        const level = (input.goal==='amc10')?'10':'12';
        const variant = pick(['A','B']);
        const num = 1 + Math.floor(rand()*20); // 1..20
        const id = `AMC${level}-${y}-${variant}-${num}`;
        if(usedContest.has(id)) continue;
        usedContest.add(id);
        return {html:`üß© <a href="${amcProbURL(y,level,variant,num)}" target="_blank" rel="noopener">Problem of the day: ${y} AMC ${level}${variant} ‚Ä¢ Problem ${num}</a>`, mins: 8, type:'potd'};
      }
    }
    return {html:`üß© Problem of the day: see recent contests on AoPS`, mins:8, type:'potd'};
  }

  // ----------------- Timed sets and Mocks -----------------
  function makeTopicMatchedTimed(topic, minutes){
    return {html:`‚è±Ô∏è ${topic} ‚Äî topic-aligned timed set`, mins: minutes, type:'timed', _topic: topic};
  }

  function aimeSetURL(y,v){ return `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems`; }
  function amcSetURL(level,y,v){ const L=(level==='10')?'AMC_10':'AMC_12'; return `https://artofproblemsolving.com/wiki/index.php/${y}_${L}${v}_Problems`; }
  function jmoSetURL(y){ return `https://artofproblemsolving.com/wiki/index.php/${y}_USAJMO_Problems`; }
  function usamoSetURL(y){ return `https://artofproblemsolving.com/wiki/index.php/${y}_USAMO_Problems`; }

  function makeMock(totalMinutes){
    const todayYear = new Date().getFullYear();
    const years = []; for(let y=todayYear-20;y<=todayYear-1;y++) years.push(y);
    if(onUSAMO){
      if(input.goal==='usajmo'){
        const y = pick(years);
        return {html:`üìù <a href="${jmoSetURL(y)}" target="_blank" rel="noopener">Full mock: ${y} USAJMO</a> ‚Ä¢ Review & update your error log.`, mins: totalMinutes, type:'mock'};
      } else {
        const y = pick(years);
        return {html:`üìù <a href="${usamoSetURL(y)}" target="_blank" rel="noopener">Full mock: ${y} USAMO</a> ‚Ä¢ Review & update your error log.`, mins: totalMinutes, type:'mock'};
      }
    }
    if(onAIME){
      const variant = pick(['I','II']); const y = pick(years);
      return {html:`üìù <a href="${aimeSetURL(y,variant)}" target="_blank" rel="noopener">Full mock: ${y} AIME ${variant} (15 problems)</a> ‚Ä¢ Review thoroughly.`, mins: totalMinutes, type:'mock'};
    }
    const level = (input.goal==='amc10')?'10':'12'; const variant = pick(['A','B']); const y = pick(years);
    return {html:`üìù <a href="${amcSetURL(level,y,variant)}" target="_blank" rel="noopener">Full mock: ${y} AMC ${level}${variant}</a> ‚Ä¢ Review & update your error log.`, mins: totalMinutes, type:'mock'};
  }

  // ----------------- Proof track (if books selected) -----------------
  const PROOF_BOOKS = ['velleman','zeitz','engel','egmo'];
  const hasProof = (input.selectedBooks||[]).some(id=>PROOF_BOOKS.includes(id));
  const proofUnits = [];
  if(hasProof){
    if(selectedBooks.has('velleman')) proofUnits.push({label:'Velleman ‚Äî Direct & Contrapositive Proofs', mins:25});
    if(selectedBooks.has('velleman')) proofUnits.push({label:'Velleman ‚Äî Mathematical Induction', mins:25});
    if(selectedBooks.has('zeitz')) proofUnits.push({label:'Zeitz ‚Äî Invariants & Extremal', mins:25});
    if(selectedBooks.has('engel')) proofUnits.push({label:'Engel ‚Äî Combinatorial Strategies', mins:25});
    if(selectedBooks.has('egmo')) proofUnits.push({label:'EGMO ‚Äî Power of a Point & Homothety', mins:25});
    if(selectedBooks.has('egmo')) proofUnits.push({label:'EGMO ‚Äî Inversion Basics', mins:25});
    shuffle(proofUnits);
  }
  let proofCursor=0;
  function scheduleProof(blockMinutes){
    if(!hasProof || blockMinutes<14) return [];
    const out=[]; let used=0;
    while(used+20<=blockMinutes && proofUnits.length){
      const it = proofUnits[proofCursor++ % proofUnits.length];
      out.push({html:`üìó <b>Proof track</b>: ${it.label}. Write at least one full proof.`, mins: it.mins, type:'proof'});
      used += it.mins;
    }
    if(blockMinutes - used >= 14){
      const it = proofUnits[proofCursor % proofUnits.length];
      out.push({html:`üìó <b>Proof track</b>: ${it.label} (short set).`, mins: blockMinutes-used, type:'proof'});
    }
    return out;
  }

  // ----------------- Build reading catalog from packs -----------------
  ;(async function buildPlan(){
    const packs = [];
    for(const id of selectedPackIds){
      const p = await tryFetchPack(id);
      if(p) packs.push(p);
    }
    const catalogByTopic = indexSectionsByTopic(packs);

    function fallbackSection(topic){
      const pickBookId = selectedPackIds[0] || 'aops-v1';
      return {
        bookId: pickBookId,
        bookTitle: pickBookId,
        chapter: '?',
        chapterTitle: `${topic} ‚Äî Selected Reading`,
        pages: '',
        editionMeta: null,
        topic
      };
    }

    const TH = { readMin: 12, drillMin: 12, timedMin: 8 };
    const totalDays = days;

    const mockStartIdx = Math.max(0, totalDays - 30);
    const mockWeekdays = new Set([2,4,6]); // Tue, Thu, Sat

    const offDaySet = new Set(storedOff.map(Number));

    const usedBookProblems = new Set();

    const seenTopics = new Map();
    function pickNextTopic(){
      let best = 'Polynomials and Algebra', bestScore = -1;
      const allTopics = Object.keys(EMPHASIS);
      for(const t of allTopics){
        const w = (weights[t]||1);
        const n = (seenTopics.get(t)||0);
        const score = w * (1 + 0.15*Math.max(0, 5-n));
        if(score>bestScore){ bestScore=score; best=t; }
      }
      seenTopics.set(best, (seenTopics.get(best)||0)+1);
      return best;
    }

    function baseMixForPhase(ph){
      if(ph==='Foundation') return {read:0.60, drill:0.30, timed:0.10};
      if(ph==='Mixed') return {read:0.48, drill:0.37, timed:0.15};
      return {read:0.40, drill:0.35, timed:0.25};
    }
    function phaseNameForDay(d){
      const f=Math.floor(totalDays*0.55), m=Math.floor(totalDays*0.85);
      return d<f?'Foundation':(d<m?'Mixed':'Final');
    }
    function adjustedMix(base, minutes){
      let r=base.read, d=base.drill, t=base.timed;
      if(minutes<=30){ r+=0.16; d-=0.08; t-=0.08; }
      if(onUSAMO){ r+=0.05; d-=0.03; t-=0.02; }
      const s=r+d+t; r/=s; d/=s; t/=s; return {read:r,drill:d,timed:t};
    }

    const catalogCursor = {};
    function nextSection(topic){
      const arr = catalogByTopic[topic];
      if(arr && arr.length){
        const i = (catalogCursor[topic]||0)%arr.length;
        catalogCursor[topic] = i+1;
        return arr[i];
      }
      return fallbackSection(topic);
    }

    function buildDay(dayIndex, dateObj){
      const weekday = dateObj.getDay();
      if(offDaySet.has(weekday)){
        return [{html:'üåø Off day (rest / review errors lightly)', mins:0, type:'off'}];
      }

      const inMockPhase = (dayIndex >= mockStartIdx);
      const isMockDay = inMockPhase && mockWeekdays.has(weekday);
      if(isMockDay){
        return [ makeMock(minutesPerDay) ];
      }

      const phase = phaseNameForDay(dayIndex);
      const mix = adjustedMix(baseMixForPhase(phase), minutesPerDay);

      let mRead = Math.max(TH.readMin, Math.round(minutesPerDay*mix.read));
      let mDrill= Math.max(TH.drillMin, Math.round(minutesPerDay*mix.drill));
      let mTimed= Math.max(TH.timedMin, Math.round(minutesPerDay*mix.timed));

      let sum = mRead+mDrill+mTimed;
      if(sum>minutesPerDay){
        const over = sum - minutesPerDay;
        const cutT = Math.min(over, Math.max(0, mTimed-TH.timedMin)); mTimed-=cutT;
        const cutD = Math.min(over-cutT, Math.max(0, mDrill-TH.drillMin)); mDrill-=cutD;
        const cutR = Math.max(0, over-cutT-cutD); mRead = Math.max(TH.readMin, mRead-cutR);
      }

      const tasks = [];

      const topic = pickNextTopic();
      const sec = nextSection(topic);
      const slice = sliceReading(sec, mRead);
      tasks.push({html:`üìò <b>${topic}</b>: ${slice.label}`, mins: slice.usedMin, type:'reading', _topic: topic, _sec: sec});

      const ex = makeExercisesFromSection(sec, mDrill, dayIndex, totalDays, usedBookProblems);
      tasks.push(ex);

      if(onUSAMO){
        const proofShare = 0.18;
        const proofBudget = Math.round(minutesPerDay*proofShare);
        scheduleProof(proofBudget).forEach(t=>tasks.push(t));
      }

      tasks.push( makeTopicMatchedTimed(topic, mTimed) );

      tasks.push( problemOfDay(input.goal) );

      balance(tasks, minutesPerDay);
      return tasks;
    }

    function totalMin(ts){ return Math.round(ts.reduce((s,t)=>s+(t.mins||0),0)); }
    function balance(arr, target){
      let cur = totalMin(arr);
      if(Math.abs(cur-target)<=2) return;
      if(cur<target){
        const lastT = arr.slice().reverse().find(t=>t._topic)?.['_topic'] || pickTopicWeighted();
        arr.splice(arr.length-1,0, makeTopicMatchedTimed(lastT, target-cur));
        return;
      }
      let over = cur - target;
      function trimType(type, minKeep){
        for(let i=arr.length-1;i>=0 && over>2;i--){
          const t=arr[i]; if(!t || t.type!==type) continue;
          const newMin = Math.max(minKeep, t.mins - over);
          if(newMin < t.mins){ over -= (t.mins-newMin); t.mins=newMin; }
        }
      }
      trimType('timed', TH.timedMin);
      trimType('drill', TH.drillMin);
      for(let i=arr.length-1;i>=0 && over>2;i--){
        const t=arr[i]; if(!t || t.type!=='bookex') continue;
        const newMin = Math.max(10, t.mins - over); if(newMin < t.mins){ over -= (t.mins-newMin); t.mins=newMin; }
      }
      for(let i=arr.length-1;i>=0 && over>2;i--){
        const t=arr[i]; if(!t || t.type!=='reading') continue;
        const newMin = Math.max(10, t.mins - over); if(newMin < t.mins){ over -= (t.mins-newMin); t.mins=newMin; }
      }
    }

    const tasksByDay = [];
    for(let d=0; d<totalDays; d++){
      const dateObj = new Date(start.getTime()+d*86400000);
      tasksByDay.push( buildDay(d, dateObj) );
    }

    const taskMap = new Map();
    for(let i=0;i<days;i++){
      const d = new Date(start.getTime()+i*86400000);
      const key = d.toISOString().slice(0,10);
      taskMap.set(key, tasksByDay[i]);
    }

    const months = buildMonthList(start, end);
    let monthIdx = 0;
    renderOneMonth(months[monthIdx]);
    document.getElementById('prevMonth').onclick = ()=>{ if(monthIdx>0){monthIdx--;renderOneMonth(months[monthIdx]);}};
    document.getElementById('nextMonth').onclick = ()=>{ if(monthIdx<months.length-1){monthIdx++;renderOneMonth(months[monthIdx]);}};

    function buildMonthList(startDate, endDate){
      const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
      while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
      return out;
    }

    function renderOneMonth({year, month}){
      const cal = document.getElementById('calendar'); cal.innerHTML='';
      const wrap=document.createElement('section'); wrap.className='month';
      const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
      wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

      ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
        const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
        head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
      });

      const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
      for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

      const today = new Date(); today.setHours(0,0,0,0);
      for(let day=1; day<=daysInMonth; day++){
        const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
        const key=dateObj.toISOString().slice(0,10); const tasks=taskMap.get(key)||[];
        const inRange=(dateObj>=start && dateObj<=end);
        const box=document.createElement('div'); let cls='day';
        if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(dateObj.getTime()===today.getTime()) cls+=' today';
        box.className=cls;

        let html=`<div class="date">${day}</div>`;
        if(inRange){
          tasks.forEach(t=>{
            if(!t || !t.html) return;
            html += `<div class="task">${t.html}</div>`;
          });
        }
        box.innerHTML=html; grid.appendChild(box);
      }
      cal.appendChild(wrap);
      const pos = months.findIndex(m=>m.year===year&&m.month===month);
      document.getElementById('monthLabel').innerText = `Month ${pos+1} of ${months.length} ‚Ä¢ ${header}`;
      document.getElementById('prevMonth').disabled=(monthIdx===0);
      document.getElementById('nextMonth').disabled=(monthIdx===months.length-1);
    }

    // ----------------- ICS export -----------------
    document.getElementById('downloadIcs').onclick = ()=>{
      const ics = buildICS(start, days, tasksByDay, Number(input.minutesPerDay), input);
      const blob = new Blob([ics], {type:'text/calendar'}); const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    // ----------------- Rebuild plan -----------------
    document.getElementById('rebuildBtn').onclick = async ()=>{
      const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
      if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
      const offs=[]; for(const opt of daysOffSel.options){ if(opt.selected) offs.push(Number(opt.value)); }
      input.minutesPerDay=m; input.testDate=t; input.offDays = offs;
      input.generatedAt = new Date().toISOString();
      localStorage.setItem('studyPlanInput', JSON.stringify(input));
      // Best-effort: save to cloud if signed-in
      try{ if(window.olympAuth?.getUser?.()){ await window.olympAuth.savePlan(input); markSynced('Saved'); } }catch{}
      location.href = 'timeline.html?v=rebuild';
    };

  })();

  // ----------------- Build ICS -----------------
  function buildICS(startDate, spanDays, tasks, minutes, meta){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()+0).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${(meta.goal||'').toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\r\n');
  }

  // ----------------- Cloud sync buttons wiring -----------------
  function wireCloudButtons(){
    const badge = document.getElementById('syncBadge');
    const saveBtn = document.getElementById('saveCloud');
    const loadBtn = document.getElementById('loadCloud');

    function setBadge(state,text){
      badge.className = `chip ${state}`;
      badge.querySelector('.dot').style.display='inline-block';
      badge.querySelector('span:last-child').textContent = text;
    }
    function setEnabled(loggedIn){
      saveBtn.disabled = !loggedIn;
      loadBtn.disabled = !loggedIn;
    }
    function refreshState(){
      const user = window.olympAuth?.getUser?.();
      if(user){ setEnabled(true); setBadge('ok','Signed in'); }
      else { setEnabled(false); setBadge('off','Not signed in'); }
    }

    refreshState();
    // In case auth.js switches state after load, poll briefly
    let tries=0; const iv = setInterval(()=>{ refreshState(); if(++tries>20) clearInterval(iv); }, 500);

    saveBtn.onclick = async ()=>{
      const user = window.olympAuth?.getUser?.();
      if(!user){ alert('Please sign in (top-right) to save your plan.'); return; }
      try{
        const raw = localStorage.getItem('studyPlanInput');
        const input = raw ? JSON.parse(raw) : null;
        if(!input){ alert('No plan found in this browser. Build a plan first.'); return; }
        input.generatedAt = new Date().toISOString();
        localStorage.setItem('studyPlanInput', JSON.stringify(input));
        await window.olympAuth.savePlan(input);
        markSynced('Saved');
      }catch(e){
        console.warn(e); alert('Could not save to your account. Please try again.');
      }
    };

    loadBtn.onclick = async ()=>{
      const user = window.olympAuth?.getUser?.();
      if(!user){ alert('Please sign in (top-right) to load a saved plan.'); return; }
      try{
        const cloud = await window.olympAuth.loadPlan();
        if(!cloud){ alert('No saved plan found in your account yet.'); return; }
        localStorage.setItem('studyPlanInput', JSON.stringify(cloud));
        markSynced('Loaded');
        location.replace(location.href);
      }catch(e){
        console.warn(e); alert('Could not load from your account. Please try again.');
      }
    };

    function markSynced(label){ setBadge('ok',label); setTimeout(refreshState, 2000); }
    window.markSynced = markSynced; // used in rebuild hook above
  }

})();
</script>

<!--
================================================================================
EDITION PACKS ‚Äî FILES TO PLACE IN YOUR REPO (examples):
- data/editions/aops-vol1.json           (you‚Äôre filling; includes problemRange + hardTail)
- data/editions/aops-vol2.json
- data/editions/intro-algebra.json
- data/editions/intro-counting-prob.json
- data/editions/intro-geometry.json
- data/editions/intro-number-theory.json
- data/editions/prealgebra.json
- data/editions/intermediate-algebra.json
- data/editions/intermediate-counting-prob.json
- data/editions/precalculus.json
- data/editions/egmo.json
- data/editions/zeitz.json
- data/editions/velleman.json
- data/editions/engel.json
- data/editions/104nt.json
- data/editions/path-comb.json
- data/editions/cmms.json

JSON format:
{
  "book": "AoPS Volume 1: The Basics",
  "edition": "latest",
  "defaults": { "difficultyRamp": true, "hardTail": 4 },
  "sections": [
    {
      "chapter": 1,
      "title": "Exponents and Logarithms",
      "pages": "1‚Äì12",
      "topic": "Polynomials and Algebra",
      "problemRange": [1, 16],
      "hardTail": 4
    },
    ...
  ]
}
================================================================================
-->

<!-- Load auth module so the Google button appears in the header and cloud save/load works -->
<script type="module" src="/olympiad/auth.js"></script>
</body>
</html>
