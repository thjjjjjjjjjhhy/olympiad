<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Your Study Timeline - OlympiadPrep</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --card:#fff; --accent:#0ea5e9; --grid:#e2e8f0;
      --read:#0ea5e9; --ex:#ec4899; --proof:#22c55e; --potd:#10b981; --timed:#7c3aed; --mock:#f59e0b;
    }
    body{color:var(--fg)}
    .container{max-width:1100px;margin:0 auto;padding:0 16px}
    header .logo{font-weight:800}
    .card{background:var(--card);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:16px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:.92rem}
    .error{border-left:4px solid #ef4444;background:#fff1f2;color:#991b1b;padding:10px;border-radius:8px;margin:8px 0}
    button{cursor:pointer;border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    button.secondary{background:#e5e7eb;color:#111}
    input{border:1px solid var(--grid);border-radius:10px;padding:8px 10px}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 0}
    .legend span{font-size:.86rem;background:#f8fafc;border:1px solid var(--grid);padding:4px 8px;border-radius:999px}
    .legend .b{display:inline-flex;align-items:center;gap:6px}
    .b i{display:inline-block;width:10px;height:10px;border-radius:3px}
    .b .r{background:var(--read)} .b .e{background:var(--ex)} .b .p{background:var(--proof)}
    .b .d{background:var(--potd)} .b .t{background:var(--timed)} .b .m{background:var(--mock)}

    /* calendar */
    .cal-wrap{display:grid;gap:12px;margin-top:12px}
    .month{border:1px solid var(--grid);border-radius:14px;padding:10px}
    .month h3{margin:4px 6px 8px}
    .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{border:1px solid var(--grid);border-radius:10px;padding:6px;min-height:124px;background:#fff}
    .day .date{font-weight:700;font-size:.9rem;margin-bottom:2px}
    .out-of-range{opacity:.35}
    .past{opacity:.58}
    .today{outline:2px solid var(--accent)}
    .task{font-size:.9rem;margin:4px 0;line-height:1.35}
    .task a{text-decoration:underline}
    .pager{display:flex;gap:10px;justify-content:center;align-items:center;margin:12px 0 24px}
    .pager button:disabled{opacity:.55;cursor:not-allowed}

    /* badges */
    .tag{display:inline-block;border:1px solid var(--grid);border-radius:999px;padding:0 6px;font-size:.72rem;color:#475569;margin-left:4px}
    .task .k{font-weight:700}
    .c{color:#475569}
    .rcol{color:var(--read)} .ecol{color:var(--ex)} .pcol{color:var(--proof)} .dcol{color:var(--potd)}
    .tcol{color:var(--timed)} .mcol{color:var(--mock)}

    @media print{
      .site-header,.toolbar,.pager{display:none!important}
      .month{break-inside:avoid}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid var(--grid)}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">OlympiadPrep</h1>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="planning.html">Planning</a>
        <a href="books.html">Books</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>üóìÔ∏è Your Study Timeline</h2>
    <div id="errBox" style="display:none" class="error"></div>
    <p class="hint" id="planSummary"></p>

    <div class="card toolbar">
      <div>
        <label><b>Minutes per day</b> <input id="mPerDay" type="number" min="15" step="5" style="width:120px"></label>
      </div>
      <div>
        <label><b>Test date</b> <input id="testDate" type="date"></label>
      </div>
      <button id="rebuildBtn" class="secondary">Rebuild plan</button>
      <button id="downloadIcs">Download calendar (.ics)</button>
      <button class="secondary" onclick="window.print()">Print</button>
      <span class="hint">Plan is deterministic for the same inputs. Reading comes only from the books you selected in Planning.</span>
    </div>

    <div class="legend">
      <span class="b"><i class="r"></i>Reading (selected books)</span>
      <span class="b"><i class="e"></i>Book exercises</span>
      <span class="b"><i class="p"></i>Proof-writing (USAMO/USAJMO)</span>
      <span class="b"><i class="d"></i>Problem of the day</span>
      <span class="b"><i class="t"></i>Timed practice</span>
      <span class="b"><i class="m"></i>Full mock</span>
    </div>

    <section id="calendar" class="cal-wrap"></section>
    <div class="pager">
      <button id="prevMonth">‚Üê Previous month</button>
      <span id="monthLabel" class="hint"></span>
      <button id="nextMonth">Next month ‚Üí</button>
    </div>
  </main>

  <footer>¬© 2025 OlympiadPrep.</footer>

<script>
(function init(){
  // --------------------------- Error surface ---------------------------
  const errBox = document.getElementById('errBox');
  function showErr(msg){ errBox.style.display='block'; errBox.textContent = msg; }
  window.addEventListener('error', (e)=> showErr('Runtime error: ' + (e.message||'Unknown')));

  // --------------------------- Load planning payload ---------------------------
  const input = safeParse(localStorage.getItem('studyPlanInput'));
  const planSummary = document.getElementById('planSummary');
  if(!input){
    planSummary.innerHTML='No diagnostic found. Go back to <a href="planning.html">Planning</a>.';
    return;
  }

  // set UI defaults from payload
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = toYYYYMMDD(today);
  const testDateInput = document.getElementById('testDate');
  const minutesInput  = document.getElementById('mPerDay');
  testDateInput.min = todayStr;
  minutesInput.value = input.minutesPerDay;
  testDateInput.value = input.testDate || todayStr;

  const start = new Date(today);
  const end   = new Date(testDateInput.value); end.setHours(0,0,0,0);
  const rawDays = Math.ceil((end - start)/86400000);
  const totalDays = (Number.isFinite(rawDays) && rawDays>0) ? rawDays : 60;

  planSummary.innerHTML = `Start: <b>${start.toLocaleDateString()}</b> ‚Üí Test: <b>${end.toLocaleDateString()}</b> ‚Ä¢ Days: <b>${totalDays}</b> ‚Ä¢ Goal: <b>${(input.goal||'').toUpperCase()}</b> ‚Ä¢ Minutes/day: <b>${input.minutesPerDay}</b>.`;

  // --------------------------- Deterministic RNG ---------------------------
  const SEED = fnv1a(JSON.stringify(input));
  const rand = mulberry32(SEED);

  // --------------------------- Constants & helpers ---------------------------
  const GOAL = (input.goal==='amc10' || input.goal==='amc12') ? (input.goal==='amc10'?'AMC10':'AMC12')
             : (input.goal==='usamo' || input.goal==='usajmo') ? 'USAMO' : 'AIME';
  const onAIMETrack = (GOAL==='AIME' || GOAL==='USAMO');
  const isUSAMOTrack = (GOAL==='USAMO');
  const topicsAll = ['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Functions','Sequences and Series'];

  function toYYYYMMDD(d){ return d.toISOString().slice(0,10); }
  function safeParse(s){ try{ return JSON.parse(s||'null'); }catch{ return null; } }
  function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }
  function pick(arr){ return arr[Math.floor(rand()*arr.length)]; }

  // --------------------------- Book database (hard-coded sections with page & exercise ranges) ---------------------------
  // Notes:
  //  ‚Ä¢ Ranges are approximate and edition-dependent; they are chunked to keep plans robust across printings.
  //  ‚Ä¢ rate = minutes/page heuristic by difficulty.
  //  ‚Ä¢ exFirst/exLast are problem indices within the section‚Äôs exercise set (ranges sized generously).
  const BOOKS = {
    /* =========================
       AoPS CORE VOLUMES
       ========================= */
    'aops-v1': { title:'AoPS Volume 1 (The Basics)', lvl:['AMC'], rate:2.0, sections: [
      {topic:'Polynomials and Algebra', section:'Linear Equations & Word Problems', pStart:25,  pEnd:41,  exFirst:1, exLast:36},
      {topic:'Polynomials and Algebra', section:'Quadratic Equations',              pStart:52,  pEnd:60,  exFirst:1, exLast:40},
      {topic:'Polynomials and Algebra', section:'Inequalities & Absolute Value',    pStart:61,  pEnd:72,  exFirst:1, exLast:38},
      {topic:'Functions',               section:'Functions Basics',                 pStart:187, pEnd:190, exFirst:1, exLast:20},
      {topic:'Sequences and Series',    section:'Sequences and Series',             pStart:211, pEnd:217, exFirst:1, exLast:30},
      {topic:'Number Theory',           section:'Modular Arithmetic',               pStart:42,  pEnd:45,  exFirst:1, exLast:30},
      {topic:'Number Theory',           section:'Primes & Factors',                 pStart:47,  pEnd:48,  exFirst:1, exLast:18},
      {topic:'Combinatorics',           section:'Learning to Count',                pStart:221, pEnd:229, exFirst:1, exLast:40},
      {topic:'Probability',             section:'Counting ‚Üí Probability',           pStart:221, pEnd:229, exFirst:41,exLast:64},
      {topic:'Geometry',                section:'Angles & Area',                     pStart:133, pEnd:138, exFirst:1, exLast:36},
      {topic:'Geometry',                section:'Area of a Triangle',               pStart:109, pEnd:109, exFirst:1, exLast:12},
      {topic:'Geometry',                section:'Three-Dimensional Geometry',       pStart:165, pEnd:169, exFirst:1, exLast:24}
    ]},
    'aops-v2': { title:'AoPS Volume 2 (And Beyond)', lvl:['AIME','USAMO'], rate:2.7, sections: [
      {topic:'Polynomials and Algebra', section:'Polynomials ‚Äî Core Tools',         pStart:52,  pEnd:65,  exFirst:1,  exLast:60},
      {topic:'Polynomials and Algebra', section:'Inequalities & Strategy',          pStart:114, pEnd:126, exFirst:1,  exLast:36},
      {topic:'Functions',               section:'Functional Equations',             pStart:69,  pEnd:73,  exFirst:1,  exLast:24},
      {topic:'Sequences and Series',    section:'Sequences & Recurrences',          pStart:180, pEnd:191, exFirst:1,  exLast:50},
      {topic:'Combinatorics',           section:'Combinatorics & Binomial',         pStart:170, pEnd:176, exFirst:1,  exLast:48},
      {topic:'Probability',             section:'Binomial in Probability',          pStart:175, pEnd:175, exFirst:1,  exLast:18},
      {topic:'Geometry',                section:'Inversion & Homothety',            pStart:241, pEnd:247, exFirst:1,  exLast:30},
      {topic:'Number Theory',           section:'Divisibility & Congruences',       pStart:252, pEnd:262, exFirst:1,  exLast:52},
      {topic:'Number Theory',           section:'Diophantine Equations',            pStart:266, pEnd:274, exFirst:1,  exLast:40},
      {topic:'Combinatorics',           section:'Colorings',                        pStart:280, pEnd:280, exFirst:1,  exLast:16}
    ]},

    /* =========================
       AoPS INTRO SERIES
       ========================= */
    'prealgebra': { title:'AoPS Prealgebra', lvl:['AMC'], rate:2.0, sections: [
      {topic:'Polynomials and Algebra', section:'Arithmetic Properties & Order',    pStart:1,   pEnd:30,  exFirst:1,   exLast:60},
      {topic:'Polynomials and Algebra', section:'Fractions & Exponents',            pStart:31,  pEnd:70,  exFirst:61,  exLast:120},
      {topic:'Polynomials and Algebra', section:'Radicals & Word Problems',         pStart:71,  pEnd:120, exFirst:121, exLast:180}
    ]},
    'intro-alg': { title:'AoPS Introduction to Algebra (2e)', lvl:['AMC'], rate:2.2, sections: [
      {topic:'Polynomials and Algebra', section:'Solving Linear Equations I‚ÄìII',    pStart:77,  pEnd:88,  exFirst:1,  exLast:40},
      {topic:'Polynomials and Algebra', section:'Systems & Mixtures',               pStart:123, pEnd:156, exFirst:1,  exLast:60},
      {topic:'Polynomials and Algebra', section:'Quadratic Equations',              pStart:239, pEnd:280, exFirst:1,  exLast:80},
      {topic:'Functions',               section:'Functions & Graphs',               pStart:453, pEnd:490, exFirst:1,  exLast:50},
      {topic:'Sequences and Series',    section:'Sequences & Series',               pStart:517, pEnd:540, exFirst:1,  exLast:42},
      {topic:'Polynomials and Algebra', section:'Exponents & Logarithms',           pStart:563, pEnd:596, exFirst:1,  exLast:36}
    ]},
    'intro-cp': { title:'AoPS Introduction to Counting & Probability (2e)', lvl:['AMC'], rate:2.2, sections: [
      {topic:'Combinatorics', section:'Addition & Multiplication',                   pStart:1,   pEnd:28,  exFirst:1,  exLast:28},
      {topic:'Combinatorics', section:'Permutations & Combinations',                 pStart:29,  pEnd:64,  exFirst:1,  exLast:36},
      {topic:'Combinatorics', section:'Symmetry & Casework',                         pStart:57,  pEnd:62,  exFirst:1,  exLast:16},
      {topic:'Probability',   section:'Intro Probability',                            pStart:89,  pEnd:120, exFirst:1,  exLast:36},
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion',                          pStart:145, pEnd:170, exFirst:1,  exLast:32}
    ]},
    'intro-geo': { title:'AoPS Introduction to Geometry (2e)', lvl:['AMC'], rate:2.6, sections: [
      {topic:'Geometry', section:'Congruence & Similarity',                           pStart:67,  pEnd:120, exFirst:1,  exLast:60},
      {topic:'Geometry', section:'Polygons & Area',                                   pStart:121, pEnd:200, exFirst:1,  exLast:60},
      {topic:'Geometry', section:'Circles & Tangents',                                pStart:284, pEnd:312, exFirst:1,  exLast:60},
      {topic:'Geometry', section:'Power of a Point & Trigonometry Intro',             pStart:329, pEnd:360, exFirst:1,  exLast:48},
      {topic:'Geometry', section:'Three-Dimensional Geometry & Transformations',      pStart:385, pEnd:420, exFirst:1,  exLast:40}
    ]},
    'intro-nt': { title:'AoPS Introduction to Number Theory', lvl:['AMC'], rate:2.2, sections: [
      {topic:'Number Theory', section:'Divisibility & Primes',                         pStart:1,   pEnd:44,  exFirst:1,  exLast:36},
      {topic:'Number Theory', section:'Congruences',                                   pStart:100, pEnd:140, exFirst:1,  exLast:42},
      {topic:'Number Theory', section:'Diophantine Tools',                             pStart:141, pEnd:180, exFirst:1,  exLast:40}
    ]},

    /* =========================
       AoPS INTERMEDIATE/ADVANCED
       ========================= */
    'int-alg': { title:'AoPS Intermediate Algebra', lvl:['AIME','USAMO'], rate:2.9, sections: [
      {topic:'Polynomials and Algebra', section:'Complex Numbers',                     pStart:1,   pEnd:40,  exFirst:1,  exLast:36},
      {topic:'Polynomials and Algebra', section:'Quadratics, Conics & Inequalities',   pStart:79,  pEnd:160, exFirst:1,  exLast:80},
      {topic:'Polynomials and Algebra', section:'Polynomials & Factor Theorems',       pStart:401, pEnd:480, exFirst:1,  exLast:80},
      {topic:'Sequences and Series',    section:'Sequences & Series',                  pStart:521, pEnd:565, exFirst:1,  exLast:48},
      {topic:'Functions',               section:'Functional Equations',                pStart:585, pEnd:650, exFirst:1,  exLast:48}
    ]},
    'int-cp': { title:'AoPS Intermediate Counting & Probability', lvl:['AIME','USAMO'], rate:2.9, sections: [
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion (PIE)',                     pStart:49,  pEnd:88,  exFirst:1,  exLast:40},
      {topic:'Combinatorics', section:'Recursion & Generating Functions',              pStart:201, pEnd:252, exFirst:1,  exLast:56},
      {topic:'Probability',   section:'Conditional Probability & Bayes',               pStart:289, pEnd:336, exFirst:1,  exLast:44},
      {topic:'Combinatorics', section:'Graph Theory Basics',                           pStart:340, pEnd:360, exFirst:1,  exLast:24}
    ]},
    'precalc': { title:'AoPS Precalculus (2e)', lvl:['AIME','USAMO'], rate:2.8, sections: [
      {topic:'Functions',            section:'Polynomials & Rational Functions',       pStart:1,   pEnd:76,  exFirst:1,  exLast:40},
      {topic:'Functions',            section:'Trigonometric Identities',               pStart:83,  pEnd:140, exFirst:1,  exLast:50},
      {topic:'Functions',            section:'Complex Numbers & Roots of Unity',       pStart:300, pEnd:360, exFirst:1,  exLast:48},
      {topic:'Functions',            section:'Vectors & Matrices',                     pStart:361, pEnd:416, exFirst:1,  exLast:40},
      {topic:'Sequences and Series', section:'Sequences & Telescoping',                pStart:417, pEnd:485, exFirst:1,  exLast:50}
    ]},

    /* =========================
       OTHER COMMON TEXTS
       ========================= */
    'egmo': { title:'EGMO ‚Äî Euclidean Geometry in Mathematical Olympiads', lvl:['AIME','USAMO'], rate:3.0, sections: [
      {topic:'Geometry', section:'Angles & Cyclic Quadrilaterals',                     pStart:1,   pEnd:46,  exFirst:1,  exLast:30},
      {topic:'Geometry', section:'Power of a Point & Homothety',                       pStart:47,  pEnd:100, exFirst:1,  exLast:30},
      {topic:'Geometry', section:'Inversion Basics',                                   pStart:101, pEnd:140, exFirst:1,  exLast:24}
    ]},
    'zeitz': { title:'The Art & Craft of Problem Solving (Zeitz, 3e)', lvl:['AIME','USAMO'], rate:2.7, sections: [
      {topic:'Combinatorics',           section:'Pigeonhole & Extreme Principle',      pStart:59,  pEnd:116, exFirst:1,  exLast:24},
      {topic:'Number Theory',           section:'Number Theory Tools',                 pStart:117, pEnd:159, exFirst:1,  exLast:28},
      {topic:'Polynomials and Algebra', section:'Inequalities & Algebraic Tools',      pStart:161, pEnd:204, exFirst:1,  exLast:24}
    ]},
    'velleman': { title:'How to Prove It (Velleman, 2e)', lvl:['USAMO'], rate:3.0, sections: [
      {topic:'Polynomials and Algebra', section:'Direct & Contrapositive Proofs',      pStart:45,  pEnd:65,  exFirst:1,  exLast:20},
      {topic:'Polynomials and Algebra', section:'Quantifiers & Sets',                  pStart:69,  pEnd:104, exFirst:1,  exLast:30},
      {topic:'Polynomials and Algebra', section:'Mathematical Induction',              pStart:133, pEnd:164, exFirst:1,  exLast:28}
    ]},
    'engel': { title:'Problem-Solving Strategies (Engel)', lvl:['USAMO'], rate:3.0, sections: [
      {topic:'Combinatorics', section:'Invariants & Coloring',                         pStart:1,   pEnd:37,  exFirst:1,  exLast:30},
      {topic:'Combinatorics', section:'Extremal & Pigeonhole',                         pStart:39,  pEnd:83,  exFirst:1,  exLast:40},
      {topic:'Number Theory', section:'NT Problem Strategies',                          pStart:117, pEnd:159, exFirst:1,  exLast:32}
    ]},
    '104nt': { title:'104 Number Theory Problems (Andreescu & Andrica)', lvl:['AIME','USAMO'], rate:2.7, sections: [
      {topic:'Number Theory', section:'Introductory Problems I‚ÄìII',                    pStart:1,   pEnd:74,  exFirst:1,  exLast:52},
      {topic:'Number Theory', section:'Advanced Problems I‚ÄìII',                        pStart:83,  pEnd:130, exFirst:1,  exLast:52}
    ]},
    'path-comb': { title:'A Path to Combinatorics for Undergraduates', lvl:['AIME','USAMO'], rate:2.7, sections: [
      {topic:'Combinatorics', section:'Addition or Multiplication?',                   pStart:1,   pEnd:23,  exFirst:1,  exLast:24},
      {topic:'Combinatorics', section:'Combinations & Binomial',                       pStart:25,  pEnd:67,  exFirst:1,  exLast:40},
      {topic:'Combinatorics', section:'Bijections & Recurrences',                      pStart:69,  pEnd:110, exFirst:1,  exLast:40},
      {topic:'Combinatorics', section:'Inclusion‚ÄìExclusion & GFs',                     pStart:111, pEnd:170, exFirst:1,  exLast:40}
    ]},
    'cmms': { title:'Competition Math for Middle School (Batterson)', lvl:['AMC'], rate:2.1, sections: [
      {topic:'Polynomials and Algebra', section:'Algebra Basics',                       pStart:1,   pEnd:40,  exFirst:1,  exLast:40},
      {topic:'Number Theory',           section:'Divisibility',                         pStart:41,  pEnd:80,  exFirst:1,  exLast:40},
      {topic:'Combinatorics',           section:'Counting Strategies',                  pStart:81,  pEnd:120, exFirst:1,  exLast:40},
      {topic:'Geometry',                section:'Geometry Basics',                      pStart:121, pEnd:170, exFirst:1,  exLast:40}
    ]}
  };
  /* =========================
     TOPIC FREQUENCY PRIORS BY CONTEST
     ========================= */
  const PRIORS = {
    AMC10: {'Polynomials and Algebra':0.30,'Geometry':0.28,'Combinatorics':0.20,'Number Theory':0.14,'Probability':0.06,'Functions':0.01,'Sequences and Series':0.01},
    AMC12: {'Polynomials and Algebra':0.32,'Geometry':0.26,'Combinatorics':0.18,'Number Theory':0.16,'Probability':0.05,'Functions':0.02,'Sequences and Series':0.01},
    AIME:  {'Polynomials and Algebra':0.34,'Number Theory':0.26,'Combinatorics':0.20,'Geometry':0.16,'Sequences and Series':0.03,'Functions':0.01,'Probability':0.00},
    USAMO:{'Polynomials and Algebra':0.28,'Number Theory':0.28,'Geometry':0.28,'Combinatorics':0.16,'Sequences and Series':0.00,'Functions':0.00,'Probability':0.00}
  };

  // --------------------------- POTD generator (no repeats, deterministic) ---------------------------
  const usedPotd = new Set();
  function* potdGen(goal){
    const yearsAMC  = Array.from({length:22},(_,i)=>2003+i);
    const yearsAIME = Array.from({length:26},(_,i)=>1999+i);
    const yearsUSAMO= Array.from({length:26},(_,i)=>1999+i);
    const varAB = ['A','B']; const varII=['I','II'];
    while(true){
      if(goal==='USAMO'){
        const y = yearsUSAMO[Math.floor(rand()*yearsUSAMO.length)];
        const idx = 1 + Math.floor(rand()*6); // 6 problems total
        const url = `https://artofproblemsolving.com/wiki/index.php/${y}_USAMO_Problems/Problem_${idx}`;
        if(usedPotd.has(url)) continue; usedPotd.add(url); yield url;
      }else if(goal==='AIME'){
        const y = yearsAIME[Math.floor(rand()*yearsAIME.length)];
        const v = varII[Math.floor(rand()*varII.length)];
        const n = 1 + Math.floor(rand()*15);
        const url = `https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems/Problem_${n}`;
        if(usedPotd.has(url)) continue; usedPotd.add(url); yield url;
      }else{
        const y = yearsAMC[Math.floor(rand()*yearsAMC.length)];
        const v = varAB[Math.floor(rand()*varAB.length)];
        const lv=(input.goal==='amc10')?'AMC_10':'AMC_12';
        const n = 5 + Math.floor(rand()*21); // prefer mid/late problems
        const url = `https://artofproblemsolving.com/wiki/index.php/${y}_${lv}${v}_Problems/Problem_${n}`;
        if(usedPotd.has(url)) continue; usedPotd.add(url); yield url;
      }
    }
  }
  const POTD = potdGen(GOAL);

  // --------------------------- Selected books & queues ---------------------------
  const selectedSet = new Set(Array.isArray(input.selectedBooks)? input.selectedBooks : []);
  const allowedBooks = chooseAllowedBooks(selectedSet, GOAL);
  if(!allowedBooks.length){
    if(GOAL==='AMC10'||GOAL==='AMC12') allowedBooks.push('aops-v1','intro-alg','intro-cp','intro-geo');
    else if(GOAL==='AIME')             allowedBooks.push('aops-v2','int-alg','int-cp','precalc');
    else                               allowedBooks.push('aops-v2','int-alg','int-cp','precalc','egmo','zeitz','velleman','engel');
  }

  const topicQueues = {};
  allowedBooks.forEach(id=>{
    const bk = BOOKS[id]; if(!bk) return;
    (bk.sections||[]).forEach(sec=>{
      (topicQueues[sec.topic] ||= []).push({...sec, bookId:id, bookTitle:bk.title, rate:bk.rate});
    });
  });
  Object.values(topicQueues).forEach(arr => dShuffle(arr));

  // Track reading/exercise progress per section across days
  const progress = {}; // key ‚Üí {p, ex}
  function keyFor(sec){ return `${sec.bookId}|${sec.section}|${sec.pStart}-${sec.pEnd}`; }

  // --------------------------- Diagnostic ‚Üí topic weights ---------------------------
  const subs = input.subscores || {};
  const basePrior = PRIORS[GOAL] || PRIORS.AMC12;
  const weights = {};
  const topicsAll = ['Polynomials and Algebra','Number Theory','Geometry','Combinatorics','Probability','Functions','Sequences and Series'];
  topicsAll.forEach(t=>{
    const r = (subs[t]?.right||0), tot = (subs[t]?.total||0);
    const weakness = (tot>0) ? (1 - r/Math.max(1,tot)) : 0.55; // slight bias if no data
    weights[t] = 0.45*weakness + 0.55*(basePrior[t]||0);
  });
  normalizeInPlace(weights);

  // --------------------------- Phase & mix ---------------------------
  function phaseNameForDay(dIdx){
    const totalDays = Math.ceil((end - start)/86400000);
    const f=Math.floor(totalDays*0.55), m=Math.floor(totalDays*0.85);
    return dIdx<f ? 'Foundation' : (dIdx<m ? 'Mixed' : 'Final');
  }
  function baseMix(phase){
    if(phase==='Foundation') return {read:0.62, ex:0.30, timed:0.08};
    if(phase==='Mixed')      return {read:0.52, ex:0.33, timed:0.15};
    return                       {read:0.38, ex:0.37, timed:0.25};
  }
  function adjustForWeakness(mix, minutes){
    const avgWeak = Object.values(subs).map(s=>1-(s.right||0)/Math.max(1,(s.total||0))).reduce((a,b)=>a+b,0)/(Object.keys(subs).length||1);
    let bias = 0;
    if(minutes<=30) bias = 0.12 + 0.12*avgWeak;
    else if(minutes<=50) bias = 0.06 + 0.10*avgWeak;
    const r = mix.read + bias, e = Math.max(0, mix.ex - bias*0.5), t = Math.max(0, mix.timed - bias*0.5);
    const s = r+e+t || 1;
    return {read:r/s, ex:e/s, timed:t/s};
  }

  // --------------------------- Slicers ---------------------------
  function minutesPerPage(rate){ return rate; }
  function sliceReading(sec, wantMinutes){
    const mp = minutesPerPage(sec.rate);
    const pages = Math.max(2, Math.floor((wantMinutes + 0.25*mp)/mp));
    const k = keyFor(sec);
    if(!progress[k]) progress[k] = {p:sec.pStart, ex:sec.exFirst||1};
    const from = progress[k].p, to = Math.min(sec.pEnd, from + pages - 1);
    const usedMin = Math.round((to - from + 1)*mp);
    progress[k].p = (to < sec.pEnd) ? (to+1) : sec.pEnd + 1; // +1 means finished
    return {from, to, mins:usedMin};
  }
  function sliceExercises(sec, wantMinutes){
    const per = (sec.rate>=2.8?9.0:7.5);
    const cnt = Math.max(1, Math.floor((wantMinutes + 0.25*per)/per));
    const k = keyFor(sec); if(!progress[k]) progress[k]={p:sec.pStart, ex:sec.exFirst||1};
    const start = progress[k].ex, end = Math.min(sec.exLast||start+cnt-1, start+cnt-1);
    const used = Math.round((end-start+1)*per);
    progress[k].ex = (end < (sec.exLast||end)) ? (end+1) : (end+1);
    return {start, end, mins:used};
  }
  function nextSection(topic){
    const q = (topicQueues[topic]||[]).filter(sec => {
      const k = keyFor(sec); const cur = progress[k]?.p ?? sec.pStart;
      return cur <= sec.pEnd;
    });
    if(q.length) return q[Math.floor(rand()*q.length)];
    // fallback: any not-finished section
    const all = topicsAll.flatMap(tp => (topicQueues[tp]||[]).filter(sec=>{
      const k = keyFor(sec); const cur = progress[k]?.p ?? sec.pStart; return cur <= sec.pEnd;
    }));
    return all.length ? all[Math.floor(rand()*all.length)] : null;
  }
  function pickTopicWeighted(){
    const r = rand(); let acc=0;
    for(const t of topicsAll){ acc += (weights[t]||0); if(r<=acc) return t; }
    return topicsAll[0];
  }

  // --------------------------- Timed & Mocks ---------------------------
  function isMockDay(dayIdx, dateObj){
    const daysLeft = Math.ceil((end - dateObj)/86400000);
    if(daysLeft > 30) return false;
    const dow = dateObj.getDay();
    if(GOAL==='USAMO'){ return (dow===2 || dow===4 || dow===6); }  // Tue Thu Sat
    if(GOAL==='AIME'){  return (dow===2 || dow===4); }             // Tue Thu
    return (dow===2);                                              // Tue
  }
  function makeMock(totalMinutes){
    if(GOAL==='USAMO'){
      const y = 2006 + Math.floor(rand()*18);
      return {html:`<span class="mcol k">üìù Full mock:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${y}_USAMO_Problems" target="_blank" rel="noopener">${y} USAMO (attempt 3 problems)</a>`, mins:totalMinutes, type:'mock'};
    }
    if(GOAL==='AIME'){
      const V=['I','II']; const y=2004+Math.floor(rand()*22); const v=V[Math.floor(rand()*V.length)];
      return {html:`<span class="mcol k">üìù Full mock:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${y}_AIME_${v}_Problems" target="_blank" rel="noopener">${y} AIME ${v}</a>`, mins:totalMinutes, type:'mock'};
    }
    const V=['A','B']; const lv=(input.goal==='amc10')?'10':'12'; const y=2006+Math.floor(rand()*18); const v=V[Math.floor(rand()*V.length)];
    return {html:`<span class="mcol k">üìù Full mock:</span> <a href="https://artofproblemsolving.com/wiki/index.php/${y}_AMC_${lv}${v}_Problems" target="_blank" rel="noopener">${y} AMC ${lv}${v}</a>`, mins:totalMinutes, type:'mock'};
  }

  // --------------------------- Problem of the day ---------------------------
  function problemOfDay(){
    const url = POTD.next().value;
    return {html:`<span class="dcol k">üß© Problem of the day:</span> <a href="${url}" target="_blank" rel="noopener">view problem</a>`, mins:10, type:'potd'};
  }

  // --------------------------- Build the schedule (always learning unless mock) ---------------------------
  const minutesPerDay = Number(input.minutesPerDay||60);
  const tasksByDay = [];

  for(let d=0; d<totalDays; d++){
    const dateObj = new Date(start.getTime()+d*86400000);
    const items = [];

    if(isMockDay(d, dateObj)){
      items.push(makeMock(minutesPerDay));
      tasksByDay.push(items);
      continue;
    }

    const phase = phaseNameForDay(d);
    const mix = adjustForWeakness(baseMix(phase), minutesPerDay);
    let mRead = Math.max(10, Math.round(minutesPerDay*mix.read));
    let mEx   = Math.max(8,  Math.round(minutesPerDay*mix.ex));
    let mTimed= Math.max(0,  minutesPerDay - mRead - mEx - 10); // reserve ~10 for POTD

    // Build two learning blocks minimum
    const learningBlocks = 2;
    for(let b=0; b<learningBlocks; b++){
      const topic = pickTopicWeighted();
      const sec = nextSection(topic);
      if(!sec) break;

      // Reading slice
      const rSlice = sliceReading(sec, Math.max(8, Math.round(mRead/(learningBlocks-b))));
      items.push({html:`<span class="rcol k">üìò ${topic}:</span> ${sec.bookTitle}, ${sec.section} <span class="c">(pages ${rSlice.from}‚Äì${rSlice.to})</span>`, mins:rSlice.mins, type:'reading', _topic:topic});
      mRead = Math.max(0, mRead - rSlice.mins);

      // Paired exercises
      if(mEx>0){
        const exSlice = sliceExercises(sec, Math.max(6, Math.round(mEx/(learningBlocks-b))));
        const rangeText = (exSlice.start===exSlice.end)?`Problem ${exSlice.start}`:`Problems ${exSlice.start}‚Äì${exSlice.end}`;
        items.push({html:`<span class="ecol k">üß† Book exercises:</span> ${sec.bookTitle}, ${sec.section} ‚Äî ${rangeText}`, mins:exSlice.mins, type:'bookex', _topic:topic});
        mEx = Math.max(0, mEx - exSlice.mins);
      }
    }

    // If after two blocks time remains, add a third micro-block to reduce repetition
    if(mRead>=6){
      const topic = pickTopicWeighted();
      const sec = nextSection(topic);
      if(sec){
        const rSlice = sliceReading(sec, Math.min(12, mRead));
        items.push({html:`<span class="rcol k">üìò ${topic}:</span> ${sec.bookTitle}, ${sec.section} <span class="c">(pages ${rSlice.from}‚Äì${rSlice.to})</span>`, mins:rSlice.mins, type:'reading', _topic:topic});
        mRead = Math.max(0, mRead - rSlice.mins);
      }
    }
    if(mEx>=6){
      // exercises paired with last reading topic if possible
      const lastRead = [...items].reverse().find(t=>t.type==='reading');
      if(lastRead){
        const topic = lastRead._topic;
        const sec = nextSection(topic) || nextSection(pickTopicWeighted());
        if(sec){
          const exSlice = sliceExercises(sec, Math.min(14, mEx));
          const rangeText = (exSlice.start===exSlice.end)?`Problem ${exSlice.start}`:`Problems ${exSlice.start}‚Äì${exSlice.end}`;
          items.push({html:`<span class="ecol k">üß† Book exercises:</span> ${sec.bookTitle}, ${sec.section} ‚Äî ${rangeText}`, mins:exSlice.mins, type:'bookex', _topic:topic});
          mEx = Math.max(0, mEx - exSlice.mins);
        }
      }
    }

    // USAMO proof-writing steady drip
    if(isUSAMOTrack){
      const prBooks = ['velleman','zeitz','engel'].filter(id=>selectedSet.has(id));
      if(prBooks.length){
        const pool = [];
        prBooks.forEach(id=>{
          const b = BOOKS[id];
          (b.sections||[]).forEach(s=> pool.push({...s, bookId:id, bookTitle:b.title, rate:b.rate}));
        });
        if(pool.length){
          const pickSec = pool[Math.floor(rand()*pool.length)];
          const pSlice = sliceReading(pickSec, clamp(Math.round(minutesPerDay*0.18), 10, 25));
          items.push({html:`<span class="pcol k">üìó Proof-writing:</span> ${pickSec.bookTitle}, ${pickSec.section} <span class="c">(pages ${pSlice.from}‚Äì${pSlice.to})</span> ‚Äî write at least one full proof`, mins:pSlice.mins, type:'proof'});
        }
      }
    }

    // Timed micro-set (Mixed/Final phases primarily)
    if(mTimed >= 8){
      const url = (GOAL==='AIME'||GOAL==='USAMO')
        ? `https://artofproblemsolving.com/wiki/index.php/AIME_Problems_and_Solutions`
        : `https://artofproblemsolving.com/wiki/index.php/${(input.goal==='amc10')?'AMC_10':'AMC_12'}_Problems_and_Solutions`;
      items.push({html:`<span class="tcol k">‚è±Ô∏è Timed practice:</span> <a href="${url}" target="_blank" rel="noopener">topic-matched mini set</a>`, mins:mTimed, type:'timed'});
    }

    // Always add POTD
    items.push( problemOfDay() );

    tasksByDay.push(items);
  }

  // --------------------------- Calendar rendering ---------------------------
  const taskMap = new Map();
  for(let i=0;i<totalDays;i++){
    const d=new Date(start.getTime()+i*86400000);
    taskMap.set(toYYYYMMDD(d), tasksByDay[i]);
  }

  const months = buildMonthList(start, end);
  let monthIdx = 0;
  renderOneMonth(months[monthIdx]);

  document.getElementById('prevMonth').onclick = ()=>{
    if(monthIdx>0){ monthIdx--; renderOneMonth(months[monthIdx]); }
  };
  document.getElementById('nextMonth').onclick = ()=>{
    if(monthIdx<months.length-1){ monthIdx++; renderOneMonth(months[monthIdx]); }
  };

  document.getElementById('downloadIcs').onclick = ()=>{
    const ics = buildICS(start, totalDays, tasksByDay, Number(input.minutesPerDay||60), input);
    const blob = new Blob([ics], {type:'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='OlympiadPrep-StudyPlan.ics';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  document.getElementById('rebuildBtn').onclick = ()=>{
    const m = Number(document.getElementById('mPerDay').value||0), t = document.getElementById('testDate').value;
    if(m<15 || !t){ alert('Enter minutes per day (15 or more) and a future test date.'); return; }
    input.minutesPerDay=m; input.testDate=t;
    localStorage.setItem('studyPlanInput', JSON.stringify(input));
    location.href = 'timeline.html?v=rebuild';
  };

  // --------------------------- Support functions ---------------------------
  function buildMonthList(startDate, endDate){
    const out=[]; let cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const last = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while(cur<=last){ out.push({year:cur.getFullYear(), month:cur.getMonth()}); cur = new Date(cur.getFullYear(), cur.getMonth()+1, 1); }
    return out;
  }
  function renderOneMonth({year, month}){
    const cal = document.getElementById('calendar'); cal.innerHTML='';
    const wrap=document.createElement('section'); wrap.className='month';
    const header = new Date(year, month, 1).toLocaleString(undefined,{month:'long',year:'numeric'});
    wrap.innerHTML=`<h3>${header}</h3><div class="cal"></div>`; const grid=wrap.querySelector('.cal');

    // weekday header
    ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d=>{
      const head=document.createElement('div'); head.className='day'; head.style.background='#f8fafc';
      head.innerHTML=`<div class="date" style="opacity:.7">${d}</div>`; grid.appendChild(head);
    });

    const firstDay=new Date(year,month,1), daysInMonth=new Date(year,month+1,0).getDate(), lead=firstDay.getDay();
    for(let i=0;i<lead;i++){ const e=document.createElement('div'); e.className='day out-of-range'; grid.appendChild(e); }

    const today = new Date(); today.setHours(0,0,0,0);
    for(let day=1; day<=daysInMonth; day++){
      const dateObj=new Date(year,month,day); dateObj.setHours(0,0,0,0);
      const key=toYYYYMMDD(dateObj); const tasks=taskMap.get(key)||[];
      const inRange=(dateObj>=start && dateObj<=end);
      const box=document.createElement('div'); let cls='day';
      if(!inRange) cls+=' out-of-range'; else if(dateObj<today) cls+=' past'; else if(+dateObj===+today) cls+=' today';
      box.className=cls;

      let html=`<div class="date">${day}</div>`;
      if(inRange){
        tasks.forEach(t=>{
          html += `<div class="task">${t.html || (t.href? `<a href="${t.href}" target="_blank" rel="noopener">${t.text||'Practice'}</a>` : (t.text||''))}</div>`;
        });
      }
      box.innerHTML=html; grid.appendChild(box);
    }
    cal.appendChild(wrap);
    const idx = months.findIndex(m=>m.year===year && m.month===month) + 1;
    document.getElementById('monthLabel').innerText = `Month ${idx} of ${months.length} ‚Ä¢ ${header}`;
    document.getElementById('prevMonth').disabled=(idx===1);
    document.getElementById('nextMonth').disabled=(idx===months.length);
  }

  function buildICS(startDate, spanDays, tasks, minutes, meta){
    function fmtUTC(x){ const y=x.getUTCFullYear(), m=String(x.getUTCMonth()+1).padStart(2,'0'), d=String(x.getUTCDate()).padStart(2,'0'), H=String(x.getUTCHours()).padStart(2,'0'), M=String(x.getUTCMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00Z`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//OlympiadPrep//StudyPlan//EN'];
    for(let i=0;i<spanDays;i++){
      const day=new Date(startDate.getTime()+i*86400000); const items=tasks[i]||[]; if(!items.length) continue;
      const startUTC=new Date(Date.UTC(day.getFullYear(),day.getMonth(),day.getDate(),21,0,0)); const endUTC=new Date(startUTC.getTime()+minutes*60000);
      const desc=items.map(t=>(t.html||'').replace(/<[^>]+>/g,'')).join('\\n');
      lines.push('BEGIN:VEVENT',`UID:olympiadprep-${i}@studyplan`, `DTSTAMP:${fmtUTC(new Date())}`, `DTSTART:${fmtUTC(startUTC)}`, `DTEND:${fmtUTC(endUTC)}`, `SUMMARY:Study ‚Ä¢ ${meta.goal.toUpperCase()}`, `DESCRIPTION:${desc}`,'END:VEVENT');
    }
    lines.push('END:VCALENDAR'); return lines.join('\\r\\n');
  }

  // --------------------------- Utilities ---------------------------
  function dShuffle(arr){
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  function normalizeInPlace(obj){
    const s = Object.values(obj).reduce((a,b)=>a+b,0) || 1; Object.keys(obj).forEach(k=>obj[k]/=s);
  }
  function chooseAllowedBooks(selSet, goal){
    const out=[];
    selSet.forEach(id=>{
      const b=BOOKS[id]; if(!b) return;
      if(goal==='AMC10'||goal==='AMC12'){ if(b.lvl.includes('AMC')) out.push(id); }
      else if(goal==='AIME'){ if(b.lvl.includes('AIME')||b.lvl.includes('USAMO')||b.lvl.includes('AMC')) out.push(id); }
      else { if(b.lvl.includes('USAMO')||b.lvl.includes('AIME')) out.push(id); }
    });
    const priorityOrder = id=>{
      if(goal==='USAMO') return (id==='aops-v2'?0:(id.startsWith('int')?1:(['egmo','zeitz','velleman','engel'].includes(id)?2:3)));
      if(goal==='AIME')  return (id==='aops-v2'?0:(id.startsWith('int')||id==='precalc'?1:2));
      return (id==='aops-v1'?0:(id.startsWith('intro')?1:3));
    };
    out.sort((a,b)=>priorityOrder(a)-priorityOrder(b));
    return out;
  }
  function fnv1a(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h>>>0)*16777619>>>0; } return h>>>0; }
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; }; }

  // close IIFE
})();
</script>

</body>
</html>
